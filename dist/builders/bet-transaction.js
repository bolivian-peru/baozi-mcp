/**
 * Bet Transaction Builder
 *
 * Builds unsigned transactions for placing bets on Baozi markets.
 * Agent builds, user signs. No private keys in agent.
 */
import { Connection, PublicKey, Transaction, TransactionInstruction, SystemProgram, } from '@solana/web3.js';
import { PROGRAM_ID, CONFIG_PDA, SEEDS, RPC_ENDPOINT, solToLamports, } from '../config.js';
// =============================================================================
// INSTRUCTION DISCRIMINATORS
// =============================================================================
// place_bet_sol discriminator: [137, 137, 247, 253, 233, 243, 48, 170]
const PLACE_BET_SOL_DISCRIMINATOR = Buffer.from([137, 137, 247, 253, 233, 243, 48, 170]);
// place_bet_sol_with_affiliate discriminator: [197, 186, 187, 145, 252, 239, 101, 96]
const PLACE_BET_SOL_WITH_AFFILIATE_DISCRIMINATOR = Buffer.from([197, 186, 187, 145, 252, 239, 101, 96]);
// =============================================================================
// PDA DERIVATION
// =============================================================================
/**
 * Derive position PDA from market ID and user
 */
function derivePositionPda(marketId, user) {
    const marketIdBuffer = Buffer.alloc(8);
    marketIdBuffer.writeBigUInt64LE(marketId);
    const [pda] = PublicKey.findProgramAddressSync([SEEDS.POSITION, marketIdBuffer, user.toBuffer()], PROGRAM_ID);
    return pda;
}
/**
 * Derive whitelist PDA from market ID
 */
function deriveWhitelistPda(marketId) {
    const marketIdBuffer = Buffer.alloc(8);
    marketIdBuffer.writeBigUInt64LE(marketId);
    const [pda] = PublicKey.findProgramAddressSync([SEEDS.WHITELIST, marketIdBuffer], PROGRAM_ID);
    return pda;
}
/**
 * Derive referred user PDA
 */
function deriveReferredUserPda(user) {
    const [pda] = PublicKey.findProgramAddressSync([Buffer.from('referred'), user.toBuffer()], PROGRAM_ID);
    return pda;
}
// =============================================================================
// INSTRUCTION BUILDERS
// =============================================================================
/**
 * Create place_bet_sol instruction
 */
function createPlaceBetSolInstruction(params) {
    // Serialize instruction data
    // [discriminator(8)] [outcome(1)] [amount(8)]
    const data = Buffer.alloc(17);
    PLACE_BET_SOL_DISCRIMINATOR.copy(data, 0);
    data.writeUInt8(params.outcome ? 1 : 0, 8);
    data.writeBigUInt64LE(params.amount, 9);
    const keys = [
        { pubkey: params.config, isSigner: false, isWritable: false },
        { pubkey: params.market, isSigner: false, isWritable: true },
        { pubkey: params.position, isSigner: false, isWritable: true },
    ];
    // Add optional whitelist
    if (params.whitelist) {
        keys.push({ pubkey: params.whitelist, isSigner: false, isWritable: false });
    }
    keys.push({ pubkey: params.user, isSigner: true, isWritable: true }, { pubkey: SystemProgram.programId, isSigner: false, isWritable: false });
    return new TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
    });
}
/**
 * Create place_bet_sol_with_affiliate instruction
 */
function createPlaceBetSolWithAffiliateInstruction(params) {
    // Serialize instruction data
    // [discriminator(8)] [outcome(1)] [amount(8)]
    const data = Buffer.alloc(17);
    PLACE_BET_SOL_WITH_AFFILIATE_DISCRIMINATOR.copy(data, 0);
    data.writeUInt8(params.outcome ? 1 : 0, 8);
    data.writeBigUInt64LE(params.amount, 9);
    const keys = [
        { pubkey: params.config, isSigner: false, isWritable: false },
        { pubkey: params.market, isSigner: false, isWritable: true },
        { pubkey: params.position, isSigner: false, isWritable: true },
        { pubkey: params.affiliate, isSigner: false, isWritable: true },
        { pubkey: params.referredUser, isSigner: false, isWritable: true },
    ];
    // Add optional whitelist
    if (params.whitelist) {
        keys.push({ pubkey: params.whitelist, isSigner: false, isWritable: false });
    }
    keys.push({ pubkey: params.user, isSigner: true, isWritable: true }, { pubkey: SystemProgram.programId, isSigner: false, isWritable: false });
    return new TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
    });
}
// =============================================================================
// MAIN BUILDER FUNCTION
// =============================================================================
/**
 * Build an unsigned bet transaction
 *
 * @param params - Transaction parameters
 * @param connection - Optional connection (will create if not provided)
 * @returns Unsigned transaction ready for user signing
 */
export async function buildBetTransaction(params, connection) {
    const conn = connection || new Connection(RPC_ENDPOINT, 'confirmed');
    // Derive PDAs
    const positionPda = derivePositionPda(params.marketId, params.userWallet);
    const whitelistPda = params.whitelistRequired
        ? deriveWhitelistPda(params.marketId)
        : null;
    // Convert amount to lamports
    const amountLamports = solToLamports(params.amountSol);
    // Create instruction
    let instruction;
    if (params.affiliatePda && params.affiliateOwner) {
        const referredUserPda = deriveReferredUserPda(params.userWallet);
        instruction = createPlaceBetSolWithAffiliateInstruction({
            config: CONFIG_PDA,
            market: params.marketPda,
            position: positionPda,
            affiliate: params.affiliatePda,
            referredUser: referredUserPda,
            whitelist: whitelistPda,
            user: params.userWallet,
            outcome: params.outcome === 'yes',
            amount: amountLamports,
        });
    }
    else {
        instruction = createPlaceBetSolInstruction({
            config: CONFIG_PDA,
            market: params.marketPda,
            position: positionPda,
            whitelist: whitelistPda,
            user: params.userWallet,
            outcome: params.outcome === 'yes',
            amount: amountLamports,
        });
    }
    // Build transaction
    const transaction = new Transaction();
    transaction.add(instruction);
    // Get recent blockhash
    const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash('finalized');
    transaction.recentBlockhash = blockhash;
    transaction.feePayer = params.userWallet;
    // Serialize without signatures (returns Buffer)
    const serializedTx = transaction.serialize({
        requireAllSignatures: false,
        verifySignatures: false,
    }).toString('base64');
    return {
        transaction,
        positionPda,
        serializedTx,
    };
}
// =============================================================================
// SIMULATION
// =============================================================================
/**
 * Simulate a bet transaction
 */
export async function simulateBetTransaction(transaction, userWallet, connection) {
    const conn = connection || new Connection(RPC_ENDPOINT, 'confirmed');
    try {
        // Use the legacy simulation API for Transaction objects
        const simulation = await conn.simulateTransaction(transaction);
        if (simulation.value.err) {
            return {
                success: false,
                logs: simulation.value.logs || [],
                unitsConsumed: simulation.value.unitsConsumed,
                error: JSON.stringify(simulation.value.err),
            };
        }
        return {
            success: true,
            logs: simulation.value.logs || [],
            unitsConsumed: simulation.value.unitsConsumed,
        };
    }
    catch (err) {
        return {
            success: false,
            logs: [],
            error: err instanceof Error ? err.message : 'Unknown simulation error',
        };
    }
}
// =============================================================================
// MARKET DATA EXTRACTION
// =============================================================================
/**
 * Extract market_id from market account data
 * V4.7.6 Market struct layout:
 * - discriminator (8 bytes)
 * - market_id (u64, 8 bytes) <-- First field!
 * - question (string: 4 byte len + content)
 * - ...rest of fields
 */
export function extractMarketIdFromData(data) {
    // market_id is at offset 8 (right after discriminator)
    return data.readBigUInt64LE(8);
}
/**
 * Extract access_gate from market data to determine if whitelist is needed
 * This requires parsing through the struct to find access_gate field
 */
export function extractAccessGateFromData(data) {
    // V4.7.6 Market struct layout after market_id:
    // market_id (8) + question (4+len) + closing_time (8) + resolution_time (8) +
    // auto_stop_buffer (8) + yes_pool (8) + no_pool (8) + snapshot_yes_pool (8) +
    // snapshot_no_pool (8) + status (1) + winning_outcome (1+1 option) +
    // currency_type (1) + _reserved_usdc_vault (33) + creator_bond (8) +
    // total_claimed (8) + platform_fee_collected (8) + last_bet_time (8) +
    // bump (1) + layer (1) + resolution_mode (1) + access_gate (1)
    let offset = 8; // Skip discriminator
    // market_id
    offset += 8;
    // question (string: 4 byte len + content)
    const questionLen = data.readUInt32LE(offset);
    offset += 4 + questionLen;
    // closing_time, resolution_time, auto_stop_buffer (3 * 8 = 24)
    offset += 24;
    // yes_pool, no_pool, snapshot_yes_pool, snapshot_no_pool (4 * 8 = 32)
    offset += 32;
    // status (enum, 1 byte)
    offset += 1;
    // winning_outcome (Option<bool>: 1 byte discriminant + 1 byte value if Some)
    const hasWinningOutcome = data.readUInt8(offset);
    offset += 1;
    if (hasWinningOutcome === 1) {
        offset += 1;
    }
    // currency_type (enum, 1 byte)
    offset += 1;
    // _reserved_usdc_vault (33 bytes)
    offset += 33;
    // creator_bond (8)
    offset += 8;
    // total_claimed (8)
    offset += 8;
    // platform_fee_collected (8)
    offset += 8;
    // last_bet_time (8)
    offset += 8;
    // bump (1)
    offset += 1;
    // layer (enum, 1 byte)
    offset += 1;
    // resolution_mode (enum, 1 byte)
    offset += 1;
    // access_gate (enum, 1 byte)
    const accessGate = data.readUInt8(offset);
    return accessGate;
}
// =============================================================================
// HELPER: FETCH MARKET AND BUILD
// =============================================================================
/**
 * Fetch market data and build bet transaction
 * Convenience function that handles market fetching and market_id extraction
 */
export async function fetchAndBuildBetTransaction(params) {
    const conn = params.connection || new Connection(RPC_ENDPOINT, 'confirmed');
    try {
        const marketPubkey = new PublicKey(params.marketPda);
        const userPubkey = new PublicKey(params.userWallet);
        // Fetch market account to get market_id
        const accountInfo = await conn.getAccountInfo(marketPubkey);
        if (!accountInfo) {
            return {
                transaction: null,
                marketId: 0n,
                error: 'Market not found',
            };
        }
        const data = accountInfo.data;
        // Extract market_id (first field after discriminator)
        const marketId = extractMarketIdFromData(data);
        // Check if whitelist is required
        const accessGate = extractAccessGateFromData(data);
        const whitelistRequired = accessGate === 1; // 1 = Whitelist
        // Build affiliate PDAs if provided
        let affiliatePda;
        let affiliateOwner;
        if (params.affiliatePda && params.affiliateOwner) {
            affiliatePda = new PublicKey(params.affiliatePda);
            affiliateOwner = new PublicKey(params.affiliateOwner);
        }
        // Build the transaction
        const result = await buildBetTransaction({
            marketPda: marketPubkey,
            marketId,
            userWallet: userPubkey,
            outcome: params.outcome,
            amountSol: params.amountSol,
            affiliatePda,
            affiliateOwner,
            whitelistRequired,
        }, conn);
        return {
            transaction: result,
            marketId,
        };
    }
    catch (err) {
        return {
            transaction: null,
            marketId: 0n,
            error: err instanceof Error ? err.message : 'Unknown error',
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmV0LXRyYW5zYWN0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2J1aWxkZXJzL2JldC10cmFuc2FjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUNILE9BQU8sRUFDTCxVQUFVLEVBQ1YsU0FBUyxFQUNULFdBQVcsRUFDWCxzQkFBc0IsRUFDdEIsYUFBYSxHQUNkLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUNMLFVBQVUsRUFDVixVQUFVLEVBQ1YsS0FBSyxFQUNMLFlBQVksRUFDWixhQUFhLEdBQ2QsTUFBTSxjQUFjLENBQUM7QUFFdEIsZ0ZBQWdGO0FBQ2hGLDZCQUE2QjtBQUM3QixnRkFBZ0Y7QUFFaEYsdUVBQXVFO0FBQ3ZFLE1BQU0sMkJBQTJCLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBRXpGLHNGQUFzRjtBQUN0RixNQUFNLDBDQUEwQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztBQXVCeEcsZ0ZBQWdGO0FBQ2hGLGlCQUFpQjtBQUNqQixnRkFBZ0Y7QUFFaEY7O0dBRUc7QUFDSCxTQUFTLGlCQUFpQixDQUFDLFFBQWdCLEVBQUUsSUFBZTtJQUMxRCxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMxQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDLHNCQUFzQixDQUM1QyxDQUFD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ICpcbiAqIEJ1aWxkcyB1bnNpZ25lZCB0cmFuc2FjdGlvbnMgZm9yIHBsYWNpbmcgYmV0cyBvbiBCYW96aSBtYXJrZXRzLlxuICogQWdlbnQgYnVpbGRzLCB1c2VyIHNpZ25zLiBObyBwcml2YXRlIGtleXMgaW4gYWdlbnQuXG4gKi9cbmltcG9ydCB7XG4gIENvbm5lY3Rpb24sXG4gIFB1YmxpY0tleSxcbiAgVHJhbnNhY3Rpb24sXG4gIFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24sXG4gIFN5c3RlbVByb2dyYW0sXG59IGZyb20gJ0Bzb2xhbmEvd2ViMy5qcyc7XG5pbXBvcnQge1xuICBQUk9HUkFNX0lELFxuICBDT05GSUdfUERBLFxuICBTRUVEUyxcbiAgUlBDX0VORFBPSU5ULFxuICBzb2xUb0xhbXBvcnRzLFxufSBmcm9tICcuLi9jb25maWcuanMnO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gSU5TVFJVQ1RJT04gRElTQ1JJTUlOQVRPUlNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8vIHBsYWNlX2JldF9zb2wgZGlzY3JpbWluYXRvcjogWzEzNywgMTM3LCAyNDcsIDI1MywgMjMzLCAyNDMsIDQ4LCAxNzBdXG5jb25zdCBQTEFDRV9CRVRfU09MX0RJU0NSSU1JTkFUT1IgPSBCdWZmZXIuZnJvbShbMTM3LCAxMzcsIDI0NywgMjUzLCAyMzMsIDI0MywgNDgsIDE3MF0pO1xuXG4vLyBwbGFjZV9iZXRfc29sX3dpdGhfYWZmaWxpYXRlIGRpc2NyaW1pbmF0b3I6IFsxOTcsIDE4NiwgMTg3LCAxNDUsIDI1MiwgMjM5LCAxMDEsIDk2XVxuY29uc3QgUExBQ0VfQkVUX1NPTF9XSVRIX0FGRklMSUFURV9ESVNDUklNSU5BVE9SID0gQnVmZmVyLmZyb20oWzE5NywgMTg2LCAxODcsIDE0NSwgMjUyLCAyMzksIDEwMSwgOTZdKTtcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFRZUEVTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgaW50ZXJmYWNlIEJ1aWxkQmV0VHJhbnNhY3Rpb25QYXJhbXMge1xuICBtYXJrZXRQZGE6IFB1YmxpY0tleTtcbiAgbWFya2V0SWQ6IGJpZ2ludDtcbiAgdXNlcldhbGxldDogUHVibGljS2V5O1xuICBvdXRjb21lOiAneWVzJyB8ICdubyc7XG4gIGFtb3VudFNvbDogbnVtYmVyO1xuICBhZmZpbGlhdGVQZGE/OiBQdWJsaWNLZXk7XG4gIGFmZmlsaWF0ZU93bmVyPzogUHVibGljS2V5O1xuICB3aGl0ZWxpc3RSZXF1aXJlZD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQnVpbGRCZXRUcmFuc2FjdGlvblJlc3VsdCB7XG4gIHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbjtcbiAgcG9zaXRpb25QZGE6IFB1YmxpY0tleTtcbiAgc2VyaWFsaXplZFR4OiBzdHJpbmc7XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBQREEgREVSSVZBVElPTlxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBEZXJpdmUgcG9zaXRpb24gUERBIGZyb20gbWFya2V0IElEIGFuZCB1c2VyXG4gKi9cbmZ1bmN0aW9uIGRlcml2ZVBvc2l0aW9uUGRhKG1hcmtldElkOiBiaWdpbnQsIHVzZXI6IFB1YmxpY0tleSk6IFB1YmxpY0tleSB7XG4gIGNvbnN0IG1hcmtldElkQnVmZmVyID0gQnVmZmVyLmFsbG9jKDgpO1xuICBtYXJrZXRJZEJ1ZmZlci53cml0ZUJpZ1VJbnQ2NExFKG1hcmtldElkKTtcbiAgY29uc3QgW3BkYV0gPSBQdWJsaWNLZXkuZmluZFByb2dyYW1BZGRyZXNzU3luYyhcbiAgICBbU0VFRFMuUE9TSVRJT04sIG1hcmtldElkQnVmZmVyLCB1c2VyLnRvQnVmZmVyKCldLFxuICAgIFBST0dSQU1fSURcbiAgKTtcbiAgcmV0dXJuIHBkYTtcbn1cblxuLyoqXG4gKiBEZXJpdmUgd2hpdGVsaXN0IFBEQSBmcm9tIG1hcmtldCBJRFxuICovXG5mdW5jdGlvbiBkZXJpdmVXaGl0ZWxpc3RQZGEobWFya2V0SWQ6IGJpZ2ludCk6IFB1YmxpY0tleSB7XG4gIGNvbnN0IG1hcmtldElkQnVmZmVyID0gQnVmZmVyLmFsbG9jKDgpO1xuICBtYXJrZXRJZEJ1ZmZlci53cml0ZUJpZ1VJbnQ2NExFKG1hcmtldElkKTtcbiAgY29uc3QgW3BkYV0gPSBQdWJsaWNLZXkuZmluZFByb2dyYW1BZGRyZXNzU3luYyhcbiAgICBbU0VFRFMuV0hJVEVMSVNULCBtYXJrZXRJZEJ1ZmZlcl0sXG4gICAgUFJPR1JBTV9JRFxuICApO1xuICByZXR1cm4gcGRhO1xufVxuXG4vKipcbiAqIERlcml2ZSByZWZlcnJlZCB1c2VyIFBEQVxuICovXG5mdW5jdGlvbiBkZXJpdmVSZWZlcnJlZFVzZXJQZGEodXNlcjogUHVibGljS2V5KTogUHVibGljS2V5IHtcbiAgY29uc3QgW3BkYV0gPSBQdWJsaWNLZXkuZmluZFByb2dyYW1BZGRyZXNzU3luYyhcbiAgICBbQnVmZmVyLmZyb20oJ3JlZmVycmVkJyksIHVzZXIudG9CdWZmZXIoKV0sXG4gICAgUFJPR1JBTV9JRFxuICApO1xuICByZXR1cm4gcGRhO1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gSU5TVFJVQ1RJT04gQlVJTERFUlNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogQ3JlYXRlIHBsYWNlX2JldF9zb2wgaW5zdHJ1Y3Rpb25cbiAqL1xuZnVuY3Rpb24gY3JlYXRlUGxhY2VCZXRTb2xJbnN0cnVjdGlvbihwYXJhbXM6IHtcbiAgY29uZmlnOiBQdWJsaWNLZXk7XG4gIG1hcmtldDogUHVibGljS2V5O1xuICBwb3NpdGlvbjogUHVibGljS2V5O1xuICB3aGl0ZWxpc3Q6IFB1YmxpY0tleSB8IG51bGw7XG4gIHVzZXI6IFB1YmxpY0tleTtcbiAgb3V0Y29tZTogYm9vbGVhbjtcbiAgYW1vdW50OiBiaWdpbnQ7XG59KTogVHJhbnNhY3Rpb25JbnN0cnVjdGlvbiB7XG4gIC8vIFNlcmlhbGl6ZSBpbnN0cnVjdGlvbiBkYXRhXG4gIC8vIFtkaXNjcmltaW5hdG9yKDgpXSBbb3V0Y29tZSgxKV0gW2Ftb3VudCg4KV1cbiAgY29uc3QgZGF0YSA9IEJ1ZmZlci5hbGxvYygxNyk7XG4gIFBMQUNFX0JFVF9TT0xfRElTQ1JJTUlOQVRPUi5jb3B5KGRhdGEsIDApO1xuICBkYXRhLndyaXRlVUludDgocGFyYW1zLm91dGNvbWUgPyAxIDogMCwgOCk7XG4gIGRhdGEud3JpdGVCaWdVSW50NjRMRShwYXJhbXMuYW1vdW50LCA5KTtcblxuICBjb25zdCBrZXlzID0gW1xuICAgIHsgcHVia2V5OiBwYXJhbXMuY29uZmlnLCBpc1NpZ25lcjogZmFsc2UsIGlzV3JpdGFibGU6IGZhbHNlIH0sXG4gICAgeyBwdWJrZXk6IHBhcmFtcy5tYXJrZXQsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogdHJ1ZSB9LFxuICAgIHsgcHVia2V5OiBwYXJhbXMucG9zaXRpb24sIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogdHJ1ZSB9LFxuICBdO1xuXG4gIC8vIEFkZCBvcHRpb25hbCB3aGl0ZWxpc3RcbiAgaWYgKHBhcmFtcy53aGl0ZWxpc3QpIHtcbiAgICBrZXlzLnB1c2goeyBwdWJrZXk6IHBhcmFtcy53aGl0ZWxpc3QsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogZmFsc2UgfSk7XG4gIH1cblxuICBrZXlzLnB1c2goXG4gICAgeyBwdWJrZXk6IHBhcmFtcy51c2VyLCBpc1NpZ25lcjogdHJ1ZSwgaXNXcml0YWJsZTogdHJ1ZSB9LFxuICAgIHsgcHVia2V5OiBTeXN0ZW1Qcm9ncmFtLnByb2dyYW1JZCwgaXNTaWduZXI6IGZhbHNlLCBpc1dyaXRhYmxlOiBmYWxzZSB9XG4gICk7XG5cbiAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHtcbiAgICBwcm9ncmFtSWQ6IFBST0dSQU1fSUQsXG4gICAga2V5cyxcbiAgICBkYXRhLFxuICB9KTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgcGxhY2VfYmV0X3NvbF93aXRoX2FmZmlsaWF0ZSBpbnN0cnVjdGlvblxuICovXG5mdW5jdGlvbiBjcmVhdGVQbGFjZUJldFNvbFdpdGhBZmZpbGlhdGVJbnN0cnVjdGlvbihwYXJhbXM6IHtcbiAgY29uZmlnOiBQdWJsaWNLZXk7XG4gIG1hcmtldDogUHVibGljS2V5O1xuICBwb3NpdGlvbjogUHVibGljS2V5O1xuICBhZmZpbGlhdGU6IFB1YmxpY0tleTtcbiAgcmVmZXJyZWRVc2VyOiBQdWJsaWNLZXk7XG4gIHdoaXRlbGlzdDogUHVibGljS2V5IHwgbnVsbDtcbiAgdXNlcjogUHVibGljS2V5O1xuICBvdXRjb21lOiBib29sZWFuO1xuICBhbW91bnQ6IGJpZ2ludDtcbn0pOiBUcmFuc2FjdGlvbkluc3RydWN0aW9uIHtcbiAgLy8gU2VyaWFsaXplIGluc3RydWN0aW9uIGRhdGFcbiAgLy8gW2Rpc2NyaW1pbmF0b3IoOCldIFtvdXRjb21lKDEpXSBbYW1vdW50KDgpXVxuICBjb25zdCBkYXRhID0gQnVmZmVyLmFsbG9jKDE3KTtcbiAgUExBQ0VfQkVUX1NPTF9XSVRIX0FGRklMSUFURV9ESVNDUklNSU5BVE9SLmNvcHkoZGF0YSwgMCk7XG4gIGRhdGEud3JpdGVVSW50OChwYXJhbXMub3V0Y29tZSA/IDEgOiAwLCA4KTtcbiAgZGF0YS53cml0ZUJpZ1VJbnQ2NExFKHBhcmFtcy5hbW91bnQsIDkpO1xuXG4gIGNvbnN0IGtleXMgPSBbXG4gICAgeyBwdWJrZXk6IHBhcmFtcy5jb25maWcsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogZmFsc2UgfSxcbiAgICB7IHB1YmtleTogcGFyYW1zLm1hcmtldCwgaXNTaWduZXI6IGZhbHNlLCBpc1dyaXRhYmxlOiB0cnVlIH0sXG4gICAgeyBwdWJrZXk6IHBhcmFtcy5wb3NpdGlvbiwgaXNTaWduZXI6IGZhbHNlLCBpc1dyaXRhYmxlOiB0cnVlIH0sXG4gICAgeyBwdWJrZXk6IHBhcmFtcy5hZmZpbGlhdGUsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogdHJ1ZSB9LFxuICAgIHsgcHVia2V5OiBwYXJhbXMucmVmZXJyZWRVc2VyLCBpc1NpZ25lcjogZmFsc2UsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgXTtcblxuICAvLyBBZGQgb3B0aW9uYWwgd2hpdGVsaXN0XG4gIGlmIChwYXJhbXMud2hpdGVsaXN0KSB7XG4gICAga2V5cy5wdXNoKHsgcHVia2V5OiBwYXJhbXMud2hpdGVsaXN0LCBpc1NpZ25lcjogZmFsc2UsIGlzV3JpdGFibGU6IGZhbHNlIH0pO1xuICB9XG5cbiAga2V5cy5wdXNoKFxuICAgIHsgcHVia2V5OiBwYXJhbXMudXNlciwgaXNTaWduZXI6IHRydWUsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgICB7IHB1YmtleTogU3lzdGVtUHJvZ3JhbS5wcm9ncmFtSWQsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogZmFsc2UgfVxuICApO1xuXG4gIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7XG4gICAgcHJvZ3JhbUlkOiBQUk9HUkFNX0lELFxuICAgIGtleXMsXG4gICAgZGF0YSxcbiAgfSk7XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBNQUlOIEJVSUxERVIgRlVOQ1RJT05cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogQnVpbGQgYW4gdW5zaWduZWQgYmV0IHRyYW5zYWN0aW9uXG4gKlxuICogQHBhcmFtIHBhcmFtcyAtIFRyYW5zYWN0aW9uIHBhcmFtZXRlcnNcbiAqIEBwYXJhbSBjb25uZWN0aW9uIC0gT3B0aW9uYWwgY29ubmVjdGlvbiAod2lsbCBjcmVhdGUgaWYgbm90IHByb3ZpZGVkKVxuICogQHJldHVybnMgVW5zaWduZWQgdHJhbnNhY3Rpb24gcmVhZHkgZm9yIHVzZXIgc2lnbmluZ1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYnVpbGRCZXRUcmFuc2FjdGlvbihcbiAgcGFyYW1zOiBCdWlsZEJldFRyYW5zYWN0aW9uUGFyYW1zLFxuICBjb25uZWN0aW9uPzogQ29ubmVjdGlvblxuKTogUHJvbWlzZTxCdWlsZEJldFRyYW5zYWN0aW9uUmVzdWx0PiB7XG4gIGNvbnN0IGNvbm4gPSBjb25uZWN0aW9uIHx8IG5ldyBDb25uZWN0aW9uKFJQQ19FTkRQT0lOVCwgJ2NvbmZpcm1lZCcpO1xuXG4gIC8vIERlcml2ZSBQREFzXG4gIGNvbnN0IHBvc2l0aW9uUGRhID0gZGVyaXZlUG9zaXRpb25QZGEocGFyYW1zLm1hcmtldElkLCBwYXJhbXMudXNlcldhbGxldCk7XG4gIGNvbnN0IHdoaXRlbGlzdFBkYSA9IHBhcmFtcy53aGl0ZWxpc3RSZXF1aXJlZFxuICAgID8gZGVyaXZlV2hpdGVsaXN0UGRhKHBhcmFtcy5tYXJrZXRJZClcbiAgICA6IG51bGw7XG5cbiAgLy8gQ29udmVydCBhbW91bnQgdG8gbGFtcG9ydHNcbiAgY29uc3QgYW1vdW50TGFtcG9ydHMgPSBzb2xUb0xhbXBvcnRzKHBhcmFtcy5hbW91bnRTb2wpO1xuXG4gIC8vIENyZWF0ZSBpbnN0cnVjdGlvblxuICBsZXQgaW5zdHJ1Y3Rpb246IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb247XG5cbiAgaWYgKHBhcmFtcy5hZmZpbGlhdGVQZGEgJiYgcGFyYW1zLmFmZmlsaWF0ZU93bmVyKSB7XG4gICAgY29uc3QgcmVmZXJyZWRVc2VyUGRhID0gZGVyaXZlUmVmZXJyZWRVc2VyUGRhKHBhcmFtcy51c2VyV2FsbGV0KTtcbiAgICBpbnN0cnVjdGlvbiA9IGNyZWF0ZVBsYWNlQmV0U29sV2l0aEFmZmlsaWF0ZUluc3RydWN0aW9uKHtcbiAgICAgIGNvbmZpZzogQ09ORklHX1BEQSxcbiAgICAgIG1hcmtldDogcGFyYW1zLm1hcmtldFBkYSxcbiAgICAgIHBvc2l0aW9uOiBwb3NpdGlvblBkYSxcbiAgICAgIGFmZmlsaWF0ZTogcGFyYW1zLmFmZmlsaWF0ZVBkYSxcbiAgICAgIHJlZmVycmVkVXNlcjogcmVmZXJyZWRVc2VyUGRhLFxuICAgICAgd2hpdGVsaXN0OiB3aGl0ZWxpc3RQZGEsXG4gICAgICB1c2VyOiBwYXJhbXMudXNlcldhbGxldCxcbiAgICAgIG91dGNvbWU6IHBhcmFtcy5vdXRjb21lID09PSAneWVzJyxcbiAgICAgIGFtb3VudDogYW1vdW50TGFtcG9ydHMsXG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgaW5zdHJ1Y3Rpb24gPSBjcmVhdGVQbGFjZUJldFNvbEluc3RydWN0aW9uKHtcbiAgICAgIGNvbmZpZzogQ09ORklHX1BEQSxcbiAgICAgIG1hcmtldDogcGFyYW1zLm1hcmtldFBkYSxcbiAgICAgIHBvc2l0aW9uOiBwb3NpdGlvblBkYSxcbiAgICAgIHdoaXRlbGlzdDogd2hpdGVsaXN0UGRhLFxuICAgICAgdXNlcjogcGFyYW1zLnVzZXJXYWxsZXQsXG4gICAgICBvdXRjb21lOiBwYXJhbXMub3V0Y29tZSA9PT0gJ3llcycsXG4gICAgICBhbW91bnQ6IGFtb3VudExhbXBvcnRzLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gQnVpbGQgdHJhbnNhY3Rpb25cbiAgY29uc3QgdHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oKTtcbiAgdHJhbnNhY3Rpb24uYWRkKGluc3RydWN0aW9uKTtcblxuICAvLyBHZXQgcmVjZW50IGJsb2NraGFzaFxuICBjb25zdCB7IGJsb2NraGFzaCwgbGFzdFZhbGlkQmxvY2tIZWlnaHQgfSA9IGF3YWl0IGNvbm4uZ2V0TGF0ZXN0QmxvY2toYXNoKCdmaW5hbGl6ZWQnKTtcbiAgdHJhbnNhY3Rpb24ucmVjZW50QmxvY2toYXNoID0gYmxvY2toYXNoO1xuICB0cmFuc2FjdGlvbi5mZWVQYXllciA9IHBhcmFtcy51c2VyV2FsbGV0O1xuXG4gIC8vIFNlcmlhbGl6ZSB3aXRob3V0IHNpZ25hdHVyZXMgKHJldHVybnMgQnVmZmVyKVxuICBjb25zdCBzZXJpYWxpemVkVHggPSB0cmFuc2FjdGlvbi5zZXJpYWxpemUoe1xuICAgIHJlcXVpcmVBbGxTaWduYXR1cmVzOiBmYWxzZSxcbiAgICB2ZXJpZnlTaWduYXR1cmVzOiBmYWxzZSxcbiAgfSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuXG4gIHJldHVybiB7XG4gICAgdHJhbnNhY3Rpb24sXG4gICAgcG9zaXRpb25QZGEsXG4gICAgc2VyaWFsaXplZFR4LFxuICB9O1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gU0lNVUxBVElPTlxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBTaW11bGF0ZSBhIGJldCB0cmFuc2FjdGlvblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2ltdWxhdGVCZXRUcmFuc2FjdGlvbihcbiAgdHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uLFxuICB1c2VyV2FsbGV0OiBQdWJsaWNLZXksXG4gIGNvbm5lY3Rpb24/OiBDb25uZWN0aW9uXG4pOiBQcm9taXNlPHtcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgbG9nczogc3RyaW5nW107XG4gIHVuaXRzQ29uc3VtZWQ/OiBudW1iZXI7XG4gIGVycm9yPzogc3RyaW5nO1xufT4ge1xuICBjb25zdCBjb25uID0gY29ubmVjdGlvbiB8fCBuZXcgQ29ubmVjdGlvbihSUENfRU5EUE9JTlQsICdjb25maXJtZWQnKTtcblxuICB0cnkge1xuICAgIC8vIFVzZSB0aGUgbGVnYWN5IHNpbXVsYXRpb24gQVBJIGZvciBUcmFuc2FjdGlvbiBvYmplY3RzXG4gICAgY29uc3Qgc2ltdWxhdGlvbiA9IGF3YWl0IGNvbm4uc2ltdWxhdGVUcmFuc2FjdGlvbih0cmFuc2FjdGlvbik7XG5cbiAgICBpZiAoc2ltdWxhdGlvbi52YWx1ZS5lcnIpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBsb2dzOiBzaW11bGF0aW9uLnZhbHVlLmxvZ3MgfHwgW10sXG4gICAgICAgIHVuaXRzQ29uc3VtZWQ6IHNpbXVsYXRpb24udmFsdWUudW5pdHNDb25zdW1lZCxcbiAgICAgICAgZXJyb3I6IEpTT04uc3RyaW5naWZ5KHNpbXVsYXRpb24udmFsdWUuZXJyKSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBsb2dzOiBzaW11bGF0aW9uLnZhbHVlLmxvZ3MgfHwgW10sXG4gICAgICB1bml0c0NvbnN1bWVkOiBzaW11bGF0aW9uLnZhbHVlLnVuaXRzQ29uc3VtZWQsXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgbG9nczogW10sXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duIHNpbXVsYXRpb24gZXJyb3InLFxuICAgIH07XG4gIH1cbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIE1BUktFVCBEQVRBIEVYVFJBQ1RJT05cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogRXh0cmFjdCBtYXJrZXRfaWQgZnJvbSBtYXJrZXQgYWNjb3VudCBkYXRhXG4gKiBWNC43LjYgTWFya2V0IHN0cnVjdCBsYXlvdXQ6XG4gKiAtIGRpc2NyaW1pbmF0b3IgKDggYnl0ZXMpXG4gKiAtIG1hcmtldF9pZCAodTY0LCA4IGJ5dGVzKSA8LS0gRmlyc3QgZmllbGQhXG4gKiAtIHF1ZXN0aW9uIChzdHJpbmc6IDQgYnl0ZSBsZW4gKyBjb250ZW50KVxuICogLSAuLi5yZXN0IG9mIGZpZWxkc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdE1hcmtldElkRnJvbURhdGEoZGF0YTogQnVmZmVyKTogYmlnaW50IHtcbiAgLy8gbWFya2V0X2lkIGlzIGF0IG9mZnNldCA4IChyaWdodCBhZnRlciBkaXNjcmltaW5hdG9yKVxuICByZXR1cm4gZGF0YS5yZWFkQmlnVUludDY0TEUoOCk7XG59XG5cbi8qKlxuICogRXh0cmFjdCBhY2Nlc3NfZ2F0ZSBmcm9tIG1hcmtldCBkYXRhIHRvIGRldGVybWluZSBpZiB3aGl0ZWxpc3QgaXMgbmVlZGVkXG4gKiBUaGlzIHJlcXVpcmVzIHBhcnNpbmcgdGhyb3VnaCB0aGUgc3RydWN0IHRvIGZpbmQgYWNjZXNzX2dhdGUgZmllbGRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGV4dHJhY3RBY2Nlc3NHYXRlRnJvbURhdGEoZGF0YTogQnVmZmVyKTogbnVtYmVyIHtcbiAgLy8gVjQuNy42IE1hcmtldCBzdHJ1Y3QgbGF5b3V0IGFmdGVyIG1hcmtldF9pZDpcbiAgLy8gbWFya2V0X2lkICg4KSArIHF1ZXN0aW9uICg0K2xlbikgKyBjbG9zaW5nX3RpbWUgKDgpICsgcmVzb2x1dGlvbl90aW1lICg4KSArXG4gIC8vIGF1dG9fc3RvcF9idWZmZXIgKDgpICsgeWVzX3Bvb2wgKDgpICsgbm9fcG9vbCAoOCkgKyBzbmFwc2hvdF95ZXNfcG9vbCAoOCkgK1xuICAvLyBzbmFwc2hvdF9ub19wb29sICg4KSArIHN0YXR1cyAoMSkgKyB3aW5uaW5nX291dGNvbWUgKDErMSBvcHRpb24pICtcbiAgLy8gY3VycmVuY3lfdHlwZSAoMSkgKyBfcmVzZXJ2ZWRfdXNkY192YXVsdCAoMzMpICsgY3JlYXRvcl9ib25kICg4KSArXG4gIC8vIHRvdGFsX2NsYWltZWQgKDgpICsgcGxhdGZvcm1fZmVlX2NvbGxlY3RlZCAoOCkgKyBsYXN0X2JldF90aW1lICg4KSArXG4gIC8vIGJ1bXAgKDEpICsgbGF5ZXIgKDEpICsgcmVzb2x1dGlvbl9tb2RlICgxKSArIGFjY2Vzc19nYXRlICgxKVxuXG4gIGxldCBvZmZzZXQgPSA4OyAvLyBTa2lwIGRpc2NyaW1pbmF0b3JcblxuICAvLyBtYXJrZXRfaWRcbiAgb2Zmc2V0ICs9IDg7XG5cbiAgLy8gcXVlc3Rpb24gKHN0cmluZzogNCBieXRlIGxlbiArIGNvbnRlbnQpXG4gIGNvbnN0IHF1ZXN0aW9uTGVuID0gZGF0YS5yZWFkVUludDMyTEUob2Zmc2V0KTtcbiAgb2Zmc2V0ICs9IDQgKyBxdWVzdGlvbkxlbjtcblxuICAvLyBjbG9zaW5nX3RpbWUsIHJlc29sdXRpb25fdGltZSwgYXV0b19zdG9wX2J1ZmZlciAoMyAqIDggPSAyNClcbiAgb2Zmc2V0ICs9IDI0O1xuXG4gIC8vIHllc19wb29sLCBub19wb29sLCBzbmFwc2hvdF95ZXNfcG9vbCwgc25hcHNob3Rfbm9fcG9vbCAoNCAqIDggPSAzMilcbiAgb2Zmc2V0ICs9IDMyO1xuXG4gIC8vIHN0YXR1cyAoZW51bSwgMSBieXRlKVxuICBvZmZzZXQgKz0gMTtcblxuICAvLyB3aW5uaW5nX291dGNvbWUgKE9wdGlvbjxib29sPjogMSBieXRlIGRpc2NyaW1pbmFudCArIDEgYnl0ZSB2YWx1ZSBpZiBTb21lKVxuICBjb25zdCBoYXNXaW5uaW5nT3V0Y29tZSA9IGRhdGEucmVhZFVJbnQ4KG9mZnNldCk7XG4gIG9mZnNldCArPSAxO1xuICBpZiAoaGFzV2lubmluZ091dGNvbWUgPT09IDEpIHtcbiAgICBvZmZzZXQgKz0gMTtcbiAgfVxuXG4gIC8vIGN1cnJlbmN5X3R5cGUgKGVudW0sIDEgYnl0ZSlcbiAgb2Zmc2V0ICs9IDE7XG5cbiAgLy8gX3Jlc2VydmVkX3VzZGNfdmF1bHQgKDMzIGJ5dGVzKVxuICBvZmZzZXQgKz0gMzM7XG5cbiAgLy8gY3JlYXRvcl9ib25kICg4KVxuICBvZmZzZXQgKz0gODtcblxuICAvLyB0b3RhbF9jbGFpbWVkICg4KVxuICBvZmZzZXQgKz0gODtcblxuICAvLyBwbGF0Zm9ybV9mZWVfY29sbGVjdGVkICg4KVxuICBvZmZzZXQgKz0gODtcblxuICAvLyBsYXN0X2JldF90aW1lICg4KVxuICBvZmZzZXQgKz0gODtcblxuICAvLyBidW1wICgxKVxuICBvZmZzZXQgKz0gMTtcblxuICAvLyBsYXllciAoZW51bSwgMSBieXRlKVxuICBvZmZzZXQgKz0gMTtcblxuICAvLyByZXNvbHV0aW9uX21vZGUgKGVudW0sIDEgYnl0ZSlcbiAgb2Zmc2V0ICs9IDE7XG5cbiAgLy8gYWNjZXNzX2dhdGUgKGVudW0sIDEgYnl0ZSlcbiAgY29uc3QgYWNjZXNzR2F0ZSA9IGRhdGEucmVhZFVJbnQ4KG9mZnNldCk7XG5cbiAgcmV0dXJuIGFjY2Vzc0dhdGU7XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBIRUxQRVI6IEZFVENIIE1BUktFVCBBTkQgQlVJTERcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogRmV0Y2ggbWFya2V0IGRhdGEgYW5kIGJ1aWxkIGJldCB0cmFuc2FjdGlvblxuICogQ29udmVuaWVuY2UgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIG1hcmtldCBmZXRjaGluZyBhbmQgbWFya2V0X2lkIGV4dHJhY3Rpb25cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoQW5kQnVpbGRCZXRUcmFuc2FjdGlvbihwYXJhbXM6IHtcbiAgbWFya2V0UGRhOiBzdHJpbmc7XG4gIHVzZXJXYWxsZXQ6IHN0cmluZztcbiAgb3V0Y29tZTogJ3llcycgfCAnbm8nO1xuICBhbW91bnRTb2w6IG51bWJlcjtcbiAgYWZmaWxpYXRlUGRhPzogc3RyaW5nO1xuICBhZmZpbGlhdGVPd25lcj86IHN0cmluZztcbiAgY29ubmVjdGlvbj86IENvbm5lY3Rpb247XG59KTogUHJvbWlzZTx7XG4gIHRyYW5zYWN0aW9uOiBCdWlsZEJldFRyYW5zYWN0aW9uUmVzdWx0IHwgbnVsbDtcbiAgbWFya2V0SWQ6IGJpZ2ludDtcbiAgZXJyb3I/OiBzdHJpbmc7XG59PiB7XG4gIGNvbnN0IGNvbm4gPSBwYXJhbXMuY29ubmVjdGlvbiB8fCBuZXcgQ29ubmVjdGlvbihSUENfRU5EUE9JTlQsICdjb25maXJtZWQnKTtcblxuICB0cnkge1xuICAgIGNvbnN0IG1hcmtldFB1YmtleSA9IG5ldyBQdWJsaWNLZXkocGFyYW1zLm1hcmtldFBkYSk7XG4gICAgY29uc3QgdXNlclB1YmtleSA9IG5ldyBQdWJsaWNLZXkocGFyYW1zLnVzZXJXYWxsZXQpO1xuXG4gICAgLy8gRmV0Y2ggbWFya2V0IGFjY291bnQgdG8gZ2V0IG1hcmtldF9pZFxuICAgIGNvbnN0IGFjY291bnRJbmZvID0gYXdhaXQgY29ubi5nZXRBY2NvdW50SW5mbyhtYXJrZXRQdWJrZXkpO1xuICAgIGlmICghYWNjb3VudEluZm8pIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRyYW5zYWN0aW9uOiBudWxsLFxuICAgICAgICBtYXJrZXRJZDogMG4sXG4gICAgICAgIGVycm9yOiAnTWFya2V0IG5vdCBmb3VuZCcsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBhY2NvdW50SW5mby5kYXRhO1xuXG4gICAgLy8gRXh0cmFjdCBtYXJrZXRfaWQgKGZpcnN0IGZpZWxkIGFmdGVyIGRpc2NyaW1pbmF0b3IpXG4gICAgY29uc3QgbWFya2V0SWQgPSBleHRyYWN0TWFya2V0SWRGcm9tRGF0YShkYXRhKTtcblxuICAgIC8vIENoZWNrIGlmIHdoaXRlbGlzdCBpcyByZXF1aXJlZFxuICAgIGNvbnN0IGFjY2Vzc0dhdGUgPSBleHRyYWN0QWNjZXNzR2F0ZUZyb21EYXRhKGRhdGEpO1xuICAgIGNvbnN0IHdoaXRlbGlzdFJlcXVpcmVkID0gYWNjZXNzR2F0ZSA9PT0gMTsgLy8gMSA9IFdoaXRlbGlzdFxuXG4gICAgLy8gQnVpbGQgYWZmaWxpYXRlIFBEQXMgaWYgcHJvdmlkZWRcbiAgICBsZXQgYWZmaWxpYXRlUGRhOiBQdWJsaWNLZXkgfCB1bmRlZmluZWQ7XG4gICAgbGV0IGFmZmlsaWF0ZU93bmVyOiBQdWJsaWNLZXkgfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAocGFyYW1zLmFmZmlsaWF0ZVBkYSAmJiBwYXJhbXMuYWZmaWxpYXRlT3duZXIpIHtcbiAgICAgIGFmZmlsaWF0ZVBkYSA9IG5ldyBQdWJsaWNLZXkocGFyYW1zLmFmZmlsaWF0ZVBkYSk7XG4gICAgICBhZmZpbGlhdGVPd25lciA9IG5ldyBQdWJsaWNLZXkocGFyYW1zLmFmZmlsaWF0ZU93bmVyKTtcbiAgICB9XG5cbiAgICAvLyBCdWlsZCB0aGUgdHJhbnNhY3Rpb25cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBidWlsZEJldFRyYW5zYWN0aW9uKFxuICAgICAge1xuICAgICAgICBtYXJrZXRQZGE6IG1hcmtldFB1YmtleSxcbiAgICAgICAgbWFya2V0SWQsXG4gICAgICAgIHVzZXJXYWxsZXQ6IHVzZXJQdWJrZXksXG4gICAgICAgIG91dGNvbWU6IHBhcmFtcy5vdXRjb21lLFxuICAgICAgICBhbW91bnRTb2w6IHBhcmFtcy5hbW91bnRTb2wsXG4gICAgICAgIGFmZmlsaWF0ZVBkYSxcbiAgICAgICAgYWZmaWxpYXRlT3duZXIsXG4gICAgICAgIHdoaXRlbGlzdFJlcXVpcmVkLFxuICAgICAgfSxcbiAgICAgIGNvbm5cbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRyYW5zYWN0aW9uOiByZXN1bHQsXG4gICAgICBtYXJrZXRJZCxcbiAgICB9O1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHJhbnNhY3Rpb246IG51bGwsXG4gICAgICBtYXJrZXRJZDogMG4sXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9O1xuICB9XG59XG4iXX0=