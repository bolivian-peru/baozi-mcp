/**
 * Creator Profile Transaction Builders
 *
 * Builds unsigned transactions for:
 * - Creating creator profiles
 * - Updating creator profiles
 * - Claiming creator fees
 */
import { Connection, PublicKey, Transaction, TransactionInstruction, SystemProgram, } from '@solana/web3.js';
import { PROGRAM_ID, CONFIG_PDA, SOL_TREASURY_PDA, RPC_ENDPOINT, } from '../config.js';
// =============================================================================
// DISCRIMINATORS
// =============================================================================
const DISCRIMINATORS = {
    create_creator_profile: Buffer.from([139, 244, 127, 145, 95, 172, 140, 154]),
    update_creator_profile: Buffer.from([8, 240, 162, 55, 110, 46, 177, 108]),
    claim_creator_sol: Buffer.from([21, 25, 164, 47, 81, 156, 199, 103]),
};
// =============================================================================
// PDA DERIVATION
// =============================================================================
function deriveCreatorProfilePda(creator) {
    const [pda] = PublicKey.findProgramAddressSync([Buffer.from('creator_profile'), creator.toBuffer()], PROGRAM_ID);
    return pda;
}
// =============================================================================
// CREATOR PROFILE OPERATIONS
// =============================================================================
/**
 * Build create_creator_profile transaction
 * Creates an on-chain creator profile for reputation and fee settings
 */
export async function buildCreateCreatorProfileTransaction(params) {
    const conn = params.connection || new Connection(RPC_ENDPOINT, 'confirmed');
    const creatorPubkey = new PublicKey(params.creatorWallet);
    const creatorProfilePda = deriveCreatorProfilePda(creatorPubkey);
    // Validate display name (max 32 chars)
    const displayNameBytes = Buffer.from(params.displayName, 'utf8');
    if (displayNameBytes.length > 32) {
        throw new Error('Display name must be 32 bytes or less');
    }
    // Validate fee (max 50 bps = 0.5%)
    if (params.creatorFeeBps > 50) {
        throw new Error('Creator fee cannot exceed 50 bps (0.5%)');
    }
    // Instruction data: discriminator + display_name (String) + creator_fee_bps (u16)
    const nameLen = displayNameBytes.length;
    const data = Buffer.alloc(8 + 4 + nameLen + 2);
    DISCRIMINATORS.create_creator_profile.copy(data, 0);
    data.writeUInt32LE(nameLen, 8);
    displayNameBytes.copy(data, 12);
    data.writeUInt16LE(params.creatorFeeBps, 12 + nameLen);
    // IDL Accounts: creator_profile, owner, system_program (NO config!)
    const keys = [
        { pubkey: creatorProfilePda, isSigner: false, isWritable: true },
        { pubkey: creatorPubkey, isSigner: true, isWritable: true },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
    ];
    const instruction = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
    });
    const transaction = new Transaction().add(instruction);
    const { blockhash } = await conn.getLatestBlockhash('finalized');
    transaction.recentBlockhash = blockhash;
    transaction.feePayer = creatorPubkey;
    return {
        transaction,
        serializedTx: transaction.serialize({ requireAllSignatures: false, verifySignatures: false }).toString('base64'),
        creatorProfilePda: creatorProfilePda.toBase58(),
    };
}
/**
 * Build update_creator_profile transaction
 * Updates display name and/or fee settings
 * IDL Accounts: creator_profile, owner (NO config!)
 */
export async function buildUpdateCreatorProfileTransaction(params) {
    const conn = params.connection || new Connection(RPC_ENDPOINT, 'confirmed');
    const creatorPubkey = new PublicKey(params.creatorWallet);
    const creatorProfilePda = deriveCreatorProfilePda(creatorPubkey);
    // Build optional fields
    const displayNameBytes = params.newDisplayName
        ? Buffer.from(params.newDisplayName, 'utf8')
        : null;
    if (displayNameBytes && displayNameBytes.length > 32) {
        throw new Error('Display name must be 32 bytes or less');
    }
    if (params.newCreatorFeeBps !== undefined && params.newCreatorFeeBps > 50) {
        throw new Error('Creator fee cannot exceed 50 bps (0.5%)');
    }
    // Instruction data: discriminator + Option<String> + Option<u16>
    // Option<T> in Borsh: 1 byte (0=None, 1=Some) + T if Some
    let dataSize = 8;
    // display_name option
    dataSize += 1 + (displayNameBytes ? 4 + displayNameBytes.length : 0);
    // creator_fee_bps option
    dataSize += 1 + (params.newCreatorFeeBps !== undefined ? 2 : 0);
    const data = Buffer.alloc(dataSize);
    let offset = 0;
    DISCRIMINATORS.update_creator_profile.copy(data, offset);
    offset += 8;
    // Option<String> for display_name
    if (displayNameBytes) {
        data.writeUInt8(1, offset); // Some
        offset += 1;
        data.writeUInt32LE(displayNameBytes.length, offset);
        offset += 4;
        displayNameBytes.copy(data, offset);
        offset += displayNameBytes.length;
    }
    else {
        data.writeUInt8(0, offset); // None
        offset += 1;
    }
    // Option<u16> for creator_fee_bps
    if (params.newCreatorFeeBps !== undefined) {
        data.writeUInt8(1, offset); // Some
        offset += 1;
        data.writeUInt16LE(params.newCreatorFeeBps, offset);
    }
    else {
        data.writeUInt8(0, offset); // None
    }
    // IDL Accounts: creator_profile, owner (NO config!)
    const keys = [
        { pubkey: creatorProfilePda, isSigner: false, isWritable: true },
        { pubkey: creatorPubkey, isSigner: true, isWritable: false },
    ];
    const instruction = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
    });
    const transaction = new Transaction().add(instruction);
    const { blockhash } = await conn.getLatestBlockhash('finalized');
    transaction.recentBlockhash = blockhash;
    transaction.feePayer = creatorPubkey;
    return {
        transaction,
        serializedTx: transaction.serialize({ requireAllSignatures: false, verifySignatures: false }).toString('base64'),
    };
}
/**
 * Build claim_creator_sol transaction
 * Claims accumulated creator fees from sol_treasury
 * IDL Accounts: config, creator_profile, sol_treasury, owner, system_program
 */
export async function buildClaimCreatorTransaction(params) {
    const conn = params.connection || new Connection(RPC_ENDPOINT, 'confirmed');
    const creatorPubkey = new PublicKey(params.creatorWallet);
    const creatorProfilePda = deriveCreatorProfilePda(creatorPubkey);
    const data = DISCRIMINATORS.claim_creator_sol;
    // IDL Accounts: config, creator_profile, sol_treasury, owner, system_program
    const keys = [
        { pubkey: CONFIG_PDA, isSigner: false, isWritable: false },
        { pubkey: creatorProfilePda, isSigner: false, isWritable: true },
        { pubkey: SOL_TREASURY_PDA, isSigner: false, isWritable: true },
        { pubkey: creatorPubkey, isSigner: true, isWritable: true },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
    ];
    const instruction = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
    });
    const transaction = new Transaction().add(instruction);
    const { blockhash } = await conn.getLatestBlockhash('finalized');
    transaction.recentBlockhash = blockhash;
    transaction.feePayer = creatorPubkey;
    return {
        transaction,
        serializedTx: transaction.serialize({ requireAllSignatures: false, verifySignatures: false }).toString('base64'),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRvci10cmFuc2FjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWlsZGVycy9jcmVhdG9yLXRyYW5zYWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0dBT0c7QUFDSCxPQUFPLEVBQ0wsVUFBVSxFQUNWLFNBQVMsRUFDVCxXQUFXLEVBQ1gsc0JBQXNCLEVBQ3RCLGFBQWEsR0FDZCxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFDTCxVQUFVLEVBQ1YsVUFBVSxFQUNWLGdCQUFnQixFQUNoQixZQUFZLEdBRWIsTUFBTSxjQUFjLENBQUM7QUFFdEIsZ0ZBQWdGO0FBQ2hGLGlCQUFpQjtBQUNqQixnRkFBZ0Y7QUFFaEYsTUFBTSxjQUFjLEdBQUc7SUFDckIsc0JBQXNCLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM1RSxzQkFBc0IsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3pFLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7Q0FDckUsQ0FBQztBQUVGLGdGQUFnRjtBQUNoRixpQkFBaUI7QUFDakIsZ0ZBQWdGO0FBRWhGLFNBQVMsdUJBQXVCLENBQUMsT0FBa0I7SUFDakQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxzQkFBc0IsQ0FDNUMsQ0FBQyxNQUFN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b0IsRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO0tBQ2pILENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdG9yIFByb2ZpbGUgVHJhbnNhY3Rpb24gQnVpbGRlcnNcbiAqXG4gKiBCdWlsZHMgdW5zaWduZWQgdHJhbnNhY3Rpb25zIGZvcjpcbiAqIC0gQ3JlYXRpbmcgY3JlYXRvciBwcm9maWxlc1xuICogLSBVcGRhdGluZyBjcmVhdG9yIHByb2ZpbGVzXG4gKiAtIENsYWltaW5nIGNyZWF0b3IgZmVlc1xuICovXG5pbXBvcnQge1xuICBDb25uZWN0aW9uLFxuICBQdWJsaWNLZXksXG4gIFRyYW5zYWN0aW9uLFxuICBUcmFuc2FjdGlvbkluc3RydWN0aW9uLFxuICBTeXN0ZW1Qcm9ncmFtLFxufSBmcm9tICdAc29sYW5hL3dlYjMuanMnO1xuaW1wb3J0IHtcbiAgUFJPR1JBTV9JRCxcbiAgQ09ORklHX1BEQSxcbiAgU09MX1RSRUFTVVJZX1BEQSxcbiAgUlBDX0VORFBPSU5ULFxuICBTRUVEUyxcbn0gZnJvbSAnLi4vY29uZmlnLmpzJztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIERJU0NSSU1JTkFUT1JTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5jb25zdCBESVNDUklNSU5BVE9SUyA9IHtcbiAgY3JlYXRlX2NyZWF0b3JfcHJvZmlsZTogQnVmZmVyLmZyb20oWzEzOSwgMjQ0LCAxMjcsIDE0NSwgOTUsIDE3MiwgMTQwLCAxNTRdKSxcbiAgdXBkYXRlX2NyZWF0b3JfcHJvZmlsZTogQnVmZmVyLmZyb20oWzgsIDI0MCwgMTYyLCA1NSwgMTEwLCA0NiwgMTc3LCAxMDhdKSxcbiAgY2xhaW1fY3JlYXRvcl9zb2w6IEJ1ZmZlci5mcm9tKFsyMSwgMjUsIDE2NCwgNDcsIDgxLCAxNTYsIDE5OSwgMTAzXSksXG59O1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gUERBIERFUklWQVRJT05cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmZ1bmN0aW9uIGRlcml2ZUNyZWF0b3JQcm9maWxlUGRhKGNyZWF0b3I6IFB1YmxpY0tleSk6IFB1YmxpY0tleSB7XG4gIGNvbnN0IFtwZGFdID0gUHVibGljS2V5LmZpbmRQcm9ncmFtQWRkcmVzc1N5bmMoXG4gICAgW0J1ZmZlci5mcm9tKCdjcmVhdG9yX3Byb2ZpbGUnKSwgY3JlYXRvci50b0J1ZmZlcigpXSxcbiAgICBQUk9HUkFNX0lEXG4gICk7XG4gIHJldHVybiBwZGE7XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBDUkVBVE9SIFBST0ZJTEUgT1BFUkFUSU9OU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBCdWlsZCBjcmVhdGVfY3JlYXRvcl9wcm9maWxlIHRyYW5zYWN0aW9uXG4gKiBDcmVhdGVzIGFuIG9uLWNoYWluIGNyZWF0b3IgcHJvZmlsZSBmb3IgcmVwdXRhdGlvbiBhbmQgZmVlIHNldHRpbmdzXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZENyZWF0ZUNyZWF0b3JQcm9maWxlVHJhbnNhY3Rpb24ocGFyYW1zOiB7XG4gIGRpc3BsYXlOYW1lOiBzdHJpbmc7XG4gIGNyZWF0b3JGZWVCcHM6IG51bWJlcjsgLy8gQmFzaXMgcG9pbnRzIChlLmcuLCA1MCA9IDAuNSUpXG4gIGNyZWF0b3JXYWxsZXQ6IHN0cmluZztcbiAgY29ubmVjdGlvbj86IENvbm5lY3Rpb247XG59KTogUHJvbWlzZTx7IHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbjsgc2VyaWFsaXplZFR4OiBzdHJpbmc7IGNyZWF0b3JQcm9maWxlUGRhOiBzdHJpbmcgfT4ge1xuICBjb25zdCBjb25uID0gcGFyYW1zLmNvbm5lY3Rpb24gfHwgbmV3IENvbm5lY3Rpb24oUlBDX0VORFBPSU5ULCAnY29uZmlybWVkJyk7XG4gIGNvbnN0IGNyZWF0b3JQdWJrZXkgPSBuZXcgUHVibGljS2V5KHBhcmFtcy5jcmVhdG9yV2FsbGV0KTtcbiAgY29uc3QgY3JlYXRvclByb2ZpbGVQZGEgPSBkZXJpdmVDcmVhdG9yUHJvZmlsZVBkYShjcmVhdG9yUHVia2V5KTtcblxuICAvLyBWYWxpZGF0ZSBkaXNwbGF5IG5hbWUgKG1heCAzMiBjaGFycylcbiAgY29uc3QgZGlzcGxheU5hbWVCeXRlcyA9IEJ1ZmZlci5mcm9tKHBhcmFtcy5kaXNwbGF5TmFtZSwgJ3V0ZjgnKTtcbiAgaWYgKGRpc3BsYXlOYW1lQnl0ZXMubGVuZ3RoID4gMzIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Rpc3BsYXkgbmFtZSBtdXN0IGJlIDMyIGJ5dGVzIG9yIGxlc3MnKTtcbiAgfVxuXG4gIC8vIFZhbGlkYXRlIGZlZSAobWF4IDUwIGJwcyA9IDAuNSUpXG4gIGlmIChwYXJhbXMuY3JlYXRvckZlZUJwcyA+IDUwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDcmVhdG9yIGZlZSBjYW5ub3QgZXhjZWVkIDUwIGJwcyAoMC41JSknKTtcbiAgfVxuXG4gIC8vIEluc3RydWN0aW9uIGRhdGE6IGRpc2NyaW1pbmF0b3IgKyBkaXNwbGF5X25hbWUgKFN0cmluZykgKyBjcmVhdG9yX2ZlZV9icHMgKHUxNilcbiAgY29uc3QgbmFtZUxlbiA9IGRpc3BsYXlOYW1lQnl0ZXMubGVuZ3RoO1xuICBjb25zdCBkYXRhID0gQnVmZmVyLmFsbG9jKDggKyA0ICsgbmFtZUxlbiArIDIpO1xuICBESVNDUklNSU5BVE9SUy5jcmVhdGVfY3JlYXRvcl9wcm9maWxlLmNvcHkoZGF0YSwgMCk7XG4gIGRhdGEud3JpdGVVSW50MzJMRShuYW1lTGVuLCA4KTtcbiAgZGlzcGxheU5hbWVCeXRlcy5jb3B5KGRhdGEsIDEyKTtcbiAgZGF0YS53cml0ZVVJbnQxNkxFKHBhcmFtcy5jcmVhdG9yRmVlQnBzLCAxMiArIG5hbWVMZW4pO1xuXG4gIC8vIElETCBBY2NvdW50czogY3JlYXRvcl9wcm9maWxlLCBvd25lciwgc3lzdGVtX3Byb2dyYW0gKE5PIGNvbmZpZyEpXG4gIGNvbnN0IGtleXMgPSBbXG4gICAgeyBwdWJrZXk6IGNyZWF0b3JQcm9maWxlUGRhLCBpc1NpZ25lcjogZmFsc2UsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgICB7IHB1YmtleTogY3JlYXRvclB1YmtleSwgaXNTaWduZXI6IHRydWUsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgICB7IHB1YmtleTogU3lzdGVtUHJvZ3JhbS5wcm9ncmFtSWQsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogZmFsc2UgfSxcbiAgXTtcblxuICBjb25zdCBpbnN0cnVjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHtcbiAgICBwcm9ncmFtSWQ6IFBST0dSQU1fSUQsXG4gICAga2V5cyxcbiAgICBkYXRhLFxuICB9KTtcblxuICBjb25zdCB0cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbigpLmFkZChpbnN0cnVjdGlvbik7XG4gIGNvbnN0IHsgYmxvY2toYXNoIH0gPSBhd2FpdCBjb25uLmdldExhdGVzdEJsb2NraGFzaCgnZmluYWxpemVkJyk7XG4gIHRyYW5zYWN0aW9uLnJlY2VudEJsb2NraGFzaCA9IGJsb2NraGFzaDtcbiAgdHJhbnNhY3Rpb24uZmVlUGF5ZXIgPSBjcmVhdG9yUHVia2V5O1xuXG4gIHJldHVybiB7XG4gICAgdHJhbnNhY3Rpb24sXG4gICAgc2VyaWFsaXplZFR4OiB0cmFuc2FjdGlvbi5zZXJpYWxpemUoeyByZXF1aXJlQWxsU2lnbmF0dXJlczogZmFsc2UsIHZlcmlmeVNpZ25hdHVyZXM6IGZhbHNlIH0pLnRvU3RyaW5nKCdiYXNlNjQnKSxcbiAgICBjcmVhdG9yUHJvZmlsZVBkYTogY3JlYXRvclByb2ZpbGVQZGEudG9CYXNlNTgoKSxcbiAgfTtcbn1cblxuLyoqXG4gKiBCdWlsZCB1cGRhdGVfY3JlYXRvcl9wcm9maWxlIHRyYW5zYWN0aW9uXG4gKiBVcGRhdGVzIGRpc3BsYXkgbmFtZSBhbmQvb3IgZmVlIHNldHRpbmdzXG4gKiBJREwgQWNjb3VudHM6IGNyZWF0b3JfcHJvZmlsZSwgb3duZXIgKE5PIGNvbmZpZyEpXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZFVwZGF0ZUNyZWF0b3JQcm9maWxlVHJhbnNhY3Rpb24ocGFyYW1zOiB7XG4gIG5ld0Rpc3BsYXlOYW1lPzogc3RyaW5nO1xuICBuZXdDcmVhdG9yRmVlQnBzPzogbnVtYmVyO1xuICBjcmVhdG9yV2FsbGV0OiBzdHJpbmc7XG4gIGNvbm5lY3Rpb24/OiBDb25uZWN0aW9uO1xufSk6IFByb21pc2U8eyB0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb247IHNlcmlhbGl6ZWRUeDogc3RyaW5nIH0+IHtcbiAgY29uc3QgY29ubiA9IHBhcmFtcy5jb25uZWN0aW9uIHx8IG5ldyBDb25uZWN0aW9uKFJQQ19FTkRQT0lOVCwgJ2NvbmZpcm1lZCcpO1xuICBjb25zdCBjcmVhdG9yUHVia2V5ID0gbmV3IFB1YmxpY0tleShwYXJhbXMuY3JlYXRvcldhbGxldCk7XG4gIGNvbnN0IGNyZWF0b3JQcm9maWxlUGRhID0gZGVyaXZlQ3JlYXRvclByb2ZpbGVQZGEoY3JlYXRvclB1YmtleSk7XG5cbiAgLy8gQnVpbGQgb3B0aW9uYWwgZmllbGRzXG4gIGNvbnN0IGRpc3BsYXlOYW1lQnl0ZXMgPSBwYXJhbXMubmV3RGlzcGxheU5hbWVcbiAgICA/IEJ1ZmZlci5mcm9tKHBhcmFtcy5uZXdEaXNwbGF5TmFtZSwgJ3V0ZjgnKVxuICAgIDogbnVsbDtcblxuICBpZiAoZGlzcGxheU5hbWVCeXRlcyAmJiBkaXNwbGF5TmFtZUJ5dGVzLmxlbmd0aCA+IDMyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdEaXNwbGF5IG5hbWUgbXVzdCBiZSAzMiBieXRlcyBvciBsZXNzJyk7XG4gIH1cblxuICBpZiAocGFyYW1zLm5ld0NyZWF0b3JGZWVCcHMgIT09IHVuZGVmaW5lZCAmJiBwYXJhbXMubmV3Q3JlYXRvckZlZUJwcyA+IDUwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDcmVhdG9yIGZlZSBjYW5ub3QgZXhjZWVkIDUwIGJwcyAoMC41JSknKTtcbiAgfVxuXG4gIC8vIEluc3RydWN0aW9uIGRhdGE6IGRpc2NyaW1pbmF0b3IgKyBPcHRpb248U3RyaW5nPiArIE9wdGlvbjx1MTY+XG4gIC8vIE9wdGlvbjxUPiBpbiBCb3JzaDogMSBieXRlICgwPU5vbmUsIDE9U29tZSkgKyBUIGlmIFNvbWVcbiAgbGV0IGRhdGFTaXplID0gODtcbiAgLy8gZGlzcGxheV9uYW1lIG9wdGlvblxuICBkYXRhU2l6ZSArPSAxICsgKGRpc3BsYXlOYW1lQnl0ZXMgPyA0ICsgZGlzcGxheU5hbWVCeXRlcy5sZW5ndGggOiAwKTtcbiAgLy8gY3JlYXRvcl9mZWVfYnBzIG9wdGlvblxuICBkYXRhU2l6ZSArPSAxICsgKHBhcmFtcy5uZXdDcmVhdG9yRmVlQnBzICE9PSB1bmRlZmluZWQgPyAyIDogMCk7XG5cbiAgY29uc3QgZGF0YSA9IEJ1ZmZlci5hbGxvYyhkYXRhU2l6ZSk7XG4gIGxldCBvZmZzZXQgPSAwO1xuICBESVNDUklNSU5BVE9SUy51cGRhdGVfY3JlYXRvcl9wcm9maWxlLmNvcHkoZGF0YSwgb2Zmc2V0KTtcbiAgb2Zmc2V0ICs9IDg7XG5cbiAgLy8gT3B0aW9uPFN0cmluZz4gZm9yIGRpc3BsYXlfbmFtZVxuICBpZiAoZGlzcGxheU5hbWVCeXRlcykge1xuICAgIGRhdGEud3JpdGVVSW50OCgxLCBvZmZzZXQpOyAvLyBTb21lXG4gICAgb2Zmc2V0ICs9IDE7XG4gICAgZGF0YS53cml0ZVVJbnQzMkxFKGRpc3BsYXlOYW1lQnl0ZXMubGVuZ3RoLCBvZmZzZXQpO1xuICAgIG9mZnNldCArPSA0O1xuICAgIGRpc3BsYXlOYW1lQnl0ZXMuY29weShkYXRhLCBvZmZzZXQpO1xuICAgIG9mZnNldCArPSBkaXNwbGF5TmFtZUJ5dGVzLmxlbmd0aDtcbiAgfSBlbHNlIHtcbiAgICBkYXRhLndyaXRlVUludDgoMCwgb2Zmc2V0KTsgLy8gTm9uZVxuICAgIG9mZnNldCArPSAxO1xuICB9XG5cbiAgLy8gT3B0aW9uPHUxNj4gZm9yIGNyZWF0b3JfZmVlX2Jwc1xuICBpZiAocGFyYW1zLm5ld0NyZWF0b3JGZWVCcHMgIT09IHVuZGVmaW5lZCkge1xuICAgIGRhdGEud3JpdGVVSW50OCgxLCBvZmZzZXQpOyAvLyBTb21lXG4gICAgb2Zmc2V0ICs9IDE7XG4gICAgZGF0YS53cml0ZVVJbnQxNkxFKHBhcmFtcy5uZXdDcmVhdG9yRmVlQnBzLCBvZmZzZXQpO1xuICB9IGVsc2Uge1xuICAgIGRhdGEud3JpdGVVSW50OCgwLCBvZmZzZXQpOyAvLyBOb25lXG4gIH1cblxuICAvLyBJREwgQWNjb3VudHM6IGNyZWF0b3JfcHJvZmlsZSwgb3duZXIgKE5PIGNvbmZpZyEpXG4gIGNvbnN0IGtleXMgPSBbXG4gICAgeyBwdWJrZXk6IGNyZWF0b3JQcm9maWxlUGRhLCBpc1NpZ25lcjogZmFsc2UsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgICB7IHB1YmtleTogY3JlYXRvclB1YmtleSwgaXNTaWduZXI6IHRydWUsIGlzV3JpdGFibGU6IGZhbHNlIH0sXG4gIF07XG5cbiAgY29uc3QgaW5zdHJ1Y3Rpb24gPSBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7XG4gICAgcHJvZ3JhbUlkOiBQUk9HUkFNX0lELFxuICAgIGtleXMsXG4gICAgZGF0YSxcbiAgfSk7XG5cbiAgY29uc3QgdHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oKS5hZGQoaW5zdHJ1Y3Rpb24pO1xuICBjb25zdCB7IGJsb2NraGFzaCB9ID0gYXdhaXQgY29ubi5nZXRMYXRlc3RCbG9ja2hhc2goJ2ZpbmFsaXplZCcpO1xuICB0cmFuc2FjdGlvbi5yZWNlbnRCbG9ja2hhc2ggPSBibG9ja2hhc2g7XG4gIHRyYW5zYWN0aW9uLmZlZVBheWVyID0gY3JlYXRvclB1YmtleTtcblxuICByZXR1cm4ge1xuICAgIHRyYW5zYWN0aW9uLFxuICAgIHNlcmlhbGl6ZWRUeDogdHJhbnNhY3Rpb24uc2VyaWFsaXplKHsgcmVxdWlyZUFsbFNpZ25hdHVyZXM6IGZhbHNlLCB2ZXJpZnlTaWduYXR1cmVzOiBmYWxzZSB9KS50b1N0cmluZygnYmFzZTY0JyksXG4gIH07XG59XG5cbi8qKlxuICogQnVpbGQgY2xhaW1fY3JlYXRvcl9zb2wgdHJhbnNhY3Rpb25cbiAqIENsYWltcyBhY2N1bXVsYXRlZCBjcmVhdG9yIGZlZXMgZnJvbSBzb2xfdHJlYXN1cnlcbiAqIElETCBBY2NvdW50czogY29uZmlnLCBjcmVhdG9yX3Byb2ZpbGUsIHNvbF90cmVhc3VyeSwgb3duZXIsIHN5c3RlbV9wcm9ncmFtXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZENsYWltQ3JlYXRvclRyYW5zYWN0aW9uKHBhcmFtczoge1xuICBjcmVhdG9yV2FsbGV0OiBzdHJpbmc7XG4gIGNvbm5lY3Rpb24/OiBDb25uZWN0aW9uO1xufSk6IFByb21pc2U8eyB0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb247IHNlcmlhbGl6ZWRUeDogc3RyaW5nIH0+IHtcbiAgY29uc3QgY29ubiA9IHBhcmFtcy5jb25uZWN0aW9uIHx8IG5ldyBDb25uZWN0aW9uKFJQQ19FTkRQT0lOVCwgJ2NvbmZpcm1lZCcpO1xuICBjb25zdCBjcmVhdG9yUHVia2V5ID0gbmV3IFB1YmxpY0tleShwYXJhbXMuY3JlYXRvcldhbGxldCk7XG4gIGNvbnN0IGNyZWF0b3JQcm9maWxlUGRhID0gZGVyaXZlQ3JlYXRvclByb2ZpbGVQZGEoY3JlYXRvclB1YmtleSk7XG5cbiAgY29uc3QgZGF0YSA9IERJU0NSSU1JTkFUT1JTLmNsYWltX2NyZWF0b3Jfc29sO1xuXG4gIC8vIElETCBBY2NvdW50czogY29uZmlnLCBjcmVhdG9yX3Byb2ZpbGUsIHNvbF90cmVhc3VyeSwgb3duZXIsIHN5c3RlbV9wcm9ncmFtXG4gIGNvbnN0IGtleXMgPSBbXG4gICAgeyBwdWJrZXk6IENPTkZJR19QREEsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogZmFsc2UgfSxcbiAgICB7IHB1YmtleTogY3JlYXRvclByb2ZpbGVQZGEsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogdHJ1ZSB9LFxuICAgIHsgcHVia2V5OiBTT0xfVFJFQVNVUllfUERBLCBpc1NpZ25lcjogZmFsc2UsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgICB7IHB1YmtleTogY3JlYXRvclB1YmtleSwgaXNTaWduZXI6IHRydWUsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgICB7IHB1YmtleTogU3lzdGVtUHJvZ3JhbS5wcm9ncmFtSWQsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogZmFsc2UgfSxcbiAgXTtcblxuICBjb25zdCBpbnN0cnVjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHtcbiAgICBwcm9ncmFtSWQ6IFBST0dSQU1fSUQsXG4gICAga2V5cyxcbiAgICBkYXRhLFxuICB9KTtcblxuICBjb25zdCB0cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbigpLmFkZChpbnN0cnVjdGlvbik7XG4gIGNvbnN0IHsgYmxvY2toYXNoIH0gPSBhd2FpdCBjb25uLmdldExhdGVzdEJsb2NraGFzaCgnZmluYWxpemVkJyk7XG4gIHRyYW5zYWN0aW9uLnJlY2VudEJsb2NraGFzaCA9IGJsb2NraGFzaDtcbiAgdHJhbnNhY3Rpb24uZmVlUGF5ZXIgPSBjcmVhdG9yUHVia2V5O1xuXG4gIHJldHVybiB7XG4gICAgdHJhbnNhY3Rpb24sXG4gICAgc2VyaWFsaXplZFR4OiB0cmFuc2FjdGlvbi5zZXJpYWxpemUoeyByZXF1aXJlQWxsU2lnbmF0dXJlczogZmFsc2UsIHZlcmlmeVNpZ25hdHVyZXM6IGZhbHNlIH0pLnRvU3RyaW5nKCdiYXNlNjQnKSxcbiAgfTtcbn1cbiJdfQ==