/**
 * Creator Profile Transaction Builders
 *
 * Builds unsigned transactions for:
 * - Creating creator profiles
 * - Updating creator profiles
 * - Claiming creator fees
 */
import { Connection, PublicKey, Transaction, TransactionInstruction, SystemProgram, } from '@solana/web3.js';
import { PROGRAM_ID, CONFIG_PDA, SOL_TREASURY_PDA, RPC_ENDPOINT, } from '../config.js';
// =============================================================================
// DISCRIMINATORS
// =============================================================================
const DISCRIMINATORS = {
    create_creator_profile: Buffer.from([139, 244, 127, 145, 95, 172, 140, 154]),
    update_creator_profile: Buffer.from([8, 240, 162, 55, 110, 46, 177, 108]),
    claim_creator_sol: Buffer.from([21, 25, 164, 47, 81, 156, 199, 103]),
};
// =============================================================================
// PDA DERIVATION
// =============================================================================
function deriveCreatorProfilePda(creator) {
    const [pda] = PublicKey.findProgramAddressSync([Buffer.from('creator_profile'), creator.toBuffer()], PROGRAM_ID);
    return pda;
}
// =============================================================================
// CREATOR PROFILE OPERATIONS
// =============================================================================
/**
 * Build create_creator_profile transaction
 * Creates an on-chain creator profile for reputation and fee settings
 */
export async function buildCreateCreatorProfileTransaction(params) {
    const conn = params.connection || new Connection(RPC_ENDPOINT, 'confirmed');
    const creatorPubkey = new PublicKey(params.creatorWallet);
    const creatorProfilePda = deriveCreatorProfilePda(creatorPubkey);
    // Validate display name (max 32 chars)
    const displayNameBytes = Buffer.from(params.displayName, 'utf8');
    if (displayNameBytes.length > 32) {
        throw new Error('Display name must be 32 bytes or less');
    }
    // Validate fee (max 50 bps = 0.5%)
    if (params.creatorFeeBps > 50) {
        throw new Error('Creator fee cannot exceed 50 bps (0.5%)');
    }
    // Instruction data: discriminator + display_name (String) + creator_fee_bps (u16)
    const nameLen = displayNameBytes.length;
    const data = Buffer.alloc(8 + 4 + nameLen + 2);
    DISCRIMINATORS.create_creator_profile.copy(data, 0);
    data.writeUInt32LE(nameLen, 8);
    displayNameBytes.copy(data, 12);
    data.writeUInt16LE(params.creatorFeeBps, 12 + nameLen);
    // IDL Accounts: creator_profile, owner, system_program (NO config!)
    const keys = [
        { pubkey: creatorProfilePda, isSigner: false, isWritable: true },
        { pubkey: creatorPubkey, isSigner: true, isWritable: true },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
    ];
    const instruction = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
    });
    const transaction = new Transaction().add(instruction);
    const { blockhash } = await conn.getLatestBlockhash('finalized');
    transaction.recentBlockhash = blockhash;
    transaction.feePayer = creatorPubkey;
    return {
        transaction,
        serializedTx: transaction.serialize({ requireAllSignatures: false, verifySignatures: false }).toString('base64'),
        creatorProfilePda: creatorProfilePda.toBase58(),
    };
}
/**
 * Build update_creator_profile transaction
 * Updates display name and fee settings (both required per IDL)
 * IDL Accounts: creator_profile, owner (NO config!)
 */
export async function buildUpdateCreatorProfileTransaction(params) {
    const conn = params.connection || new Connection(RPC_ENDPOINT, 'confirmed');
    const creatorPubkey = new PublicKey(params.creatorWallet);
    const creatorProfilePda = deriveCreatorProfilePda(creatorPubkey);
    // Validate display name (max 32 chars)
    const displayNameBytes = Buffer.from(params.displayName, 'utf8');
    if (displayNameBytes.length > 32) {
        throw new Error('Display name must be 32 bytes or less');
    }
    // Validate fee (max 50 bps = 0.5%)
    if (params.defaultFeeBps > 50) {
        throw new Error('Creator fee cannot exceed 50 bps (0.5%)');
    }
    // Instruction data: discriminator + display_name (String) + default_fee_bps (u16)
    // Both are REQUIRED per IDL (not Option<T>)
    const nameLen = displayNameBytes.length;
    const data = Buffer.alloc(8 + 4 + nameLen + 2);
    DISCRIMINATORS.update_creator_profile.copy(data, 0);
    data.writeUInt32LE(nameLen, 8);
    displayNameBytes.copy(data, 12);
    data.writeUInt16LE(params.defaultFeeBps, 12 + nameLen);
    // IDL Accounts: creator_profile, owner (NO config!)
    const keys = [
        { pubkey: creatorProfilePda, isSigner: false, isWritable: true },
        { pubkey: creatorPubkey, isSigner: true, isWritable: false },
    ];
    const instruction = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
    });
    const transaction = new Transaction().add(instruction);
    const { blockhash } = await conn.getLatestBlockhash('finalized');
    transaction.recentBlockhash = blockhash;
    transaction.feePayer = creatorPubkey;
    return {
        transaction,
        serializedTx: transaction.serialize({ requireAllSignatures: false, verifySignatures: false }).toString('base64'),
    };
}
/**
 * Build claim_creator_sol transaction
 * Claims accumulated creator fees from sol_treasury
 * IDL Accounts: config, creator_profile, sol_treasury, owner, system_program
 */
export async function buildClaimCreatorTransaction(params) {
    const conn = params.connection || new Connection(RPC_ENDPOINT, 'confirmed');
    const creatorPubkey = new PublicKey(params.creatorWallet);
    const creatorProfilePda = deriveCreatorProfilePda(creatorPubkey);
    const data = DISCRIMINATORS.claim_creator_sol;
    // IDL Accounts: config, creator_profile, sol_treasury, owner, system_program
    const keys = [
        { pubkey: CONFIG_PDA, isSigner: false, isWritable: false },
        { pubkey: creatorProfilePda, isSigner: false, isWritable: true },
        { pubkey: SOL_TREASURY_PDA, isSigner: false, isWritable: true },
        { pubkey: creatorPubkey, isSigner: true, isWritable: true },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
    ];
    const instruction = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
    });
    const transaction = new Transaction().add(instruction);
    const { blockhash } = await conn.getLatestBlockhash('finalized');
    transaction.recentBlockhash = blockhash;
    transaction.feePayer = creatorPubkey;
    return {
        transaction,
        serializedTx: transaction.serialize({ requireAllSignatures: false, verifySignatures: false }).toString('base64'),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRvci10cmFuc2FjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWlsZGVycy9jcmVhdG9yLXRyYW5zYWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0dBT0c7QUFDSCxPQUFPLEVBQ0wsVUFBVSxFQUNWLFNBQVMsRUFDVCxXQUFXLEVBQ1gsc0JBQXNCLEVBQ3RCLGFBQWEsR0FDZCxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFDTCxVQUFVLEVBQ1YsVUFBVSxFQUNWLGdCQUFnQixFQUNoQixZQUFZLEdBRWIsTUFBTSxjQUFjLENBQUM7QUFFdEIsZ0ZBQWdGO0FBQ2hGLGlCQUFpQjtBQUNqQixnRkFBZ0Y7QUFFaEYsTUFBTSxjQUFjLEdBQUc7SUFDckIsc0JBQXNCLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM1RSxzQkFBc0IsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3pFLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7Q0FDckUsQ0FBQztBQUVGLGdGQUFnRjtBQUNoRixpQkFBaUI7QUFDakIsZ0ZBQWdGO0FBRWhGLFNBQVMsdUJBQXVCLENBQUMsT0FBa0I7SUFDakQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxzQkFBc0IsQ0FDNUMsQ0FBQyxNQUFN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QyxFQUFFLG9CQUFvQixFQUFFLEtBQUssRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUM7S0FDakgsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0b3IgUHJvZmlsZSBUcmFuc2FjdGlvbiBCdWlsZGVyc1xuICpcbiAqIEJ1aWxkcyB1bnNpZ25lZCB0cmFuc2FjdGlvbnMgZm9yOlxuICogLSBDcmVhdGluZyBjcmVhdG9yIHByb2ZpbGVzXG4gKiAtIFVwZGF0aW5nIGNyZWF0b3IgcHJvZmlsZXNcbiAqIC0gQ2xhaW1pbmcgY3JlYXRvciBmZWVzXG4gKi9cbmltcG9ydCB7XG4gIENvbm5lY3Rpb24sXG4gIFB1YmxpY0tleSxcbiAgVHJhbnNhY3Rpb24sXG4gIFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24sXG4gIFN5c3RlbVByb2dyYW0sXG59IGZyb20gJ0Bzb2xhbmEvd2ViMy5qcyc7XG5pbXBvcnQge1xuICBQUk9HUkFNX0lELFxuICBDT05GSUdfUERBLFxuICBTT0xfVFJFQVNVUllfUERBLFxuICBSUENfRU5EUE9JTlQsXG4gIFNFRURTLFxufSBmcm9tICcuLi9jb25maWcuanMnO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gRElTQ1JJTUlOQVRPUlNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmNvbnN0IERJU0NSSU1JTkFUT1JTID0ge1xuICBjcmVhdGVfY3JlYXRvcl9wcm9maWxlOiBCdWZmZXIuZnJvbShbMTM5LCAyNDQsIDEyNywgMTQ1LCA5NSwgMTcyLCAxNDAsIDE1NF0pLFxuICB1cGRhdGVfY3JlYXRvcl9wcm9maWxlOiBCdWZmZXIuZnJvbShbOCwgMjQwLCAxNjIsIDU1LCAxMTAsIDQ2LCAxNzcsIDEwOF0pLFxuICBjbGFpbV9jcmVhdG9yX3NvbDogQnVmZmVyLmZyb20oWzIxLCAyNSwgMTY0LCA0NywgODEsIDE1NiwgMTk5LCAxMDNdKSxcbn07XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBQREEgREVSSVZBVElPTlxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZnVuY3Rpb24gZGVyaXZlQ3JlYXRvclByb2ZpbGVQZGEoY3JlYXRvcjogUHVibGljS2V5KTogUHVibGljS2V5IHtcbiAgY29uc3QgW3BkYV0gPSBQdWJsaWNLZXkuZmluZFByb2dyYW1BZGRyZXNzU3luYyhcbiAgICBbQnVmZmVyLmZyb20oJ2NyZWF0b3JfcHJvZmlsZScpLCBjcmVhdG9yLnRvQnVmZmVyKCldLFxuICAgIFBST0dSQU1fSURcbiAgKTtcbiAgcmV0dXJuIHBkYTtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIENSRUFUT1IgUFJPRklMRSBPUEVSQVRJT05TXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIEJ1aWxkIGNyZWF0ZV9jcmVhdG9yX3Byb2ZpbGUgdHJhbnNhY3Rpb25cbiAqIENyZWF0ZXMgYW4gb24tY2hhaW4gY3JlYXRvciBwcm9maWxlIGZvciByZXB1dGF0aW9uIGFuZCBmZWUgc2V0dGluZ3NcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJ1aWxkQ3JlYXRlQ3JlYXRvclByb2ZpbGVUcmFuc2FjdGlvbihwYXJhbXM6IHtcbiAgZGlzcGxheU5hbWU6IHN0cmluZztcbiAgY3JlYXRvckZlZUJwczogbnVtYmVyOyAvLyBCYXNpcyBwb2ludHMgKGUuZy4sIDUwID0gMC41JSlcbiAgY3JlYXRvcldhbGxldDogc3RyaW5nO1xuICBjb25uZWN0aW9uPzogQ29ubmVjdGlvbjtcbn0pOiBQcm9taXNlPHsgdHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uOyBzZXJpYWxpemVkVHg6IHN0cmluZzsgY3JlYXRvclByb2ZpbGVQZGE6IHN0cmluZyB9PiB7XG4gIGNvbnN0IGNvbm4gPSBwYXJhbXMuY29ubmVjdGlvbiB8fCBuZXcgQ29ubmVjdGlvbihSUENfRU5EUE9JTlQsICdjb25maXJtZWQnKTtcbiAgY29uc3QgY3JlYXRvclB1YmtleSA9IG5ldyBQdWJsaWNLZXkocGFyYW1zLmNyZWF0b3JXYWxsZXQpO1xuICBjb25zdCBjcmVhdG9yUHJvZmlsZVBkYSA9IGRlcml2ZUNyZWF0b3JQcm9maWxlUGRhKGNyZWF0b3JQdWJrZXkpO1xuXG4gIC8vIFZhbGlkYXRlIGRpc3BsYXkgbmFtZSAobWF4IDMyIGNoYXJzKVxuICBjb25zdCBkaXNwbGF5TmFtZUJ5dGVzID0gQnVmZmVyLmZyb20ocGFyYW1zLmRpc3BsYXlOYW1lLCAndXRmOCcpO1xuICBpZiAoZGlzcGxheU5hbWVCeXRlcy5sZW5ndGggPiAzMikge1xuICAgIHRocm93IG5ldyBFcnJvcignRGlzcGxheSBuYW1lIG11c3QgYmUgMzIgYnl0ZXMgb3IgbGVzcycpO1xuICB9XG5cbiAgLy8gVmFsaWRhdGUgZmVlIChtYXggNTAgYnBzID0gMC41JSlcbiAgaWYgKHBhcmFtcy5jcmVhdG9yRmVlQnBzID4gNTApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0NyZWF0b3IgZmVlIGNhbm5vdCBleGNlZWQgNTAgYnBzICgwLjUlKScpO1xuICB9XG5cbiAgLy8gSW5zdHJ1Y3Rpb24gZGF0YTogZGlzY3JpbWluYXRvciArIGRpc3BsYXlfbmFtZSAoU3RyaW5nKSArIGNyZWF0b3JfZmVlX2JwcyAodTE2KVxuICBjb25zdCBuYW1lTGVuID0gZGlzcGxheU5hbWVCeXRlcy5sZW5ndGg7XG4gIGNvbnN0IGRhdGEgPSBCdWZmZXIuYWxsb2MoOCArIDQgKyBuYW1lTGVuICsgMik7XG4gIERJU0NSSU1JTkFUT1JTLmNyZWF0ZV9jcmVhdG9yX3Byb2ZpbGUuY29weShkYXRhLCAwKTtcbiAgZGF0YS53cml0ZVVJbnQzMkxFKG5hbWVMZW4sIDgpO1xuICBkaXNwbGF5TmFtZUJ5dGVzLmNvcHkoZGF0YSwgMTIpO1xuICBkYXRhLndyaXRlVUludDE2TEUocGFyYW1zLmNyZWF0b3JGZWVCcHMsIDEyICsgbmFtZUxlbik7XG5cbiAgLy8gSURMIEFjY291bnRzOiBjcmVhdG9yX3Byb2ZpbGUsIG93bmVyLCBzeXN0ZW1fcHJvZ3JhbSAoTk8gY29uZmlnISlcbiAgY29uc3Qga2V5cyA9IFtcbiAgICB7IHB1YmtleTogY3JlYXRvclByb2ZpbGVQZGEsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogdHJ1ZSB9LFxuICAgIHsgcHVia2V5OiBjcmVhdG9yUHVia2V5LCBpc1NpZ25lcjogdHJ1ZSwgaXNXcml0YWJsZTogdHJ1ZSB9LFxuICAgIHsgcHVia2V5OiBTeXN0ZW1Qcm9ncmFtLnByb2dyYW1JZCwgaXNTaWduZXI6IGZhbHNlLCBpc1dyaXRhYmxlOiBmYWxzZSB9LFxuICBdO1xuXG4gIGNvbnN0IGluc3RydWN0aW9uID0gbmV3IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24oe1xuICAgIHByb2dyYW1JZDogUFJPR1JBTV9JRCxcbiAgICBrZXlzLFxuICAgIGRhdGEsXG4gIH0pO1xuXG4gIGNvbnN0IHRyYW5zYWN0aW9uID0gbmV3IFRyYW5zYWN0aW9uKCkuYWRkKGluc3RydWN0aW9uKTtcbiAgY29uc3QgeyBibG9ja2hhc2ggfSA9IGF3YWl0IGNvbm4uZ2V0TGF0ZXN0QmxvY2toYXNoKCdmaW5hbGl6ZWQnKTtcbiAgdHJhbnNhY3Rpb24ucmVjZW50QmxvY2toYXNoID0gYmxvY2toYXNoO1xuICB0cmFuc2FjdGlvbi5mZWVQYXllciA9IGNyZWF0b3JQdWJrZXk7XG5cbiAgcmV0dXJuIHtcbiAgICB0cmFuc2FjdGlvbixcbiAgICBzZXJpYWxpemVkVHg6IHRyYW5zYWN0aW9uLnNlcmlhbGl6ZSh7IHJlcXVpcmVBbGxTaWduYXR1cmVzOiBmYWxzZSwgdmVyaWZ5U2lnbmF0dXJlczogZmFsc2UgfSkudG9TdHJpbmcoJ2Jhc2U2NCcpLFxuICAgIGNyZWF0b3JQcm9maWxlUGRhOiBjcmVhdG9yUHJvZmlsZVBkYS50b0Jhc2U1OCgpLFxuICB9O1xufVxuXG4vKipcbiAqIEJ1aWxkIHVwZGF0ZV9jcmVhdG9yX3Byb2ZpbGUgdHJhbnNhY3Rpb25cbiAqIFVwZGF0ZXMgZGlzcGxheSBuYW1lIGFuZCBmZWUgc2V0dGluZ3MgKGJvdGggcmVxdWlyZWQgcGVyIElETClcbiAqIElETCBBY2NvdW50czogY3JlYXRvcl9wcm9maWxlLCBvd25lciAoTk8gY29uZmlnISlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJ1aWxkVXBkYXRlQ3JlYXRvclByb2ZpbGVUcmFuc2FjdGlvbihwYXJhbXM6IHtcbiAgZGlzcGxheU5hbWU6IHN0cmluZztcbiAgZGVmYXVsdEZlZUJwczogbnVtYmVyO1xuICBjcmVhdG9yV2FsbGV0OiBzdHJpbmc7XG4gIGNvbm5lY3Rpb24/OiBDb25uZWN0aW9uO1xufSk6IFByb21pc2U8eyB0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb247IHNlcmlhbGl6ZWRUeDogc3RyaW5nIH0+IHtcbiAgY29uc3QgY29ubiA9IHBhcmFtcy5jb25uZWN0aW9uIHx8IG5ldyBDb25uZWN0aW9uKFJQQ19FTkRQT0lOVCwgJ2NvbmZpcm1lZCcpO1xuICBjb25zdCBjcmVhdG9yUHVia2V5ID0gbmV3IFB1YmxpY0tleShwYXJhbXMuY3JlYXRvcldhbGxldCk7XG4gIGNvbnN0IGNyZWF0b3JQcm9maWxlUGRhID0gZGVyaXZlQ3JlYXRvclByb2ZpbGVQZGEoY3JlYXRvclB1YmtleSk7XG5cbiAgLy8gVmFsaWRhdGUgZGlzcGxheSBuYW1lIChtYXggMzIgY2hhcnMpXG4gIGNvbnN0IGRpc3BsYXlOYW1lQnl0ZXMgPSBCdWZmZXIuZnJvbShwYXJhbXMuZGlzcGxheU5hbWUsICd1dGY4Jyk7XG4gIGlmIChkaXNwbGF5TmFtZUJ5dGVzLmxlbmd0aCA+IDMyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdEaXNwbGF5IG5hbWUgbXVzdCBiZSAzMiBieXRlcyBvciBsZXNzJyk7XG4gIH1cblxuICAvLyBWYWxpZGF0ZSBmZWUgKG1heCA1MCBicHMgPSAwLjUlKVxuICBpZiAocGFyYW1zLmRlZmF1bHRGZWVCcHMgPiA1MCkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ3JlYXRvciBmZWUgY2Fubm90IGV4Y2VlZCA1MCBicHMgKDAuNSUpJyk7XG4gIH1cblxuICAvLyBJbnN0cnVjdGlvbiBkYXRhOiBkaXNjcmltaW5hdG9yICsgZGlzcGxheV9uYW1lIChTdHJpbmcpICsgZGVmYXVsdF9mZWVfYnBzICh1MTYpXG4gIC8vIEJvdGggYXJlIFJFUVVJUkVEIHBlciBJREwgKG5vdCBPcHRpb248VD4pXG4gIGNvbnN0IG5hbWVMZW4gPSBkaXNwbGF5TmFtZUJ5dGVzLmxlbmd0aDtcbiAgY29uc3QgZGF0YSA9IEJ1ZmZlci5hbGxvYyg4ICsgNCArIG5hbWVMZW4gKyAyKTtcbiAgRElTQ1JJTUlOQVRPUlMudXBkYXRlX2NyZWF0b3JfcHJvZmlsZS5jb3B5KGRhdGEsIDApO1xuICBkYXRhLndyaXRlVUludDMyTEUobmFtZUxlbiwgOCk7XG4gIGRpc3BsYXlOYW1lQnl0ZXMuY29weShkYXRhLCAxMik7XG4gIGRhdGEud3JpdGVVSW50MTZMRShwYXJhbXMuZGVmYXVsdEZlZUJwcywgMTIgKyBuYW1lTGVuKTtcblxuICAvLyBJREwgQWNjb3VudHM6IGNyZWF0b3JfcHJvZmlsZSwgb3duZXIgKE5PIGNvbmZpZyEpXG4gIGNvbnN0IGtleXMgPSBbXG4gICAgeyBwdWJrZXk6IGNyZWF0b3JQcm9maWxlUGRhLCBpc1NpZ25lcjogZmFsc2UsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgICB7IHB1YmtleTogY3JlYXRvclB1YmtleSwgaXNTaWduZXI6IHRydWUsIGlzV3JpdGFibGU6IGZhbHNlIH0sXG4gIF07XG5cbiAgY29uc3QgaW5zdHJ1Y3Rpb24gPSBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7XG4gICAgcHJvZ3JhbUlkOiBQUk9HUkFNX0lELFxuICAgIGtleXMsXG4gICAgZGF0YSxcbiAgfSk7XG5cbiAgY29uc3QgdHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oKS5hZGQoaW5zdHJ1Y3Rpb24pO1xuICBjb25zdCB7IGJsb2NraGFzaCB9ID0gYXdhaXQgY29ubi5nZXRMYXRlc3RCbG9ja2hhc2goJ2ZpbmFsaXplZCcpO1xuICB0cmFuc2FjdGlvbi5yZWNlbnRCbG9ja2hhc2ggPSBibG9ja2hhc2g7XG4gIHRyYW5zYWN0aW9uLmZlZVBheWVyID0gY3JlYXRvclB1YmtleTtcblxuICByZXR1cm4ge1xuICAgIHRyYW5zYWN0aW9uLFxuICAgIHNlcmlhbGl6ZWRUeDogdHJhbnNhY3Rpb24uc2VyaWFsaXplKHsgcmVxdWlyZUFsbFNpZ25hdHVyZXM6IGZhbHNlLCB2ZXJpZnlTaWduYXR1cmVzOiBmYWxzZSB9KS50b1N0cmluZygnYmFzZTY0JyksXG4gIH07XG59XG5cbi8qKlxuICogQnVpbGQgY2xhaW1fY3JlYXRvcl9zb2wgdHJhbnNhY3Rpb25cbiAqIENsYWltcyBhY2N1bXVsYXRlZCBjcmVhdG9yIGZlZXMgZnJvbSBzb2xfdHJlYXN1cnlcbiAqIElETCBBY2NvdW50czogY29uZmlnLCBjcmVhdG9yX3Byb2ZpbGUsIHNvbF90cmVhc3VyeSwgb3duZXIsIHN5c3RlbV9wcm9ncmFtXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZENsYWltQ3JlYXRvclRyYW5zYWN0aW9uKHBhcmFtczoge1xuICBjcmVhdG9yV2FsbGV0OiBzdHJpbmc7XG4gIGNvbm5lY3Rpb24/OiBDb25uZWN0aW9uO1xufSk6IFByb21pc2U8eyB0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb247IHNlcmlhbGl6ZWRUeDogc3RyaW5nIH0+IHtcbiAgY29uc3QgY29ubiA9IHBhcmFtcy5jb25uZWN0aW9uIHx8IG5ldyBDb25uZWN0aW9uKFJQQ19FTkRQT0lOVCwgJ2NvbmZpcm1lZCcpO1xuICBjb25zdCBjcmVhdG9yUHVia2V5ID0gbmV3IFB1YmxpY0tleShwYXJhbXMuY3JlYXRvcldhbGxldCk7XG4gIGNvbnN0IGNyZWF0b3JQcm9maWxlUGRhID0gZGVyaXZlQ3JlYXRvclByb2ZpbGVQZGEoY3JlYXRvclB1YmtleSk7XG5cbiAgY29uc3QgZGF0YSA9IERJU0NSSU1JTkFUT1JTLmNsYWltX2NyZWF0b3Jfc29sO1xuXG4gIC8vIElETCBBY2NvdW50czogY29uZmlnLCBjcmVhdG9yX3Byb2ZpbGUsIHNvbF90cmVhc3VyeSwgb3duZXIsIHN5c3RlbV9wcm9ncmFtXG4gIGNvbnN0IGtleXMgPSBbXG4gICAgeyBwdWJrZXk6IENPTkZJR19QREEsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogZmFsc2UgfSxcbiAgICB7IHB1YmtleTogY3JlYXRvclByb2ZpbGVQZGEsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogdHJ1ZSB9LFxuICAgIHsgcHVia2V5OiBTT0xfVFJFQVNVUllfUERBLCBpc1NpZ25lcjogZmFsc2UsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgICB7IHB1YmtleTogY3JlYXRvclB1YmtleSwgaXNTaWduZXI6IHRydWUsIGlzV3JpdGFibGU6IHRydWUgfSxcbiAgICB7IHB1YmtleTogU3lzdGVtUHJvZ3JhbS5wcm9ncmFtSWQsIGlzU2lnbmVyOiBmYWxzZSwgaXNXcml0YWJsZTogZmFsc2UgfSxcbiAgXTtcblxuICBjb25zdCBpbnN0cnVjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHtcbiAgICBwcm9ncmFtSWQ6IFBST0dSQU1fSUQsXG4gICAga2V5cyxcbiAgICBkYXRhLFxuICB9KTtcblxuICBjb25zdCB0cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbigpLmFkZChpbnN0cnVjdGlvbik7XG4gIGNvbnN0IHsgYmxvY2toYXNoIH0gPSBhd2FpdCBjb25uLmdldExhdGVzdEJsb2NraGFzaCgnZmluYWxpemVkJyk7XG4gIHRyYW5zYWN0aW9uLnJlY2VudEJsb2NraGFzaCA9IGJsb2NraGFzaDtcbiAgdHJhbnNhY3Rpb24uZmVlUGF5ZXIgPSBjcmVhdG9yUHVia2V5O1xuXG4gIHJldHVybiB7XG4gICAgdHJhbnNhY3Rpb24sXG4gICAgc2VyaWFsaXplZFR4OiB0cmFuc2FjdGlvbi5zZXJpYWxpemUoeyByZXF1aXJlQWxsU2lnbmF0dXJlczogZmFsc2UsIHZlcmlmeVNpZ25hdHVyZXM6IGZhbHNlIH0pLnRvU3RyaW5nKCdiYXNlNjQnKSxcbiAgfTtcbn1cbiJdfQ==