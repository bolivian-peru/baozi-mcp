/**
 * Quote handler for MCP server
 * Calculates expected payouts for bets using pari-mutuel math
 */
import { getMarket, getMarketForBetting } from './markets.js';
import { validateBet } from '../validation/bet-rules.js';
// =============================================================================
// QUOTE CALCULATION
// =============================================================================
/**
 * Calculate a quote for a potential bet
 */
export async function getQuote(marketPubkey, side, amountSol) {
    const baseQuote = {
        valid: false,
        warnings: [],
        market: marketPubkey,
        side,
        betAmountSol: amountSol,
        expectedPayoutSol: 0,
        potentialProfitSol: 0,
        impliedOdds: 0,
        decimalOdds: 0,
        feeSol: 0,
        feeBps: 0,
        newYesPoolSol: 0,
        newNoPoolSol: 0,
        currentYesPercent: 50,
        currentNoPercent: 50,
        newYesPercent: 50,
        newNoPercent: 50,
    };
    // Fetch market
    const market = await getMarket(marketPubkey);
    if (!market) {
        return {
            ...baseQuote,
            error: `Market ${marketPubkey} not found`,
        };
    }
    baseQuote.marketQuestion = market.question;
    baseQuote.feeBps = market.platformFeeBps;
    baseQuote.currentYesPercent = market.yesPercent;
    baseQuote.currentNoPercent = market.noPercent;
    // Validate bet parameters
    const validation = validateBet({
        amountSol,
        marketStatus: market.statusCode,
        closingTime: new Date(market.closingTime),
        isPaused: false, // Not tracked in current Market type, assume not paused
        accessGate: market.accessGate === 'Whitelist' ? 1 : 0,
        userWhitelisted: true, // Can't check without user wallet, assume whitelisted
        layer: market.layerCode,
    });
    if (!validation.valid) {
        return {
            ...baseQuote,
            error: validation.error,
            warnings: validation.warnings,
        };
    }
    // Calculate new pools after bet
    const newYesPoolSol = side === 'Yes'
        ? market.yesPoolSol + amountSol
        : market.yesPoolSol;
    const newNoPoolSol = side === 'No'
        ? market.noPoolSol + amountSol
        : market.noPoolSol;
    const newTotalPool = newYesPoolSol + newNoPoolSol;
    // Calculate expected payout (pari-mutuel)
    const sidePool = side === 'Yes' ? newYesPoolSol : newNoPoolSol;
    const expectedPayoutSol = sidePool > 0
        ? (amountSol / sidePool) * newTotalPool
        : 0;
    // Calculate profit and fee
    const grossProfit = expectedPayoutSol - amountSol;
    const feeSol = grossProfit > 0
        ? (grossProfit * market.platformFeeBps) / 10000
        : 0;
    const potentialProfitSol = grossProfit - feeSol;
    // Calculate odds
    const impliedOdds = newTotalPool > 0
        ? (sidePool / newTotalPool) * 100
        : 50;
    const decimalOdds = sidePool > 0
        ? newTotalPool / sidePool
        : 2;
    // Calculate new percentages
    const newYesPercent = newTotalPool > 0
        ? (newYesPoolSol / newTotalPool) * 100
        : 50;
    const newNoPercent = newTotalPool > 0
        ? (newNoPoolSol / newTotalPool) * 100
        : 50;
    return {
        valid: true,
        warnings: validation.warnings,
        market: marketPubkey,
        marketQuestion: market.question,
        side,
        betAmountSol: round4(amountSol),
        expectedPayoutSol: round4(expectedPayoutSol),
        potentialProfitSol: round4(potentialProfitSol),
        impliedOdds: round2(impliedOdds),
        decimalOdds: round2(decimalOdds),
        feeSol: round4(feeSol),
        feeBps: market.platformFeeBps,
        newYesPoolSol: round4(newYesPoolSol),
        newNoPoolSol: round4(newNoPoolSol),
        currentYesPercent: market.yesPercent,
        currentNoPercent: market.noPercent,
        newYesPercent: round2(newYesPercent),
        newNoPercent: round2(newNoPercent),
    };
}
/**
 * Calculate quote with additional market data for transaction building
 */
export async function getQuoteWithMarketData(marketPubkey, side, amountSol) {
    const quote = await getQuote(marketPubkey, side, amountSol);
    if (!quote.valid) {
        return { quote };
    }
    // Get additional market data for tx building
    const marketData = await getMarketForBetting(marketPubkey);
    if (!marketData) {
        return { quote };
    }
    return {
        quote,
        marketId: marketData.marketId,
        accessGate: marketData.accessGate,
    };
}
// =============================================================================
// HELPERS
// =============================================================================
function round2(n) {
    return Math.round(n * 100) / 100;
}
function round4(n) {
    return Math.round(n * 10000) / 10000;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVvdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaGFuZGxlcnMvcXVvdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBQ0gsT0FBTyxFQUFFLFNBQVMsRUFBRSxtQkFBbUIsRUFBVSxNQUFNLGNBQWMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUE2QnpELGdGQUFnRjtBQUNoRixvQkFBb0I7QUFDcEIsZ0ZBQWdGO0FBRWhGOztHQUVHO0FBQ0gsTUFBTSxDQUFDLEtBQUssVUFBVSxRQUFRLENBQzVCLFlBQW9CLEVBQ3BCLElBQWtCLEVBQ2xCLFNBQWlCO0lBRWpCLE1BQU0sU0FBUyxHQUFVO1FBQ3ZCLEtBQUssRUFBRSxLQUFLO1FBQ1osUUFBUSxFQUFFLEVBQUU7UUFDWixNQUFNLEVBQUUsWUFBWTtRQUNwQixJQUFJO1FBQ0osWUFBWSxFQUFFLFNBQVM7UUFDdkIsaUJBQWlCLEVBQUUsQ0FBQztRQUNwQixrQkFBa0IsRUFBRSxDQUFDO1FBQ3JCLFdBQVcsRUFBRSxDQUFDO1FBQ2QsV0FBVyxFQUFFLENBQUM7UUFDZCxNQUFNLEVBQUUsQ0FBQztRQUNULE1BQU0sRUFBRSxDQUFDO1FBQ1QsYUFBYSxFQUFFLENBQUM7UUFDaEIsWUFBWSxFQUFFLENBQUM7UUFDZixpQkFBaUIsRUFBRSxFQUFFO1FBQ3JCLGdCQUFnQixFQUFFLEVBQUU7UUFDcEIsYUFBYSxFQUFFLEVBQUU7UUFDakIsWUFBWSxFQUFFLEVBQUU7S0FDakIsQ0FBQztJQUVGLGVBQWU7SUFDZixNQUFNLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUU3QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDWixPQUFPO1lBQ0wsR0FBRyxTQUFTO1lBQ1osS0FBSyxFQUFFLFVBQVUsWUFBWSxZQUFZO1NBQzFDLENBQUM7SUFDSixDQUFDO0lBRUQsU0FBUyxDQUFDLGNB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QyxZQUFZLENBQUMsQ0FBQztJQUUzRCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDaEIsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFFRCxPQUFPO1FBQ0wsS0FBSztRQUNMLFFBQVEsRUFBRSxVQUFVLENBQUMsUUFBUTtRQUM3QixVQUFVLEVBQUUsVUFBVSxDQUFDLFVBQVU7S0FDbEMsQ0FBQztBQUNKLENBQUM7QUFFRCxnRkFBZ0Y7QUFDaEYsVUFBVTtBQUNWLGdGQUFnRjtBQUVoRixTQUFTLE1BQU0sQ0FBQyxDQUFTO0lBQ3ZCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO0FBQ25DLENBQUM7QUFFRCxTQUFTLE1BQU0sQ0FBQyxDQUFTO0lBQ3ZCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDO0FBQ3ZDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFF1b3RlIGhhbmRsZXIgZm9yIE1DUCBzZXJ2ZXJcbiAqIENhbGN1bGF0ZXMgZXhwZWN0ZWQgcGF5b3V0cyBmb3IgYmV0cyB1c2luZyBwYXJpLW11dHVlbCBtYXRoXG4gKi9cbmltcG9ydCB7IGdldE1hcmtldCwgZ2V0TWFya2V0Rm9yQmV0dGluZywgTWFya2V0IH0gZnJvbSAnLi9tYXJrZXRzLmpzJztcbmltcG9ydCB7IHZhbGlkYXRlQmV0IH0gZnJvbSAnLi4vdmFsaWRhdGlvbi9iZXQtcnVsZXMuanMnO1xuaW1wb3J0IHsgQkVUX0xJTUlUUyB9IGZyb20gJy4uL2NvbmZpZy5qcyc7XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBUWVBFU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGludGVyZmFjZSBRdW90ZSB7XG4gIHZhbGlkOiBib29sZWFuO1xuICBlcnJvcj86IHN0cmluZztcbiAgd2FybmluZ3M6IHN0cmluZ1tdO1xuICBtYXJrZXQ6IHN0cmluZztcbiAgbWFya2V0UXVlc3Rpb24/OiBzdHJpbmc7XG4gIHNpZGU6ICdZZXMnIHwgJ05vJztcbiAgYmV0QW1vdW50U29sOiBudW1iZXI7XG4gIGV4cGVjdGVkUGF5b3V0U29sOiBudW1iZXI7XG4gIHBvdGVudGlhbFByb2ZpdFNvbDogbnVtYmVyO1xuICBpbXBsaWVkT2RkczogbnVtYmVyO1xuICBkZWNpbWFsT2RkczogbnVtYmVyO1xuICBmZWVTb2w6IG51bWJlcjtcbiAgZmVlQnBzOiBudW1iZXI7XG4gIG5ld1llc1Bvb2xTb2w6IG51bWJlcjtcbiAgbmV3Tm9Qb29sU29sOiBudW1iZXI7XG4gIGN1cnJlbnRZZXNQZXJjZW50OiBudW1iZXI7XG4gIGN1cnJlbnROb1BlcmNlbnQ6IG51bWJlcjtcbiAgbmV3WWVzUGVyY2VudDogbnVtYmVyO1xuICBuZXdOb1BlcmNlbnQ6IG51bWJlcjtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFFVT1RFIENBTENVTEFUSU9OXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIENhbGN1bGF0ZSBhIHF1b3RlIGZvciBhIHBvdGVudGlhbCBiZXRcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFF1b3RlKFxuICBtYXJrZXRQdWJrZXk6IHN0cmluZyxcbiAgc2lkZTogJ1llcycgfCAnTm8nLFxuICBhbW91bnRTb2w6IG51bWJlclxuKTogUHJvbWlzZTxRdW90ZT4ge1xuICBjb25zdCBiYXNlUXVvdGU6IFF1b3RlID0ge1xuICAgIHZhbGlkOiBmYWxzZSxcbiAgICB3YXJuaW5nczogW10sXG4gICAgbWFya2V0OiBtYXJrZXRQdWJrZXksXG4gICAgc2lkZSxcbiAgICBiZXRBbW91bnRTb2w6IGFtb3VudFNvbCxcbiAgICBleHBlY3RlZFBheW91dFNvbDogMCxcbiAgICBwb3RlbnRpYWxQcm9maXRTb2w6IDAsXG4gICAgaW1wbGllZE9kZHM6IDAsXG4gICAgZGVjaW1hbE9kZHM6IDAsXG4gICAgZmVlU29sOiAwLFxuICAgIGZlZUJwczogMCxcbiAgICBuZXdZZXNQb29sU29sOiAwLFxuICAgIG5ld05vUG9vbFNvbDogMCxcbiAgICBjdXJyZW50WWVzUGVyY2VudDogNTAsXG4gICAgY3VycmVudE5vUGVyY2VudDogNTAsXG4gICAgbmV3WWVzUGVyY2VudDogNTAsXG4gICAgbmV3Tm9QZXJjZW50OiA1MCxcbiAgfTtcblxuICAvLyBGZXRjaCBtYXJrZXRcbiAgY29uc3QgbWFya2V0ID0gYXdhaXQgZ2V0TWFya2V0KG1hcmtldFB1YmtleSk7XG5cbiAgaWYgKCFtYXJrZXQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4uYmFzZVF1b3RlLFxuICAgICAgZXJyb3I6IGBNYXJrZXQgJHttYXJrZXRQdWJrZXl9IG5vdCBmb3VuZGAsXG4gICAgfTtcbiAgfVxuXG4gIGJhc2VRdW90ZS5tYXJrZXRRdWVzdGlvbiA9IG1hcmtldC5xdWVzdGlvbjtcbiAgYmFzZVF1b3RlLmZlZUJwcyA9IG1hcmtldC5wbGF0Zm9ybUZlZUJwcztcbiAgYmFzZVF1b3RlLmN1cnJlbnRZZXNQZXJjZW50ID0gbWFya2V0Lnllc1BlcmNlbnQ7XG4gIGJhc2VRdW90ZS5jdXJyZW50Tm9QZXJjZW50ID0gbWFya2V0Lm5vUGVyY2VudDtcblxuICAvLyBWYWxpZGF0ZSBiZXQgcGFyYW1ldGVyc1xuICBjb25zdCB2YWxpZGF0aW9uID0gdmFsaWRhdGVCZXQoe1xuICAgIGFtb3VudFNvbCxcbiAgICBtYXJrZXRTdGF0dXM6IG1hcmtldC5zdGF0dXNDb2RlLFxuICAgIGNsb3NpbmdUaW1lOiBuZXcgRGF0ZShtYXJrZXQuY2xvc2luZ1RpbWUpLFxuICAgIGlzUGF1c2VkOiBmYWxzZSwgLy8gTm90IHRyYWNrZWQgaW4gY3VycmVudCBNYXJrZXQgdHlwZSwgYXNzdW1lIG5vdCBwYXVzZWRcbiAgICBhY2Nlc3NHYXRlOiBtYXJrZXQuYWNjZXNzR2F0ZSA9PT0gJ1doaXRlbGlzdCcgPyAxIDogMCxcbiAgICB1c2VyV2hpdGVsaXN0ZWQ6IHRydWUsIC8vIENhbid0IGNoZWNrIHdpdGhvdXQgdXNlciB3YWxsZXQsIGFzc3VtZSB3aGl0ZWxpc3RlZFxuICAgIGxheWVyOiBtYXJrZXQubGF5ZXJDb2RlLFxuICB9KTtcblxuICBpZiAoIXZhbGlkYXRpb24udmFsaWQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4uYmFzZVF1b3RlLFxuICAgICAgZXJyb3I6IHZhbGlkYXRpb24uZXJyb3IsXG4gICAgICB3YXJuaW5nczogdmFsaWRhdGlvbi53YXJuaW5ncyxcbiAgICB9O1xuICB9XG5cbiAgLy8gQ2FsY3VsYXRlIG5ldyBwb29scyBhZnRlciBiZXRcbiAgY29uc3QgbmV3WWVzUG9vbFNvbCA9IHNpZGUgPT09ICdZZXMnXG4gICAgPyBtYXJrZXQueWVzUG9vbFNvbCArIGFtb3VudFNvbFxuICAgIDogbWFya2V0Lnllc1Bvb2xTb2w7XG4gIGNvbnN0IG5ld05vUG9vbFNvbCA9IHNpZGUgPT09ICdObydcbiAgICA/IG1hcmtldC5ub1Bvb2xTb2wgKyBhbW91bnRTb2xcbiAgICA6IG1hcmtldC5ub1Bvb2xTb2w7XG4gIGNvbnN0IG5ld1RvdGFsUG9vbCA9IG5ld1llc1Bvb2xTb2wgKyBuZXdOb1Bvb2xTb2w7XG5cbiAgLy8gQ2FsY3VsYXRlIGV4cGVjdGVkIHBheW91dCAocGFyaS1tdXR1ZWwpXG4gIGNvbnN0IHNpZGVQb29sID0gc2lkZSA9PT0gJ1llcycgPyBuZXdZZXNQb29sU29sIDogbmV3Tm9Qb29sU29sO1xuICBjb25zdCBleHBlY3RlZFBheW91dFNvbCA9IHNpZGVQb29sID4gMFxuICAgID8gKGFtb3VudFNvbCAvIHNpZGVQb29sKSAqIG5ld1RvdGFsUG9vbFxuICAgIDogMDtcblxuICAvLyBDYWxjdWxhdGUgcHJvZml0IGFuZCBmZWVcbiAgY29uc3QgZ3Jvc3NQcm9maXQgPSBleHBlY3RlZFBheW91dFNvbCAtIGFtb3VudFNvbDtcbiAgY29uc3QgZmVlU29sID0gZ3Jvc3NQcm9maXQgPiAwXG4gICAgPyAoZ3Jvc3NQcm9maXQgKiBtYXJrZXQucGxhdGZvcm1GZWVCcHMpIC8gMTAwMDBcbiAgICA6IDA7XG4gIGNvbnN0IHBvdGVudGlhbFByb2ZpdFNvbCA9IGdyb3NzUHJvZml0IC0gZmVlU29sO1xuXG4gIC8vIENhbGN1bGF0ZSBvZGRzXG4gIGNvbnN0IGltcGxpZWRPZGRzID0gbmV3VG90YWxQb29sID4gMFxuICAgID8gKHNpZGVQb29sIC8gbmV3VG90YWxQb29sKSAqIDEwMFxuICAgIDogNTA7XG4gIGNvbnN0IGRlY2ltYWxPZGRzID0gc2lkZVBvb2wgPiAwXG4gICAgPyBuZXdUb3RhbFBvb2wgLyBzaWRlUG9vbFxuICAgIDogMjtcblxuICAvLyBDYWxjdWxhdGUgbmV3IHBlcmNlbnRhZ2VzXG4gIGNvbnN0IG5ld1llc1BlcmNlbnQgPSBuZXdUb3RhbFBvb2wgPiAwXG4gICAgPyAobmV3WWVzUG9vbFNvbCAvIG5ld1RvdGFsUG9vbCkgKiAxMDBcbiAgICA6IDUwO1xuICBjb25zdCBuZXdOb1BlcmNlbnQgPSBuZXdUb3RhbFBvb2wgPiAwXG4gICAgPyAobmV3Tm9Qb29sU29sIC8gbmV3VG90YWxQb29sKSAqIDEwMFxuICAgIDogNTA7XG5cbiAgcmV0dXJuIHtcbiAgICB2YWxpZDogdHJ1ZSxcbiAgICB3YXJuaW5nczogdmFsaWRhdGlvbi53YXJuaW5ncyxcbiAgICBtYXJrZXQ6IG1hcmtldFB1YmtleSxcbiAgICBtYXJrZXRRdWVzdGlvbjogbWFya2V0LnF1ZXN0aW9uLFxuICAgIHNpZGUsXG4gICAgYmV0QW1vdW50U29sOiByb3VuZDQoYW1vdW50U29sKSxcbiAgICBleHBlY3RlZFBheW91dFNvbDogcm91bmQ0KGV4cGVjdGVkUGF5b3V0U29sKSxcbiAgICBwb3RlbnRpYWxQcm9maXRTb2w6IHJvdW5kNChwb3RlbnRpYWxQcm9maXRTb2wpLFxuICAgIGltcGxpZWRPZGRzOiByb3VuZDIoaW1wbGllZE9kZHMpLFxuICAgIGRlY2ltYWxPZGRzOiByb3VuZDIoZGVjaW1hbE9kZHMpLFxuICAgIGZlZVNvbDogcm91bmQ0KGZlZVNvbCksXG4gICAgZmVlQnBzOiBtYXJrZXQucGxhdGZvcm1GZWVCcHMsXG4gICAgbmV3WWVzUG9vbFNvbDogcm91bmQ0KG5ld1llc1Bvb2xTb2wpLFxuICAgIG5ld05vUG9vbFNvbDogcm91bmQ0KG5ld05vUG9vbFNvbCksXG4gICAgY3VycmVudFllc1BlcmNlbnQ6IG1hcmtldC55ZXNQZXJjZW50LFxuICAgIGN1cnJlbnROb1BlcmNlbnQ6IG1hcmtldC5ub1BlcmNlbnQsXG4gICAgbmV3WWVzUGVyY2VudDogcm91bmQyKG5ld1llc1BlcmNlbnQpLFxuICAgIG5ld05vUGVyY2VudDogcm91bmQyKG5ld05vUGVyY2VudCksXG4gIH07XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlIHF1b3RlIHdpdGggYWRkaXRpb25hbCBtYXJrZXQgZGF0YSBmb3IgdHJhbnNhY3Rpb24gYnVpbGRpbmdcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFF1b3RlV2l0aE1hcmtldERhdGEoXG4gIG1hcmtldFB1YmtleTogc3RyaW5nLFxuICBzaWRlOiAnWWVzJyB8ICdObycsXG4gIGFtb3VudFNvbDogbnVtYmVyXG4pOiBQcm9taXNlPHtcbiAgcXVvdGU6IFF1b3RlO1xuICBtYXJrZXRJZD86IGJpZ2ludDtcbiAgYWNjZXNzR2F0ZT86IG51bWJlcjtcbn0+IHtcbiAgY29uc3QgcXVvdGUgPSBhd2FpdCBnZXRRdW90ZShtYXJrZXRQdWJrZXksIHNpZGUsIGFtb3VudFNvbCk7XG5cbiAgaWYgKCFxdW90ZS52YWxpZCkge1xuICAgIHJldHVybiB7IHF1b3RlIH07XG4gIH1cblxuICAvLyBHZXQgYWRkaXRpb25hbCBtYXJrZXQgZGF0YSBmb3IgdHggYnVpbGRpbmdcbiAgY29uc3QgbWFya2V0RGF0YSA9IGF3YWl0IGdldE1hcmtldEZvckJldHRpbmcobWFya2V0UHVia2V5KTtcblxuICBpZiAoIW1hcmtldERhdGEpIHtcbiAgICByZXR1cm4geyBxdW90ZSB9O1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBxdW90ZSxcbiAgICBtYXJrZXRJZDogbWFya2V0RGF0YS5tYXJrZXRJZCxcbiAgICBhY2Nlc3NHYXRlOiBtYXJrZXREYXRhLmFjY2Vzc0dhdGUsXG4gIH07XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBIRUxQRVJTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5mdW5jdGlvbiByb3VuZDIobjogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIE1hdGgucm91bmQobiAqIDEwMCkgLyAxMDA7XG59XG5cbmZ1bmN0aW9uIHJvdW5kNChuOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gTWF0aC5yb3VuZChuICogMTAwMDApIC8gMTAwMDA7XG59XG4iXX0=