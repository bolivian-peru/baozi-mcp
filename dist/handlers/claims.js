/**
 * Claims Handler - Winnings, Refunds, Affiliate & Creator Claims
 */
import { Connection, PublicKey } from '@solana/web3.js';
import bs58 from 'bs58';
import { PROGRAM_ID, RPC_ENDPOINT, DISCRIMINATORS, lamportsToSol, SEEDS, } from '../config.js';
import { getMarket } from './markets.js';
import { getPositions } from './positions.js';
// =============================================================================
// HELPERS
// =============================================================================
/**
 * Derive market PDA from market_id
 */
function deriveMarketPda(marketId) {
    const marketIdBigInt = BigInt(marketId);
    const marketIdBuffer = Buffer.alloc(8);
    marketIdBuffer.writeBigUInt64LE(marketIdBigInt);
    const [pda] = PublicKey.findProgramAddressSync([Buffer.from('market'), marketIdBuffer], PROGRAM_ID);
    return pda.toBase58();
}
// =============================================================================
// CLAIMABLE POSITIONS
// =============================================================================
/**
 * Get all claimable positions for a wallet
 * Checks which positions can be claimed (winnings or refunds)
 */
export async function getClaimablePositions(walletAddress) {
    const positions = await getPositions(walletAddress);
    const claimable = [];
    let winningsTotal = 0;
    let refundsTotal = 0;
    let alreadyClaimed = 0;
    for (const position of positions) {
        if (position.claimed) {
            alreadyClaimed++;
            continue;
        }
        // Derive market PDA from market_id
        const marketPda = deriveMarketPda(position.marketId);
        // Fetch market to check status
        const market = await getMarket(marketPda);
        if (!market)
            continue;
        // Get the bet amount for the winning side
        const yesAmount = position.yesAmountSol;
        const noAmount = position.noAmountSol;
        const totalBet = yesAmount + noAmount;
        let claimType = null;
        let estimatedPayout = 0;
        let winningSide = null;
        if (market.status === 'Resolved') {
            // Check if user bet on the winning side
            if (market.winningOutcome === 'Yes' && yesAmount > 0) {
                winningSide = 'Yes';
                claimType = 'winnings';
                const totalPool = market.yesPoolSol + market.noPoolSol;
                if (market.yesPoolSol > 0) {
                    const share = yesAmount / market.yesPoolSol;
                    const grossPayout = share * totalPool;
                    const profit = grossPayout - yesAmount;
                    const fee = profit > 0 ? (profit * market.platformFeeBps) / 10000 : 0;
                    estimatedPayout = grossPayout - fee;
                }
                winningsTotal += estimatedPayout;
            }
            else if (market.winningOutcome === 'No' && noAmount > 0) {
                winningSide = 'No';
                claimType = 'winnings';
                const totalPool = market.yesPoolSol + market.noPoolSol;
                if (market.noPoolSol > 0) {
                    const share = noAmount / market.noPoolSol;
                    const grossPayout = share * totalPool;
                    const profit = grossPayout - noAmount;
                    const fee = profit > 0 ? (profit * market.platformFeeBps) / 10000 : 0;
                    estimatedPayout = grossPayout - fee;
                }
                winningsTotal += estimatedPayout;
            }
            else if (market.winningOutcome === null) {
                // Invalid/Draw - refund all bets
                claimType = 'refund';
                estimatedPayout = totalBet;
                winningSide = yesAmount > noAmount ? 'Yes' : 'No';
                refundsTotal += estimatedPayout;
            }
            // Loser - nothing to claim
        }
        else if (market.status === 'Cancelled') {
            // Cancelled - full refund of all bets
            claimType = 'cancelled';
            estimatedPayout = totalBet;
            winningSide = yesAmount > noAmount ? 'Yes' : 'No';
            refundsTotal += estimatedPayout;
        }
        if (claimType && winningSide) {
            claimable.push({
                positionPda: position.publicKey,
                marketPda,
                marketQuestion: market.question,
                side: winningSide,
                betAmountSol: winningSide === 'Yes' ? yesAmount : noAmount,
                claimType,
                estimatedPayoutSol: round4(estimatedPayout),
                marketStatus: market.status,
                marketOutcome: market.winningOutcome,
            });
        }
    }
    return {
        wallet: walletAddress,
        totalClaimableSol: round4(winningsTotal + refundsTotal),
        winningsClaimableSol: round4(winningsTotal),
        refundsClaimableSol: round4(refundsTotal),
        claimablePositions: claimable,
        alreadyClaimedCount: alreadyClaimed,
    };
}
// =============================================================================
// AFFILIATE INFO
// =============================================================================
/**
 * Decode Affiliate account
 * Affiliate struct:
 * - discriminator (8)
 * - owner (Pubkey, 32)
 * - code (String: 4 + len)
 * - total_earned (u64, 8)
 * - total_claimed (u64, 8)
 * - referral_count (u64, 8)
 * - is_active (bool, 1)
 * - bump (u8, 1)
 */
function decodeAffiliate(data, pubkey) {
    try {
        let offset = 8; // Skip discriminator
        const owner = new PublicKey(data.slice(offset, offset + 32));
        offset += 32;
        const codeLen = data.readUInt32LE(offset);
        offset += 4;
        const code = data.slice(offset, offset + codeLen).toString('utf8');
        offset += codeLen;
        const totalEarned = data.readBigUInt64LE(offset);
        offset += 8;
        const totalClaimed = data.readBigUInt64LE(offset);
        offset += 8;
        const referralCount = data.readBigUInt64LE(offset);
        offset += 8;
        const isActive = data.readUInt8(offset) === 1;
        return {
            affiliatePda: pubkey.toBase58(),
            owner: owner.toBase58(),
            code,
            totalEarnedSol: round4(lamportsToSol(totalEarned)),
            unclaimedSol: round4(lamportsToSol(totalEarned - totalClaimed)),
            referralCount: Number(referralCount),
            isActive,
        };
    }
    catch {
        return null;
    }
}
/**
 * Get affiliate info by code
 */
export async function getAffiliateByCode(code) {
    const connection = new Connection(RPC_ENDPOINT, 'confirmed');
    // Derive affiliate PDA from code
    const [affiliatePda] = PublicKey.findProgramAddressSync([SEEDS.AFFILIATE, Buffer.from(code)], PROGRAM_ID);
    try {
        const account = await connection.getAccountInfo(affiliatePda);
        if (!account)
            return null;
        return decodeAffiliate(account.data, affiliatePda);
    }
    catch {
        return null;
    }
}
/**
 * Get affiliate info by owner wallet
 */
export async function getAffiliateByOwner(walletAddress) {
    const connection = new Connection(RPC_ENDPOINT, 'confirmed');
    const accounts = await connection.getProgramAccounts(PROGRAM_ID, {
        filters: [
            {
                memcmp: {
                    offset: 0,
                    bytes: bs58.encode(DISCRIMINATORS.AFFILIATE),
                },
            },
            {
                memcmp: {
                    offset: 8, // After discriminator
                    bytes: walletAddress,
                },
            },
        ],
    });
    const affiliates = [];
    for (const { account, pubkey } of accounts) {
        const affiliate = decodeAffiliate(account.data, pubkey);
        if (affiliate) {
            affiliates.push(affiliate);
        }
    }
    return affiliates;
}
// =============================================================================
// HELPERS
// =============================================================================
function round4(n) {
    return Math.round(n * 10000) / 10000;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xhaW1zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2hhbmRsZXJzL2NsYWltcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUNILE9BQU8sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEQsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sRUFDTCxVQUFVLEVBQ1YsWUFBWSxFQUNaLGNBQWMsRUFDZCxhQUFhLEVBQ2IsS0FBSyxHQUNOLE1BQU0sY0FBYyxDQUFDO0FBQ3RCLE9BQU8sRUFBRSxTQUFTLEVBQVUsTUFBTSxjQUFjLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBNEN4RCxnRkFBZ0Y7QUFDaEYsVUFBVTtBQUNWLGdGQUFnRjtBQUVoRjs7R0FFRztBQUNILFNBQVMsZUFBZSxDQUFDLFFBQWdCO0lBQ3ZDLE1BQU0sY0FBYyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN4QyxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNoRCxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDLHNCQUFzQixDQUM1QyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsY0FBYyxDQUFDLEVBQ3ZDLFVBQVUsQ0FDWCxDQUFDO0lBQ0YsT0FBTyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDeEIsQ0FBQztBQUVELGdGQUFnRjtBQUNoRixzQkFBc0I7QUFDdEIsZ0ZBQWdGO0FBRWhGOzs7R0FHRztBQUNILE1BQU0sQ0FBQyxLQUFLLFVBQVUscUJBQXFCLENBQUMsYUFBcUI7SUFDL0QsTUFBTSxTQUFTLEdBQUcsTUFBTSxZQUFZLENBQUMsYUFBYSxD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SGFuZGxlciAtIFdpbm5pbmdzLCBSZWZ1bmRzLCBBZmZpbGlhdGUgJiBDcmVhdG9yIENsYWltc1xuICovXG5pbXBvcnQgeyBDb25uZWN0aW9uLCBQdWJsaWNLZXkgfSBmcm9tICdAc29sYW5hL3dlYjMuanMnO1xuaW1wb3J0IGJzNTggZnJvbSAnYnM1OCc7XG5pbXBvcnQge1xuICBQUk9HUkFNX0lELFxuICBSUENfRU5EUE9JTlQsXG4gIERJU0NSSU1JTkFUT1JTLFxuICBsYW1wb3J0c1RvU29sLFxuICBTRUVEUyxcbn0gZnJvbSAnLi4vY29uZmlnLmpzJztcbmltcG9ydCB7IGdldE1hcmtldCwgTWFya2V0IH0gZnJvbSAnLi9tYXJrZXRzLmpzJztcbmltcG9ydCB7IGdldFBvc2l0aW9ucywgUG9zaXRpb24gfSBmcm9tICcuL3Bvc2l0aW9ucy5qcyc7XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBUWVBFU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGludGVyZmFjZSBDbGFpbWFibGVQb3NpdGlvbiB7XG4gIHBvc2l0aW9uUGRhOiBzdHJpbmc7XG4gIG1hcmtldFBkYTogc3RyaW5nO1xuICBtYXJrZXRRdWVzdGlvbjogc3RyaW5nO1xuICBzaWRlOiAnWWVzJyB8ICdObyc7XG4gIGJldEFtb3VudFNvbDogbnVtYmVyO1xuICBjbGFpbVR5cGU6ICd3aW5uaW5ncycgfCAncmVmdW5kJyB8ICdjYW5jZWxsZWQnO1xuICBlc3RpbWF0ZWRQYXlvdXRTb2w6IG51bWJlcjtcbiAgbWFya2V0U3RhdHVzOiBzdHJpbmc7XG4gIG1hcmtldE91dGNvbWU6IHN0cmluZyB8IG51bGw7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2xhaW1TdW1tYXJ5IHtcbiAgd2FsbGV0OiBzdHJpbmc7XG4gIHRvdGFsQ2xhaW1hYmxlU29sOiBudW1iZXI7XG4gIHdpbm5pbmdzQ2xhaW1hYmxlU29sOiBudW1iZXI7XG4gIHJlZnVuZHNDbGFpbWFibGVTb2w6IG51bWJlcjtcbiAgY2xhaW1hYmxlUG9zaXRpb25zOiBDbGFpbWFibGVQb3NpdGlvbltdO1xuICBhbHJlYWR5Q2xhaW1lZENvdW50OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWZmaWxpYXRlSW5mbyB7XG4gIGFmZmlsaWF0ZVBkYTogc3RyaW5nO1xuICBvd25lcjogc3RyaW5nO1xuICBjb2RlOiBzdHJpbmc7XG4gIHRvdGFsRWFybmVkU29sOiBudW1iZXI7XG4gIHVuY2xhaW1lZFNvbDogbnVtYmVyO1xuICByZWZlcnJhbENvdW50OiBudW1iZXI7XG4gIGlzQWN0aXZlOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENyZWF0b3JFYXJuaW5ncyB7XG4gIHdhbGxldDogc3RyaW5nO1xuICB0b3RhbENyZWF0b3JGZWVzU29sOiBudW1iZXI7XG4gIHVuY2xhaW1lZFNvbDogbnVtYmVyO1xuICBtYXJrZXRzQ3JlYXRlZDogbnVtYmVyO1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gSEVMUEVSU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBEZXJpdmUgbWFya2V0IFBEQSBmcm9tIG1hcmtldF9pZFxuICovXG5mdW5jdGlvbiBkZXJpdmVNYXJrZXRQZGEobWFya2V0SWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IG1hcmtldElkQmlnSW50ID0gQmlnSW50KG1hcmtldElkKTtcbiAgY29uc3QgbWFya2V0SWRCdWZmZXIgPSBCdWZmZXIuYWxsb2MoOCk7XG4gIG1hcmtldElkQnVmZmVyLndyaXRlQmlnVUludDY0TEUobWFya2V0SWRCaWdJbnQpO1xuICBjb25zdCBbcGRhXSA9IFB1YmxpY0tleS5maW5kUHJvZ3JhbUFkZHJlc3NTeW5jKFxuICAgIFtCdWZmZXIuZnJvbSgnbWFya2V0JyksIG1hcmtldElkQnVmZmVyXSxcbiAgICBQUk9HUkFNX0lEXG4gICk7XG4gIHJldHVybiBwZGEudG9CYXNlNTgoKTtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIENMQUlNQUJMRSBQT1NJVElPTlNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogR2V0IGFsbCBjbGFpbWFibGUgcG9zaXRpb25zIGZvciBhIHdhbGxldFxuICogQ2hlY2tzIHdoaWNoIHBvc2l0aW9ucyBjYW4gYmUgY2xhaW1lZCAod2lubmluZ3Mgb3IgcmVmdW5kcylcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENsYWltYWJsZVBvc2l0aW9ucyh3YWxsZXRBZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPENsYWltU3VtbWFyeT4ge1xuICBjb25zdCBwb3NpdGlvbnMgPSBhd2FpdCBnZXRQb3NpdGlvbnMod2FsbGV0QWRkcmVzcyk7XG5cbiAgY29uc3QgY2xhaW1hYmxlOiBDbGFpbWFibGVQb3NpdGlvbltdID0gW107XG4gIGxldCB3aW5uaW5nc1RvdGFsID0gMDtcbiAgbGV0IHJlZnVuZHNUb3RhbCA9IDA7XG4gIGxldCBhbHJlYWR5Q2xhaW1lZCA9IDA7XG5cbiAgZm9yIChjb25zdCBwb3NpdGlvbiBvZiBwb3NpdGlvbnMpIHtcbiAgICBpZiAocG9zaXRpb24uY2xhaW1lZCkge1xuICAgICAgYWxyZWFkeUNsYWltZWQrKztcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIC8vIERlcml2ZSBtYXJrZXQgUERBIGZyb20gbWFya2V0X2lkXG4gICAgY29uc3QgbWFya2V0UGRhID0gZGVyaXZlTWFya2V0UGRhKHBvc2l0aW9uLm1hcmtldElkKTtcblxuICAgIC8vIEZldGNoIG1hcmtldCB0byBjaGVjayBzdGF0dXNcbiAgICBjb25zdCBtYXJrZXQgPSBhd2FpdCBnZXRNYXJrZXQobWFya2V0UGRhKTtcbiAgICBpZiAoIW1hcmtldCkgY29udGludWU7XG5cbiAgICAvLyBHZXQgdGhlIGJldCBhbW91bnQgZm9yIHRoZSB3aW5uaW5nIHNpZGVcbiAgICBjb25zdCB5ZXNBbW91bnQgPSBwb3NpdGlvbi55ZXNBbW91bnRTb2w7XG4gICAgY29uc3Qgbm9BbW91bnQgPSBwb3NpdGlvbi5ub0Ftb3VudFNvbDtcbiAgICBjb25zdCB0b3RhbEJldCA9IHllc0Ftb3VudCArIG5vQW1vdW50O1xuXG4gICAgbGV0IGNsYWltVHlwZTogJ3dpbm5pbmdzJyB8ICdyZWZ1bmQnIHwgJ2NhbmNlbGxlZCcgfCBudWxsID0gbnVsbDtcbiAgICBsZXQgZXN0aW1hdGVkUGF5b3V0ID0gMDtcbiAgICBsZXQgd2lubmluZ1NpZGU6ICdZZXMnIHwgJ05vJyB8IG51bGwgPSBudWxsO1xuXG4gICAgaWYgKG1hcmtldC5zdGF0dXMgPT09ICdSZXNvbHZlZCcpIHtcbiAgICAgIC8vIENoZWNrIGlmIHVzZXIgYmV0IG9uIHRoZSB3aW5uaW5nIHNpZGVcbiAgICAgIGlmIChtYXJrZXQud2lubmluZ091dGNvbWUgPT09ICdZZXMnICYmIHllc0Ftb3VudCA+IDApIHtcbiAgICAgICAgd2lubmluZ1NpZGUgPSAnWWVzJztcbiAgICAgICAgY2xhaW1UeXBlID0gJ3dpbm5pbmdzJztcbiAgICAgICAgY29uc3QgdG90YWxQb29sID0gbWFya2V0Lnllc1Bvb2xTb2wgKyBtYXJrZXQubm9Qb29sU29sO1xuICAgICAgICBpZiAobWFya2V0Lnllc1Bvb2xTb2wgPiAwKSB7XG4gICAgICAgICAgY29uc3Qgc2hhcmUgPSB5ZXNBbW91bnQgLyBtYXJrZXQueWVzUG9vbFNvbDtcbiAgICAgICAgICBjb25zdCBncm9zc1BheW91dCA9IHNoYXJlICogdG90YWxQb29sO1xuICAgICAgICAgIGNvbnN0IHByb2ZpdCA9IGdyb3NzUGF5b3V0IC0geWVzQW1vdW50O1xuICAgICAgICAgIGNvbnN0IGZlZSA9IHByb2ZpdCA+IDAgPyAocHJvZml0ICogbWFya2V0LnBsYXRmb3JtRmVlQnBzKSAvIDEwMDAwIDogMDtcbiAgICAgICAgICBlc3RpbWF0ZWRQYXlvdXQgPSBncm9zc1BheW91dCAtIGZlZTtcbiAgICAgICAgfVxuICAgICAgICB3aW5uaW5nc1RvdGFsICs9IGVzdGltYXRlZFBheW91dDtcbiAgICAgIH0gZWxzZSBpZiAobWFya2V0Lndpbm5pbmdPdXRjb21lID09PSAnTm8nICYmIG5vQW1vdW50ID4gMCkge1xuICAgICAgICB3aW5uaW5nU2lkZSA9ICdObyc7XG4gICAgICAgIGNsYWltVHlwZSA9ICd3aW5uaW5ncyc7XG4gICAgICAgIGNvbnN0IHRvdGFsUG9vbCA9IG1hcmtldC55ZXNQb29sU29sICsgbWFya2V0Lm5vUG9vbFNvbDtcbiAgICAgICAgaWYgKG1hcmtldC5ub1Bvb2xTb2wgPiAwKSB7XG4gICAgICAgICAgY29uc3Qgc2hhcmUgPSBub0Ftb3VudCAvIG1hcmtldC5ub1Bvb2xTb2w7XG4gICAgICAgICAgY29uc3QgZ3Jvc3NQYXlvdXQgPSBzaGFyZSAqIHRvdGFsUG9vbDtcbiAgICAgICAgICBjb25zdCBwcm9maXQgPSBncm9zc1BheW91dCAtIG5vQW1vdW50O1xuICAgICAgICAgIGNvbnN0IGZlZSA9IHByb2ZpdCA+IDAgPyAocHJvZml0ICogbWFya2V0LnBsYXRmb3JtRmVlQnBzKSAvIDEwMDAwIDogMDtcbiAgICAgICAgICBlc3RpbWF0ZWRQYXlvdXQgPSBncm9zc1BheW91dCAtIGZlZTtcbiAgICAgICAgfVxuICAgICAgICB3aW5uaW5nc1RvdGFsICs9IGVzdGltYXRlZFBheW91dDtcbiAgICAgIH0gZWxzZSBpZiAobWFya2V0Lndpbm5pbmdPdXRjb21lID09PSBudWxsKSB7XG4gICAgICAgIC8vIEludmFsaWQvRHJhdyAtIHJlZnVuZCBhbGwgYmV0c1xuICAgICAgICBjbGFpbVR5cGUgPSAncmVmdW5kJztcbiAgICAgICAgZXN0aW1hdGVkUGF5b3V0ID0gdG90YWxCZXQ7XG4gICAgICAgIHdpbm5pbmdTaWRlID0geWVzQW1vdW50ID4gbm9BbW91bnQgPyAnWWVzJyA6ICdObyc7XG4gICAgICAgIHJlZnVuZHNUb3RhbCArPSBlc3RpbWF0ZWRQYXlvdXQ7XG4gICAgICB9XG4gICAgICAvLyBMb3NlciAtIG5vdGhpbmcgdG8gY2xhaW1cbiAgICB9IGVsc2UgaWYgKG1hcmtldC5zdGF0dXMgPT09ICdDYW5jZWxsZWQnKSB7XG4gICAgICAvLyBDYW5jZWxsZWQgLSBmdWxsIHJlZnVuZCBvZiBhbGwgYmV0c1xuICAgICAgY2xhaW1UeXBlID0gJ2NhbmNlbGxlZCc7XG4gICAgICBlc3RpbWF0ZWRQYXlvdXQgPSB0b3RhbEJldDtcbiAgICAgIHdpbm5pbmdTaWRlID0geWVzQW1vdW50ID4gbm9BbW91bnQgPyAnWWVzJyA6ICdObyc7XG4gICAgICByZWZ1bmRzVG90YWwgKz0gZXN0aW1hdGVkUGF5b3V0O1xuICAgIH1cblxuICAgIGlmIChjbGFpbVR5cGUgJiYgd2lubmluZ1NpZGUpIHtcbiAgICAgIGNsYWltYWJsZS5wdXNoKHtcbiAgICAgICAgcG9zaXRpb25QZGE6IHBvc2l0aW9uLnB1YmxpY0tleSxcbiAgICAgICAgbWFya2V0UGRhLFxuICAgICAgICBtYXJrZXRRdWVzdGlvbjogbWFya2V0LnF1ZXN0aW9uLFxuICAgICAgICBzaWRlOiB3aW5uaW5nU2lkZSxcbiAgICAgICAgYmV0QW1vdW50U29sOiB3aW5uaW5nU2lkZSA9PT0gJ1llcycgPyB5ZXNBbW91bnQgOiBub0Ftb3VudCxcbiAgICAgICAgY2xhaW1UeXBlLFxuICAgICAgICBlc3RpbWF0ZWRQYXlvdXRTb2w6IHJvdW5kNChlc3RpbWF0ZWRQYXlvdXQpLFxuICAgICAgICBtYXJrZXRTdGF0dXM6IG1hcmtldC5zdGF0dXMsXG4gICAgICAgIG1hcmtldE91dGNvbWU6IG1hcmtldC53aW5uaW5nT3V0Y29tZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgd2FsbGV0OiB3YWxsZXRBZGRyZXNzLFxuICAgIHRvdGFsQ2xhaW1hYmxlU29sOiByb3VuZDQod2lubmluZ3NUb3RhbCArIHJlZnVuZHNUb3RhbCksXG4gICAgd2lubmluZ3NDbGFpbWFibGVTb2w6IHJvdW5kNCh3aW5uaW5nc1RvdGFsKSxcbiAgICByZWZ1bmRzQ2xhaW1hYmxlU29sOiByb3VuZDQocmVmdW5kc1RvdGFsKSxcbiAgICBjbGFpbWFibGVQb3NpdGlvbnM6IGNsYWltYWJsZSxcbiAgICBhbHJlYWR5Q2xhaW1lZENvdW50OiBhbHJlYWR5Q2xhaW1lZCxcbiAgfTtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEFGRklMSUFURSBJTkZPXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIERlY29kZSBBZmZpbGlhdGUgYWNjb3VudFxuICogQWZmaWxpYXRlIHN0cnVjdDpcbiAqIC0gZGlzY3JpbWluYXRvciAoOClcbiAqIC0gb3duZXIgKFB1YmtleSwgMzIpXG4gKiAtIGNvZGUgKFN0cmluZzogNCArIGxlbilcbiAqIC0gdG90YWxfZWFybmVkICh1NjQsIDgpXG4gKiAtIHRvdGFsX2NsYWltZWQgKHU2NCwgOClcbiAqIC0gcmVmZXJyYWxfY291bnQgKHU2NCwgOClcbiAqIC0gaXNfYWN0aXZlIChib29sLCAxKVxuICogLSBidW1wICh1OCwgMSlcbiAqL1xuZnVuY3Rpb24gZGVjb2RlQWZmaWxpYXRlKGRhdGE6IEJ1ZmZlciwgcHVia2V5OiBQdWJsaWNLZXkpOiBBZmZpbGlhdGVJbmZvIHwgbnVsbCB7XG4gIHRyeSB7XG4gICAgbGV0IG9mZnNldCA9IDg7IC8vIFNraXAgZGlzY3JpbWluYXRvclxuXG4gICAgY29uc3Qgb3duZXIgPSBuZXcgUHVibGljS2V5KGRhdGEuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyAzMikpO1xuICAgIG9mZnNldCArPSAzMjtcblxuICAgIGNvbnN0IGNvZGVMZW4gPSBkYXRhLnJlYWRVSW50MzJMRShvZmZzZXQpO1xuICAgIG9mZnNldCArPSA0O1xuICAgIGNvbnN0IGNvZGUgPSBkYXRhLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgY29kZUxlbikudG9TdHJpbmcoJ3V0ZjgnKTtcbiAgICBvZmZzZXQgKz0gY29kZUxlbjtcblxuICAgIGNvbnN0IHRvdGFsRWFybmVkID0gZGF0YS5yZWFkQmlnVUludDY0TEUob2Zmc2V0KTtcbiAgICBvZmZzZXQgKz0gODtcblxuICAgIGNvbnN0IHRvdGFsQ2xhaW1lZCA9IGRhdGEucmVhZEJpZ1VJbnQ2NExFKG9mZnNldCk7XG4gICAgb2Zmc2V0ICs9IDg7XG5cbiAgICBjb25zdCByZWZlcnJhbENvdW50ID0gZGF0YS5yZWFkQmlnVUludDY0TEUob2Zmc2V0KTtcbiAgICBvZmZzZXQgKz0gODtcblxuICAgIGNvbnN0IGlzQWN0aXZlID0gZGF0YS5yZWFkVUludDgob2Zmc2V0KSA9PT0gMTtcblxuICAgIHJldHVybiB7XG4gICAgICBhZmZpbGlhdGVQZGE6IHB1YmtleS50b0Jhc2U1OCgpLFxuICAgICAgb3duZXI6IG93bmVyLnRvQmFzZTU4KCksXG4gICAgICBjb2RlLFxuICAgICAgdG90YWxFYXJuZWRTb2w6IHJvdW5kNChsYW1wb3J0c1RvU29sKHRvdGFsRWFybmVkKSksXG4gICAgICB1bmNsYWltZWRTb2w6IHJvdW5kNChsYW1wb3J0c1RvU29sKHRvdGFsRWFybmVkIC0gdG90YWxDbGFpbWVkKSksXG4gICAgICByZWZlcnJhbENvdW50OiBOdW1iZXIocmVmZXJyYWxDb3VudCksXG4gICAgICBpc0FjdGl2ZSxcbiAgICB9O1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBhZmZpbGlhdGUgaW5mbyBieSBjb2RlXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBZmZpbGlhdGVCeUNvZGUoY29kZTogc3RyaW5nKTogUHJvbWlzZTxBZmZpbGlhdGVJbmZvIHwgbnVsbD4ge1xuICBjb25zdCBjb25uZWN0aW9uID0gbmV3IENvbm5lY3Rpb24oUlBDX0VORFBPSU5ULCAnY29uZmlybWVkJyk7XG5cbiAgLy8gRGVyaXZlIGFmZmlsaWF0ZSBQREEgZnJvbSBjb2RlXG4gIGNvbnN0IFthZmZpbGlhdGVQZGFdID0gUHVibGljS2V5LmZpbmRQcm9ncmFtQWRkcmVzc1N5bmMoXG4gICAgW1NFRURTLkFGRklMSUFURSwgQnVmZmVyLmZyb20oY29kZSldLFxuICAgIFBST0dSQU1fSURcbiAgKTtcblxuICB0cnkge1xuICAgIGNvbnN0IGFjY291bnQgPSBhd2FpdCBjb25uZWN0aW9uLmdldEFjY291bnRJbmZvKGFmZmlsaWF0ZVBkYSk7XG4gICAgaWYgKCFhY2NvdW50KSByZXR1cm4gbnVsbDtcbiAgICByZXR1cm4gZGVjb2RlQWZmaWxpYXRlKGFjY291bnQuZGF0YSBhcyBCdWZmZXIsIGFmZmlsaWF0ZVBkYSk7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbi8qKlxuICogR2V0IGFmZmlsaWF0ZSBpbmZvIGJ5IG93bmVyIHdhbGxldFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QWZmaWxpYXRlQnlPd25lcih3YWxsZXRBZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPEFmZmlsaWF0ZUluZm9bXT4ge1xuICBjb25zdCBjb25uZWN0aW9uID0gbmV3IENvbm5lY3Rpb24oUlBDX0VORFBPSU5ULCAnY29uZmlybWVkJyk7XG5cbiAgY29uc3QgYWNjb3VudHMgPSBhd2FpdCBjb25uZWN0aW9uLmdldFByb2dyYW1BY2NvdW50cyhQUk9HUkFNX0lELCB7XG4gICAgZmlsdGVyczogW1xuICAgICAge1xuICAgICAgICBtZW1jbXA6IHtcbiAgICAgICAgICBvZmZzZXQ6IDAsXG4gICAgICAgICAgYnl0ZXM6IGJzNTguZW5jb2RlKERJU0NSSU1JTkFUT1JTLkFGRklMSUFURSksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBtZW1jbXA6IHtcbiAgICAgICAgICBvZmZzZXQ6IDgsIC8vIEFmdGVyIGRpc2NyaW1pbmF0b3JcbiAgICAgICAgICBieXRlczogd2FsbGV0QWRkcmVzcyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgXSxcbiAgfSk7XG5cbiAgY29uc3QgYWZmaWxpYXRlczogQWZmaWxpYXRlSW5mb1tdID0gW107XG4gIGZvciAoY29uc3QgeyBhY2NvdW50LCBwdWJrZXkgfSBvZiBhY2NvdW50cykge1xuICAgIGNvbnN0IGFmZmlsaWF0ZSA9IGRlY29kZUFmZmlsaWF0ZShhY2NvdW50LmRhdGEgYXMgQnVmZmVyLCBwdWJrZXkpO1xuICAgIGlmIChhZmZpbGlhdGUpIHtcbiAgICAgIGFmZmlsaWF0ZXMucHVzaChhZmZpbGlhdGUpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBhZmZpbGlhdGVzO1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gSEVMUEVSU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZnVuY3Rpb24gcm91bmQ0KG46IG51bWJlcik6IG51bWJlciB7XG4gIHJldHVybiBNYXRoLnJvdW5kKG4gKiAxMDAwMCkgLyAxMDAwMDtcbn1cbiJdfQ==