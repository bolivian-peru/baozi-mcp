/**
 * Resolution Handler - Market Resolution Status & Disputes
 */
import { Connection, PublicKey } from '@solana/web3.js';
import bs58 from 'bs58';
import { PROGRAM_ID, RPC_ENDPOINT, DISCRIMINATORS, SEEDS, } from '../config.js';
import { getMarket } from './markets.js';
// =============================================================================
// RESOLUTION STATUS
// =============================================================================
/**
 * Get detailed resolution status for a market
 */
export async function getResolutionStatus(marketPda) {
    const market = await getMarket(marketPda);
    if (!market)
        return null;
    const now = new Date();
    const closingTime = new Date(market.closingTime);
    const resolutionTime = new Date(market.resolutionTime);
    // Check resolution window
    const canBeResolved = now > closingTime && market.status === 'Closed';
    const resolutionWindowOpen = now > closingTime && now < resolutionTime;
    // Check dispute status
    const disputeMeta = await getDisputeMeta(marketPda);
    const isDisputed = disputeMeta !== null && !disputeMeta.resolved;
    // Determine resolution mode from market data
    let resolutionMode = 'Creator';
    // This would need to be parsed from market data
    return {
        marketPda,
        marketQuestion: market.question,
        status: market.status,
        isResolved: market.status === 'Resolved',
        winningOutcome: market.winningOutcome,
        proposedOutcome: null, // Would need to track proposed but not finalized
        closingTime: market.closingTime,
        resolutionTime: market.resolutionTime,
        canBeResolved,
        resolutionWindowOpen,
        isDisputed,
        disputeDeadline: disputeMeta?.deadline || null,
        disputeReason: disputeMeta?.reason || null,
        councilSize: 0, // Would parse from market
        councilVotesYes: 0,
        councilVotesNo: 0,
        councilThreshold: 0,
        resolutionMode,
    };
}
/**
 * Get dispute meta for a market (if exists)
 */
async function getDisputeMeta(marketPda) {
    const connection = new Connection(RPC_ENDPOINT, 'confirmed');
    try {
        const marketPubkey = new PublicKey(marketPda);
        // Derive dispute_meta PDA
        const [disputeMetaPda] = PublicKey.findProgramAddressSync([SEEDS.DISPUTE_META, marketPubkey.toBuffer()], PROGRAM_ID);
        const account = await connection.getAccountInfo(disputeMetaPda);
        if (!account)
            return null;
        // Decode DisputeMeta
        // DisputeMeta struct:
        // - discriminator (8)
        // - market (Pubkey, 32)
        // - disputer (Pubkey, 32)
        // - reason (String: 4 + len)
        // - proposed_outcome (Option<bool>: 1 + 0/1)
        // - created_at (i64, 8)
        // - deadline (i64, 8)
        // - resolved (bool, 1)
        const data = account.data;
        let offset = 8;
        const market = new PublicKey(data.slice(offset, offset + 32));
        offset += 32;
        const disputer = new PublicKey(data.slice(offset, offset + 32));
        offset += 32;
        const reasonLen = data.readUInt32LE(offset);
        offset += 4;
        const reason = data.slice(offset, offset + reasonLen).toString('utf8');
        offset += reasonLen;
        const hasProposedOutcome = data.readUInt8(offset);
        offset += 1;
        let proposedOutcome = null;
        if (hasProposedOutcome === 1) {
            proposedOutcome = data.readUInt8(offset) === 1;
            offset += 1;
        }
        const createdAt = data.readBigInt64LE(offset);
        offset += 8;
        const deadline = data.readBigInt64LE(offset);
        offset += 8;
        const resolved = data.readUInt8(offset) === 1;
        return {
            publicKey: disputeMetaPda.toBase58(),
            marketPda: market.toBase58(),
            disputer: disputer.toBase58(),
            reason,
            proposedOutcome,
            createdAt: new Date(Number(createdAt) * 1000).toISOString(),
            deadline: new Date(Number(deadline) * 1000).toISOString(),
            resolved,
        };
    }
    catch {
        return null;
    }
}
/**
 * Get all disputed markets
 */
export async function getDisputedMarkets() {
    const connection = new Connection(RPC_ENDPOINT, 'confirmed');
    const accounts = await connection.getProgramAccounts(PROGRAM_ID, {
        filters: [
            {
                memcmp: {
                    offset: 0,
                    bytes: bs58.encode(DISCRIMINATORS.DISPUTE_META),
                },
            },
        ],
    });
    const disputes = [];
    for (const { account, pubkey } of accounts) {
        try {
            const data = account.data;
            let offset = 8;
            const market = new PublicKey(data.slice(offset, offset + 32));
            offset += 32;
            const disputer = new PublicKey(data.slice(offset, offset + 32));
            offset += 32;
            const reasonLen = data.readUInt32LE(offset);
            offset += 4;
            const reason = data.slice(offset, offset + reasonLen).toString('utf8');
            offset += reasonLen;
            const hasProposedOutcome = data.readUInt8(offset);
            offset += 1;
            let proposedOutcome = null;
            if (hasProposedOutcome === 1) {
                proposedOutcome = data.readUInt8(offset) === 1;
                offset += 1;
            }
            const createdAt = data.readBigInt64LE(offset);
            offset += 8;
            const deadline = data.readBigInt64LE(offset);
            offset += 8;
            const resolved = data.readUInt8(offset) === 1;
            if (!resolved) {
                disputes.push({
                    publicKey: pubkey.toBase58(),
                    marketPda: market.toBase58(),
                    disputer: disputer.toBase58(),
                    reason,
                    proposedOutcome,
                    createdAt: new Date(Number(createdAt) * 1000).toISOString(),
                    deadline: new Date(Number(deadline) * 1000).toISOString(),
                    resolved,
                });
            }
        }
        catch {
            // Skip malformed
        }
    }
    return disputes;
}
/**
 * Get markets pending resolution (closed but not resolved)
 */
export async function getMarketsAwaitingResolution() {
    const connection = new Connection(RPC_ENDPOINT, 'confirmed');
    // Get all markets with status = Closed (1)
    const accounts = await connection.getProgramAccounts(PROGRAM_ID, {
        filters: [
            {
                memcmp: {
                    offset: 0,
                    bytes: bs58.encode(DISCRIMINATORS.MARKET),
                },
            },
        ],
    });
    const markets = [];
    for (const { account, pubkey } of accounts) {
        const market = await getMarket(pubkey.toBase58());
        if (market && market.status === 'Closed') {
            markets.push(market);
        }
    }
    return markets;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x1dGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oYW5kbGVycy9yZXNvbHV0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBQ0gsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN4RCxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUNMLFVBQVUsRUFDVixZQUFZLEVBQ1osY0FBYyxFQUNkLEtBQUssR0FDTixNQUFNLGNBQWMsQ0FBQztBQUN0QixPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sY0FBYyxDQUFDO0FBZ0RqRCxnRkFBZ0Y7QUFDaEYsb0JBQW9CO0FBQ3BCLGdGQUFnRjtBQUVoRjs7R0FFRztBQUNILE1BQU0sQ0FBQyxLQUFLLFVBQVUsbUJBQW1CLENBQUMsU0FBaUI7SUFDekQsTUFBTSxNQUFNLEdBQUcsTUFBTSxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDMUMsSUFBSSxDQUFDLE1BQU07UUFBRSxPQUFPLElBQUksQ0FBQztJQUV6QixNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQ3ZCLE1BQU0sV0FBVyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNqRCxNQUFNLGNBQWMsR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7SUFFdkQsMEJBQTBCO0lBQzFCLE1BQU0sYUFBYSxHQUFHLEdBQUcsR0FBRyxXQUFXLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxRQUFRLENBQUM7SUFDdEUsTUFBTSxvQkFBb0IsR0FBRyxHQUFHLEdBQUcsV0FBVyxJQUFJLEdBQUcsR0FBRyxjQUFjLENBQUM7SUFFdkUsdUJBQXVCO0lBQ3ZCLE1BQU0sV0FBVyxHQUFHLE1BQU0sY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BELE1BQU0sVUFBVSxHQUFHLFdBQVcsS0FBSyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDO0lBRWpFLDZDQUE2QztJQUM3QyxJQUFJLGNBQWMsR0FBK0MsU0FBUyxDQUFDO0lBQzNFLGdEQUFnRDtJQUVoRCxPQUFPO1FBQ0wsU0FBUztRQUNULGNBQWMsRUFBRSxNQUFNLENBQUMsUUFBUTtRQUMvQixNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU07UUFFckIsVUFBVSxFQUFFLE1BQU0sQ0FBQyxNQUFNLEtBQUssVUFBVTtRQUN4QyxjQUFjLEVBQUUsTUFBTSxDQUFDLGNBQWM7UUFDckMsZUFBZSxFQUFFLElBQUksRUFBRSxpREFBaUQ7UUFFeEUsV0FBVyxFQUFFLE1BQU0sQ0FBQyxXQUFXO1FBQy9CLGNBQWMsRUFBRSxNQUFNLENBQUMsY0FBYztRQUNyQyxhQUFhO1FBQ2Isb0JBQW9CO1FBRXBCLFVBQVU7UUFDVixlQUFlLEVBQUUsV0FBVyxFQUFFLFFBQVEsSUFBSSxJQUFJO1FBQzlDLGFBQWEsRUFBRSxXQUFXLEVBQUUsTUFBTSxJQUFJLElBQUk7UUFFMUMsV0FBVyxFQUFFLENBQUMsRUFBRSwwQkFBMEI7UUFDMUMsZUFBZSxFQUFFLENBQUM7UUFDbEIsY0FBYyxFQUFFLENBQUM7UUFDakIsZ0JBQWdCLEVBQUUsQ0FBQztRQUVuQixjQUFjO0tBQ2YsQ0FBQztBQUNKLENBQUM7QUFFRDs7R0FFRztBQUNILEtBQUssVUFBVSxjQUFjLENBQUMsU0FBaUI7SUFDN0MsTUFBTSxVQUFVLEdBQUcsSUFBSSxVQUFVLENBQUMsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBRTdELElBQUksQ0FBQztRQUNILE1BQU0sWUFBWSxHQUFHLElBQUksU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTlDLDBCQUEwQjtRQUMxQixNQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsU0FBUyxDQUFDLHNCQUFzQixDQUN2RCxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQzdDLFVBQVUsQ0FDWCxDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsTUFBTSxVQUFVLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFFMUIscUJBQXFCO1FBQ3JCLHNCQUFzQjtRQUN0QixzQkFBc0I7UUFDdEIsd0JBQXdCO1FBQ3hCLDBCQUEwQjtRQUMxQiw2QkFBNkI7UUFDN0IsNkNBQTZDO1FBQzdDLHdCQUF3QjtRQUN4QixzQkFBc0I7UUFDdEIsdUJBQXVCO1FBRXZCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFjLENBQUM7UUFDcEMsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBRWYsTUFBTSxNQUFNLEdBQUcsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsTUFBTSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDOUQsTUFBTSxJQUFJLEVBQUUsQ0FBQztRQUViLE1BQU0sUUFBUSxHQUFHLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLE1BQU0sR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFFYixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVDLE1BQU0sSUFBSSxDQUFDLENBQUM7UUFDWixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxNQUFNLEdBQUcsU0FBUyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZFLE1BQU0sSUFBSSxTQUFTLENBQUM7UUFFcEIsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xELE1BQU0sSUFBSSxDQUFDLENBQUM7UUFDWixJQUFJLGVBQWUsR0FBbUIsSUFBSSxDQUFDO1FBQzNDLElBQUksa0JBQWtCLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDN0IsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9DLE1BQU0sSUFBSSxDQUFDLENBQUM7UUFDZCxDQUFDO1FBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5QyxNQUFNLElBQUksQ0FBQyxDQUFDO1FBRVosTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM3QyxNQUFNLElBQUksQ0FBQyxDQUFDO1FBRVosTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFOUMsT0FBTztZQUNMLFNBQVMsRUFBRSxjQUFjLENBQUMsUUFBUSxFQUFFO1lBQ3BDLFNBQVMsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFO1lBQzVCLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUSxFQUFFO1lBQzdCLE1BQU07WUFDTixlQUFlO1lBQ2YsU0FBUyxFQUFFLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUU7WUFDM0QsUUFBUSxFQUFFLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUU7WUFDekQsUUFBUTtTQUNULENBQUM7SUFDSixDQUFDO0lBQUMsTUFBTSxDQUFDO1FBQ1AsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQztBQUVEOztHQUVHO0FBQ0gsTUFBTSxDQUFDLEtBQUssVUFBVSxrQkFBa0I7SUFDdEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxVQUFVLENBQUMsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBRTdELE1BQU0sUUFBUSxHQUFHLE1BQU0sVUFBVSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRTtRQUMvRCxPQUFPLEVBQUU7WUFDUDtnQkFDRSxNQUFNLEVBQUU7b0JBQ04sTUFBTSxFQUFFLENBQUM7b0JBQ1QsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQztpQkFDaEQ7YUFDRjtTQUNGO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsTUFBTSxRQUFRLEdBQWtCLEVBQUUsQ0FBQztJQUVuQyxLQUFLLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksUUFBUSxFQUFFLENBQUM7UUFDM0MsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQWMsQ0FBQztZQUNwQyxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7WUFFZixNQUFNLE1BQU0sR0FBRyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxNQUFNLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUM5RCxNQUFNLElBQUksRUFBRSxDQUFDO1lBRWIsTUFBTSxRQUFRLEdBQUcsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsTUFBTSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDaEUsTUFBTSxJQUFJLEVBQUUsQ0FBQztZQUViLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDNUMsTUFBTSxJQUFJLENBQUMsQ0FBQztZQUNaLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLE1BQU0sR0FBRyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDdkUsTUFBTSxJQUFJLFNBQVMsQ0FBQztZQUVwQixNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbEQsTUFBTSxJQUFJLENBQUMsQ0FBQztZQUNaLElBQUksZUFBZSxHQUFtQixJQUFJLENBQUM7WUFDM0MsSUFBSSxrQkFBa0IsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDN0IsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUMvQyxNQUFNLElBQUksQ0FBQyxDQUFDO1lBQ2QsQ0FBQztZQUVELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDOUMsTUFBTSxJQUFJLENBQUMsQ0FBQztZQUVaLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDN0MsTUFBTSxJQUFJLENBQUMsQ0FBQztZQUVaLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRTlDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDZCxRQUFRLENBQUMsSUFBSSxDQUFDO29CQUNaLFNBQVMsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFO29CQUM1QixTQUFTLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRTtvQkFDNUIsUUFBUSxFQUFFLFFBQVEsQ0FBQyxRQUFRLEVBQUU7b0JBQzdCLE1BQU07b0JBQ04sZUFBZTtvQkFDZixTQUFTLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLFdBQVcsRUFBRTtvQkFDM0QsUUFBUSxFQUFFLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUU7b0JBQ3pELFFBQVE7aUJBQ1QsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztRQUNILENBQUM7UUFBQyxNQUFNLENBQUM7WUFDUCxpQkFBaUI7UUFDbkIsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDO0FBRUQ7O0dBRUc7QUFDSCxNQUFNLENBQUMsS0FBSyxVQUFVLDRCQUE0QjtJQUNoRCxNQUFNLFVBQVUsR0FBRyxJQUFJLFVBQVUsQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFFN0QsMkNBQTJDO0lBQzNDLE1BQU0sUUFBUSxHQUFHLE1BQU0sVUFBVSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRTtRQUMvRCxPQUFPLEVBQUU7WUFDUDtnQkFDRSxNQUFNLEVBQUU7b0JBQ04sTUFBTSxFQUFFLENBQUM7b0JBQ1QsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQztpQkFDMUM7YUFDRjtTQUNGO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDO0lBRTdCLEtBQUssTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUMzQyxNQUFNLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUNsRCxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ3pDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdkIsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBSZXNvbHV0aW9uIEhhbmRsZXIgLSBNYXJrZXQgUmVzb2x1dGlvbiBTdGF0dXMgJiBEaXNwdXRlc1xuICovXG5pbXBvcnQgeyBDb25uZWN0aW9uLCBQdWJsaWNLZXkgfSBmcm9tICdAc29sYW5hL3dlYjMuanMnO1xuaW1wb3J0IGJzNTggZnJvbSAnYnM1OCc7XG5pbXBvcnQge1xuICBQUk9HUkFNX0lELFxuICBSUENfRU5EUE9JTlQsXG4gIERJU0NSSU1JTkFUT1JTLFxuICBTRUVEUyxcbn0gZnJvbSAnLi4vY29uZmlnLmpzJztcbmltcG9ydCB7IGdldE1hcmtldCwgTWFya2V0IH0gZnJvbSAnLi9tYXJrZXRzLmpzJztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFRZUEVTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlc29sdXRpb25TdGF0dXMge1xuICBtYXJrZXRQZGE6IHN0cmluZztcbiAgbWFya2V0UXVlc3Rpb246IHN0cmluZztcbiAgc3RhdHVzOiBzdHJpbmc7XG5cbiAgLy8gUmVzb2x1dGlvbiBzdGF0ZVxuICBpc1Jlc29sdmVkOiBib29sZWFuO1xuICB3aW5uaW5nT3V0Y29tZTogc3RyaW5nIHwgbnVsbDtcbiAgcHJvcG9zZWRPdXRjb21lOiBzdHJpbmcgfCBudWxsO1xuXG4gIC8vIFRpbWluZ1xuICBjbG9zaW5nVGltZTogc3RyaW5nO1xuICByZXNvbHV0aW9uVGltZTogc3RyaW5nO1xuICBjYW5CZVJlc29sdmVkOiBib29sZWFuO1xuICByZXNvbHV0aW9uV2luZG93T3BlbjogYm9vbGVhbjtcblxuICAvLyBEaXNwdXRlIHN0YXRlXG4gIGlzRGlzcHV0ZWQ6IGJvb2xlYW47XG4gIGRpc3B1dGVEZWFkbGluZTogc3RyaW5nIHwgbnVsbDtcbiAgZGlzcHV0ZVJlYXNvbjogc3RyaW5nIHwgbnVsbDtcblxuICAvLyBDb3VuY2lsIHZvdGluZyAoaWYgZGlzcHV0ZWQpXG4gIGNvdW5jaWxTaXplOiBudW1iZXI7XG4gIGNvdW5jaWxWb3Rlc1llczogbnVtYmVyO1xuICBjb3VuY2lsVm90ZXNObzogbnVtYmVyO1xuICBjb3VuY2lsVGhyZXNob2xkOiBudW1iZXI7XG5cbiAgLy8gUmVzb2x1dGlvbiBtb2RlXG4gIHJlc29sdXRpb25Nb2RlOiAnQ3JlYXRvcicgfCAnT3JhY2xlJyB8ICdDb3VuY2lsJyB8ICdBZG1pbic7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGlzcHV0ZU1ldGEge1xuICBwdWJsaWNLZXk6IHN0cmluZztcbiAgbWFya2V0UGRhOiBzdHJpbmc7XG4gIGRpc3B1dGVyOiBzdHJpbmc7XG4gIHJlYXNvbjogc3RyaW5nO1xuICBwcm9wb3NlZE91dGNvbWU6IGJvb2xlYW4gfCBudWxsO1xuICBjcmVhdGVkQXQ6IHN0cmluZztcbiAgZGVhZGxpbmU6IHN0cmluZztcbiAgcmVzb2x2ZWQ6IGJvb2xlYW47XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBSRVNPTFVUSU9OIFNUQVRVU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBHZXQgZGV0YWlsZWQgcmVzb2x1dGlvbiBzdGF0dXMgZm9yIGEgbWFya2V0XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRSZXNvbHV0aW9uU3RhdHVzKG1hcmtldFBkYTogc3RyaW5nKTogUHJvbWlzZTxSZXNvbHV0aW9uU3RhdHVzIHwgbnVsbD4ge1xuICBjb25zdCBtYXJrZXQgPSBhd2FpdCBnZXRNYXJrZXQobWFya2V0UGRhKTtcbiAgaWYgKCFtYXJrZXQpIHJldHVybiBudWxsO1xuXG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gIGNvbnN0IGNsb3NpbmdUaW1lID0gbmV3IERhdGUobWFya2V0LmNsb3NpbmdUaW1lKTtcbiAgY29uc3QgcmVzb2x1dGlvblRpbWUgPSBuZXcgRGF0ZShtYXJrZXQucmVzb2x1dGlvblRpbWUpO1xuXG4gIC8vIENoZWNrIHJlc29sdXRpb24gd2luZG93XG4gIGNvbnN0IGNhbkJlUmVzb2x2ZWQgPSBub3cgPiBjbG9zaW5nVGltZSAmJiBtYXJrZXQuc3RhdHVzID09PSAnQ2xvc2VkJztcbiAgY29uc3QgcmVzb2x1dGlvbldpbmRvd09wZW4gPSBub3cgPiBjbG9zaW5nVGltZSAmJiBub3cgPCByZXNvbHV0aW9uVGltZTtcblxuICAvLyBDaGVjayBkaXNwdXRlIHN0YXR1c1xuICBjb25zdCBkaXNwdXRlTWV0YSA9IGF3YWl0IGdldERpc3B1dGVNZXRhKG1hcmtldFBkYSk7XG4gIGNvbnN0IGlzRGlzcHV0ZWQgPSBkaXNwdXRlTWV0YSAhPT0gbnVsbCAmJiAhZGlzcHV0ZU1ldGEucmVzb2x2ZWQ7XG5cbiAgLy8gRGV0ZXJtaW5lIHJlc29sdXRpb24gbW9kZSBmcm9tIG1hcmtldCBkYXRhXG4gIGxldCByZXNvbHV0aW9uTW9kZTogJ0NyZWF0b3InIHwgJ09yYWNsZScgfCAnQ291bmNpbCcgfCAnQWRtaW4nID0gJ0NyZWF0b3InO1xuICAvLyBUaGlzIHdvdWxkIG5lZWQgdG8gYmUgcGFyc2VkIGZyb20gbWFya2V0IGRhdGFcblxuICByZXR1cm4ge1xuICAgIG1hcmtldFBkYSxcbiAgICBtYXJrZXRRdWVzdGlvbjogbWFya2V0LnF1ZXN0aW9uLFxuICAgIHN0YXR1czogbWFya2V0LnN0YXR1cyxcblxuICAgIGlzUmVzb2x2ZWQ6IG1hcmtldC5zdGF0dXMgPT09ICdSZXNvbHZlZCcsXG4gICAgd2lubmluZ091dGNvbWU6IG1hcmtldC53aW5uaW5nT3V0Y29tZSxcbiAgICBwcm9wb3NlZE91dGNvbWU6IG51bGwsIC8vIFdvdWxkIG5lZWQgdG8gdHJhY2sgcHJvcG9zZWQgYnV0IG5vdCBmaW5hbGl6ZWRcblxuICAgIGNsb3NpbmdUaW1lOiBtYXJrZXQuY2xvc2luZ1RpbWUsXG4gICAgcmVzb2x1dGlvblRpbWU6IG1hcmtldC5yZXNvbHV0aW9uVGltZSxcbiAgICBjYW5CZVJlc29sdmVkLFxuICAgIHJlc29sdXRpb25XaW5kb3dPcGVuLFxuXG4gICAgaXNEaXNwdXRlZCxcbiAgICBkaXNwdXRlRGVhZGxpbmU6IGRpc3B1dGVNZXRhPy5kZWFkbGluZSB8fCBudWxsLFxuICAgIGRpc3B1dGVSZWFzb246IGRpc3B1dGVNZXRhPy5yZWFzb24gfHwgbnVsbCxcblxuICAgIGNvdW5jaWxTaXplOiAwLCAvLyBXb3VsZCBwYXJzZSBmcm9tIG1hcmtldFxuICAgIGNvdW5jaWxWb3Rlc1llczogMCxcbiAgICBjb3VuY2lsVm90ZXNObzogMCxcbiAgICBjb3VuY2lsVGhyZXNob2xkOiAwLFxuXG4gICAgcmVzb2x1dGlvbk1vZGUsXG4gIH07XG59XG5cbi8qKlxuICogR2V0IGRpc3B1dGUgbWV0YSBmb3IgYSBtYXJrZXQgKGlmIGV4aXN0cylcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0RGlzcHV0ZU1ldGEobWFya2V0UGRhOiBzdHJpbmcpOiBQcm9taXNlPERpc3B1dGVNZXRhIHwgbnVsbD4ge1xuICBjb25zdCBjb25uZWN0aW9uID0gbmV3IENvbm5lY3Rpb24oUlBDX0VORFBPSU5ULCAnY29uZmlybWVkJyk7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBtYXJrZXRQdWJrZXkgPSBuZXcgUHVibGljS2V5KG1hcmtldFBkYSk7XG5cbiAgICAvLyBEZXJpdmUgZGlzcHV0ZV9tZXRhIFBEQVxuICAgIGNvbnN0IFtkaXNwdXRlTWV0YVBkYV0gPSBQdWJsaWNLZXkuZmluZFByb2dyYW1BZGRyZXNzU3luYyhcbiAgICAgIFtTRUVEUy5ESVNQVVRFX01FVEEsIG1hcmtldFB1YmtleS50b0J1ZmZlcigpXSxcbiAgICAgIFBST0dSQU1fSURcbiAgICApO1xuXG4gICAgY29uc3QgYWNjb3VudCA9IGF3YWl0IGNvbm5lY3Rpb24uZ2V0QWNjb3VudEluZm8oZGlzcHV0ZU1ldGFQZGEpO1xuICAgIGlmICghYWNjb3VudCkgcmV0dXJuIG51bGw7XG5cbiAgICAvLyBEZWNvZGUgRGlzcHV0ZU1ldGFcbiAgICAvLyBEaXNwdXRlTWV0YSBzdHJ1Y3Q6XG4gICAgLy8gLSBkaXNjcmltaW5hdG9yICg4KVxuICAgIC8vIC0gbWFya2V0IChQdWJrZXksIDMyKVxuICAgIC8vIC0gZGlzcHV0ZXIgKFB1YmtleSwgMzIpXG4gICAgLy8gLSByZWFzb24gKFN0cmluZzogNCArIGxlbilcbiAgICAvLyAtIHByb3Bvc2VkX291dGNvbWUgKE9wdGlvbjxib29sPjogMSArIDAvMSlcbiAgICAvLyAtIGNyZWF0ZWRfYXQgKGk2NCwgOClcbiAgICAvLyAtIGRlYWRsaW5lIChpNjQsIDgpXG4gICAgLy8gLSByZXNvbHZlZCAoYm9vbCwgMSlcblxuICAgIGNvbnN0IGRhdGEgPSBhY2NvdW50LmRhdGEgYXMgQnVmZmVyO1xuICAgIGxldCBvZmZzZXQgPSA4O1xuXG4gICAgY29uc3QgbWFya2V0ID0gbmV3IFB1YmxpY0tleShkYXRhLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgMzIpKTtcbiAgICBvZmZzZXQgKz0gMzI7XG5cbiAgICBjb25zdCBkaXNwdXRlciA9IG5ldyBQdWJsaWNLZXkoZGF0YS5zbGljZShvZmZzZXQsIG9mZnNldCArIDMyKSk7XG4gICAgb2Zmc2V0ICs9IDMyO1xuXG4gICAgY29uc3QgcmVhc29uTGVuID0gZGF0YS5yZWFkVUludDMyTEUob2Zmc2V0KTtcbiAgICBvZmZzZXQgKz0gNDtcbiAgICBjb25zdCByZWFzb24gPSBkYXRhLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgcmVhc29uTGVuKS50b1N0cmluZygndXRmOCcpO1xuICAgIG9mZnNldCArPSByZWFzb25MZW47XG5cbiAgICBjb25zdCBoYXNQcm9wb3NlZE91dGNvbWUgPSBkYXRhLnJlYWRVSW50OChvZmZzZXQpO1xuICAgIG9mZnNldCArPSAxO1xuICAgIGxldCBwcm9wb3NlZE91dGNvbWU6IGJvb2xlYW4gfCBudWxsID0gbnVsbDtcbiAgICBpZiAoaGFzUHJvcG9zZWRPdXRjb21lID09PSAxKSB7XG4gICAgICBwcm9wb3NlZE91dGNvbWUgPSBkYXRhLnJlYWRVSW50OChvZmZzZXQpID09PSAxO1xuICAgICAgb2Zmc2V0ICs9IDE7XG4gICAgfVxuXG4gICAgY29uc3QgY3JlYXRlZEF0ID0gZGF0YS5yZWFkQmlnSW50NjRMRShvZmZzZXQpO1xuICAgIG9mZnNldCArPSA4O1xuXG4gICAgY29uc3QgZGVhZGxpbmUgPSBkYXRhLnJlYWRCaWdJbnQ2NExFKG9mZnNldCk7XG4gICAgb2Zmc2V0ICs9IDg7XG5cbiAgICBjb25zdCByZXNvbHZlZCA9IGRhdGEucmVhZFVJbnQ4KG9mZnNldCkgPT09IDE7XG5cbiAgICByZXR1cm4ge1xuICAgICAgcHVibGljS2V5OiBkaXNwdXRlTWV0YVBkYS50b0Jhc2U1OCgpLFxuICAgICAgbWFya2V0UGRhOiBtYXJrZXQudG9CYXNlNTgoKSxcbiAgICAgIGRpc3B1dGVyOiBkaXNwdXRlci50b0Jhc2U1OCgpLFxuICAgICAgcmVhc29uLFxuICAgICAgcHJvcG9zZWRPdXRjb21lLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZShOdW1iZXIoY3JlYXRlZEF0KSAqIDEwMDApLnRvSVNPU3RyaW5nKCksXG4gICAgICBkZWFkbGluZTogbmV3IERhdGUoTnVtYmVyKGRlYWRsaW5lKSAqIDEwMDApLnRvSVNPU3RyaW5nKCksXG4gICAgICByZXNvbHZlZCxcbiAgICB9O1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBhbGwgZGlzcHV0ZWQgbWFya2V0c1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RGlzcHV0ZWRNYXJrZXRzKCk6IFByb21pc2U8RGlzcHV0ZU1ldGFbXT4ge1xuICBjb25zdCBjb25uZWN0aW9uID0gbmV3IENvbm5lY3Rpb24oUlBDX0VORFBPSU5ULCAnY29uZmlybWVkJyk7XG5cbiAgY29uc3QgYWNjb3VudHMgPSBhd2FpdCBjb25uZWN0aW9uLmdldFByb2dyYW1BY2NvdW50cyhQUk9HUkFNX0lELCB7XG4gICAgZmlsdGVyczogW1xuICAgICAge1xuICAgICAgICBtZW1jbXA6IHtcbiAgICAgICAgICBvZmZzZXQ6IDAsXG4gICAgICAgICAgYnl0ZXM6IGJzNTguZW5jb2RlKERJU0NSSU1JTkFUT1JTLkRJU1BVVEVfTUVUQSksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIF0sXG4gIH0pO1xuXG4gIGNvbnN0IGRpc3B1dGVzOiBEaXNwdXRlTWV0YVtdID0gW107XG5cbiAgZm9yIChjb25zdCB7IGFjY291bnQsIHB1YmtleSB9IG9mIGFjY291bnRzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBhY2NvdW50LmRhdGEgYXMgQnVmZmVyO1xuICAgICAgbGV0IG9mZnNldCA9IDg7XG5cbiAgICAgIGNvbnN0IG1hcmtldCA9IG5ldyBQdWJsaWNLZXkoZGF0YS5zbGljZShvZmZzZXQsIG9mZnNldCArIDMyKSk7XG4gICAgICBvZmZzZXQgKz0gMzI7XG5cbiAgICAgIGNvbnN0IGRpc3B1dGVyID0gbmV3IFB1YmxpY0tleShkYXRhLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgMzIpKTtcbiAgICAgIG9mZnNldCArPSAzMjtcblxuICAgICAgY29uc3QgcmVhc29uTGVuID0gZGF0YS5yZWFkVUludDMyTEUob2Zmc2V0KTtcbiAgICAgIG9mZnNldCArPSA0O1xuICAgICAgY29uc3QgcmVhc29uID0gZGF0YS5zbGljZShvZmZzZXQsIG9mZnNldCArIHJlYXNvbkxlbikudG9TdHJpbmcoJ3V0ZjgnKTtcbiAgICAgIG9mZnNldCArPSByZWFzb25MZW47XG5cbiAgICAgIGNvbnN0IGhhc1Byb3Bvc2VkT3V0Y29tZSA9IGRhdGEucmVhZFVJbnQ4KG9mZnNldCk7XG4gICAgICBvZmZzZXQgKz0gMTtcbiAgICAgIGxldCBwcm9wb3NlZE91dGNvbWU6IGJvb2xlYW4gfCBudWxsID0gbnVsbDtcbiAgICAgIGlmIChoYXNQcm9wb3NlZE91dGNvbWUgPT09IDEpIHtcbiAgICAgICAgcHJvcG9zZWRPdXRjb21lID0gZGF0YS5yZWFkVUludDgob2Zmc2V0KSA9PT0gMTtcbiAgICAgICAgb2Zmc2V0ICs9IDE7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNyZWF0ZWRBdCA9IGRhdGEucmVhZEJpZ0ludDY0TEUob2Zmc2V0KTtcbiAgICAgIG9mZnNldCArPSA4O1xuXG4gICAgICBjb25zdCBkZWFkbGluZSA9IGRhdGEucmVhZEJpZ0ludDY0TEUob2Zmc2V0KTtcbiAgICAgIG9mZnNldCArPSA4O1xuXG4gICAgICBjb25zdCByZXNvbHZlZCA9IGRhdGEucmVhZFVJbnQ4KG9mZnNldCkgPT09IDE7XG5cbiAgICAgIGlmICghcmVzb2x2ZWQpIHtcbiAgICAgICAgZGlzcHV0ZXMucHVzaCh7XG4gICAgICAgICAgcHVibGljS2V5OiBwdWJrZXkudG9CYXNlNTgoKSxcbiAgICAgICAgICBtYXJrZXRQZGE6IG1hcmtldC50b0Jhc2U1OCgpLFxuICAgICAgICAgIGRpc3B1dGVyOiBkaXNwdXRlci50b0Jhc2U1OCgpLFxuICAgICAgICAgIHJlYXNvbixcbiAgICAgICAgICBwcm9wb3NlZE91dGNvbWUsXG4gICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZShOdW1iZXIoY3JlYXRlZEF0KSAqIDEwMDApLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgZGVhZGxpbmU6IG5ldyBEYXRlKE51bWJlcihkZWFkbGluZSkgKiAxMDAwKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIHJlc29sdmVkLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIHtcbiAgICAgIC8vIFNraXAgbWFsZm9ybWVkXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGRpc3B1dGVzO1xufVxuXG4vKipcbiAqIEdldCBtYXJrZXRzIHBlbmRpbmcgcmVzb2x1dGlvbiAoY2xvc2VkIGJ1dCBub3QgcmVzb2x2ZWQpXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRNYXJrZXRzQXdhaXRpbmdSZXNvbHV0aW9uKCk6IFByb21pc2U8TWFya2V0W10+IHtcbiAgY29uc3QgY29ubmVjdGlvbiA9IG5ldyBDb25uZWN0aW9uKFJQQ19FTkRQT0lOVCwgJ2NvbmZpcm1lZCcpO1xuXG4gIC8vIEdldCBhbGwgbWFya2V0cyB3aXRoIHN0YXR1cyA9IENsb3NlZCAoMSlcbiAgY29uc3QgYWNjb3VudHMgPSBhd2FpdCBjb25uZWN0aW9uLmdldFByb2dyYW1BY2NvdW50cyhQUk9HUkFNX0lELCB7XG4gICAgZmlsdGVyczogW1xuICAgICAge1xuICAgICAgICBtZW1jbXA6IHtcbiAgICAgICAgICBvZmZzZXQ6IDAsXG4gICAgICAgICAgYnl0ZXM6IGJzNTguZW5jb2RlKERJU0NSSU1JTkFUT1JTLk1BUktFVCksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIF0sXG4gIH0pO1xuXG4gIGNvbnN0IG1hcmtldHM6IE1hcmtldFtdID0gW107XG5cbiAgZm9yIChjb25zdCB7IGFjY291bnQsIHB1YmtleSB9IG9mIGFjY291bnRzKSB7XG4gICAgY29uc3QgbWFya2V0ID0gYXdhaXQgZ2V0TWFya2V0KHB1YmtleS50b0Jhc2U1OCgpKTtcbiAgICBpZiAobWFya2V0ICYmIG1hcmtldC5zdGF0dXMgPT09ICdDbG9zZWQnKSB7XG4gICAgICBtYXJrZXRzLnB1c2gobWFya2V0KTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbWFya2V0cztcbn1cbiJdfQ==