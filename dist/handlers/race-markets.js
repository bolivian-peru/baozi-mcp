/**
 * Race Markets Handler - Multi-Outcome Prediction Markets
 */
import { Connection, PublicKey } from '@solana/web3.js';
import bs58 from 'bs58';
import { PROGRAM_ID, RPC_ENDPOINT, DISCRIMINATORS, MARKET_STATUS_NAMES, MARKET_LAYER_NAMES, lamportsToSol, } from '../config.js';
// =============================================================================
// RACE MARKET DECODER
// =============================================================================
/**
 * Decode RaceMarket account data
 *
 * RaceMarket struct layout (from IDL v4.7.6):
 * - discriminator (8)
 * - market_id (u64, 8)
 * - question (String: 4 + len)
 * - closing_time (i64, 8)
 * - resolution_time (i64, 8)
 * - auto_stop_buffer (i64, 8)
 * - outcome_count (u8, 1)
 * - outcome_labels ([[u8; 32]; 10], 320 bytes FIXED)
 * - outcome_pools ([u64; 10], 80 bytes FIXED)
 * - total_pool (u64, 8)
 * - snapshot_pools ([u64; 10], 80 bytes)
 * - snapshot_total (u64, 8)
 * - status (enum, 1)
 * - winning_outcome (Option<u8>: 1 + 0/1)
 * - currency_type (enum, 1)
 * - platform_fee_collected (u64, 8)
 * - creator_fee_collected (u64, 8)
 * - total_claimed (u64, 8)
 * - last_bet_time (i64, 8)
 * - bump (u8, 1)
 * - layer (enum, 1)
 * - resolution_mode (enum, 1)
 * - access_gate (enum, 1)
 * - creator (Pubkey, 32)
 * - platform_fee_bps_at_creation (u16, 2)
 * - affiliate_fee_bps_at_creation (u16, 2)
 * - betting_freeze_seconds_at_creation (i64, 8)
 * - dust_swept (bool, 1)
 * - reserved ([u8; 19], 19)
 */
function decodeRaceMarket(data, pubkey) {
    try {
        // Minimum expected size for a RaceMarket account
        // 8 (disc) + 8 (id) + 4 (qlen) + 8*3 (times) + 1 (count) + 320 (labels) + 80 (pools) + ...
        if (data.length < 500) {
            return null; // Account too small to be a RaceMarket
        }
        let offset = 8; // Skip discriminator
        // market_id (u64)
        const marketId = data.readBigUInt64LE(offset);
        offset += 8;
        // question (String: 4 bytes length + UTF-8 bytes)
        const questionLen = data.readUInt32LE(offset);
        offset += 4;
        // Sanity check: question length should be reasonable (max 200 chars)
        if (questionLen > 500 || questionLen + offset > data.length) {
            return null; // Invalid question length - not a valid RaceMarket
        }
        const question = data.slice(offset, offset + questionLen).toString('utf8');
        offset += questionLen;
        // closing_time (i64)
        const closingTime = data.readBigInt64LE(offset);
        offset += 8;
        // resolution_time (i64)
        const resolutionTime = data.readBigInt64LE(offset);
        offset += 8;
        // auto_stop_buffer (i64)
        offset += 8; // Skip for now
        // outcome_count (u8)
        const outcomeCount = data.readUInt8(offset);
        offset += 1;
        // outcome_labels: [[u8; 32]; 10] = 320 bytes FIXED
        // Each label is 32 bytes, padded with zeros
        const outcomeLabels = [];
        for (let i = 0; i < 10; i++) {
            const labelBytes = data.slice(offset, offset + 32);
            // Find null terminator or end of string
            let labelEnd = 32;
            for (let j = 0; j < 32; j++) {
                if (labelBytes[j] === 0) {
                    labelEnd = j;
                    break;
                }
            }
            if (i < outcomeCount) {
                outcomeLabels.push(labelBytes.slice(0, labelEnd).toString('utf8'));
            }
            offset += 32;
        }
        // outcome_pools: [u64; 10] = 80 bytes FIXED
        const outcomePools = [];
        for (let i = 0; i < 10; i++) {
            const pool = data.readBigUInt64LE(offset);
            if (i < outcomeCount) {
                outcomePools.push(pool);
            }
            offset += 8;
        }
        // total_pool (u64)
        const totalPoolLamports = data.readBigUInt64LE(offset);
        offset += 8;
        // snapshot_pools: [u64; 10] = 80 bytes - skip
        offset += 80;
        // snapshot_total (u64) - skip
        offset += 8;
        // status (enum, 1 byte)
        const statusCode = data.readUInt8(offset);
        offset += 1;
        // winning_outcome (Option<u8>: 1 byte discriminant + optional 1 byte value)
        const hasWinningOutcome = data.readUInt8(offset);
        offset += 1;
        let winningOutcomeIndex = null;
        if (hasWinningOutcome === 1) {
            winningOutcomeIndex = data.readUInt8(offset);
            offset += 1;
        }
        // currency_type (enum, 1 byte)
        offset += 1;
        // platform_fee_collected (u64)
        offset += 8;
        // creator_fee_collected (u64)
        offset += 8;
        // total_claimed (u64)
        offset += 8;
        // last_bet_time (i64)
        offset += 8;
        // bump (u8)
        offset += 1;
        // layer (enum, 1 byte)
        const layerCode = data.readUInt8(offset);
        offset += 1;
        // resolution_mode (enum, 1 byte)
        offset += 1;
        // access_gate (enum, 1 byte)
        const accessGateCode = data.readUInt8(offset);
        offset += 1;
        // creator (Pubkey, 32 bytes)
        const creator = new PublicKey(data.slice(offset, offset + 32));
        offset += 32;
        // oracle_host (Option<Pubkey>: 1 + 0/32)
        const hasOracleHost = data.readUInt8(offset);
        offset += 1;
        if (hasOracleHost === 1) {
            offset += 32;
        }
        // council: [Pubkey; 5] = 160 bytes - skip
        offset += 160;
        // council_size (u8)
        offset += 1;
        // council_votes: [u8; 10] = 10 bytes - skip
        offset += 10;
        // council_threshold (u8)
        offset += 1;
        // creator_fee_bps (u16)
        offset += 2;
        // creator_profile (Option<Pubkey>: 1 + 0/32)
        const hasCreatorProfile = data.readUInt8(offset);
        offset += 1;
        if (hasCreatorProfile === 1) {
            offset += 32;
        }
        // platform_fee_bps_at_creation (u16)
        const platformFeeBps = data.readUInt16LE(offset);
        offset += 2;
        // Calculate derived fields
        const totalPoolSol = lamportsToSol(totalPoolLamports);
        const outcomes = outcomeLabels.map((label, i) => {
            const poolSol = lamportsToSol(outcomePools[i] || 0n);
            const percent = totalPoolSol > 0 ? (poolSol / totalPoolSol) * 100 : 100 / outcomeLabels.length;
            return {
                index: i,
                label,
                poolSol: round4(poolSol),
                percent: round2(percent),
            };
        });
        // Betting open check
        const now = BigInt(Math.floor(Date.now() / 1000));
        const freezeTime = closingTime - 300n; // 5 min freeze
        const isBettingOpen = statusCode === 0 && now < freezeTime;
        return {
            publicKey: pubkey.toBase58(),
            marketId: marketId.toString(),
            question,
            outcomes,
            closingTime: new Date(Number(closingTime) * 1000).toISOString(),
            resolutionTime: new Date(Number(resolutionTime) * 1000).toISOString(),
            status: MARKET_STATUS_NAMES[statusCode] || 'Unknown',
            statusCode,
            winningOutcomeIndex,
            totalPoolSol: round4(totalPoolSol),
            layer: MARKET_LAYER_NAMES[layerCode] || 'Unknown',
            layerCode,
            accessGate: accessGateCode === 0 ? 'Public' : 'Whitelist',
            creator: creator.toBase58(),
            platformFeeBps,
            isBettingOpen,
        };
    }
    catch (err) {
        console.error('Error decoding race market:', err);
        return null;
    }
}
// =============================================================================
// PUBLIC API
// =============================================================================
/**
 * List all race markets
 */
export async function listRaceMarkets(status) {
    const connection = new Connection(RPC_ENDPOINT, 'confirmed');
    const accounts = await connection.getProgramAccounts(PROGRAM_ID, {
        filters: [
            {
                memcmp: {
                    offset: 0,
                    bytes: bs58.encode(DISCRIMINATORS.RACE_MARKET),
                },
            },
        ],
    });
    const markets = [];
    for (const { account, pubkey } of accounts) {
        const market = decodeRaceMarket(account.data, pubkey);
        if (market) {
            if (!status || market.status.toLowerCase() === status.toLowerCase()) {
                markets.push(market);
            }
        }
    }
    // Sort by closing time
    markets.sort((a, b) => {
        if (a.status === 'Active' && b.status !== 'Active')
            return -1;
        if (a.status !== 'Active' && b.status === 'Active')
            return 1;
        return new Date(a.closingTime).getTime() - new Date(b.closingTime).getTime();
    });
    return markets;
}
/**
 * Get a specific race market
 */
export async function getRaceMarket(publicKey) {
    const connection = new Connection(RPC_ENDPOINT, 'confirmed');
    try {
        const pubkey = new PublicKey(publicKey);
        const account = await connection.getAccountInfo(pubkey);
        if (!account)
            return null;
        return decodeRaceMarket(account.data, pubkey);
    }
    catch {
        return null;
    }
}
/**
 * Get race quote for a potential bet
 */
export function getRaceQuote(market, outcomeIndex, betAmountSol) {
    if (outcomeIndex < 0 || outcomeIndex >= market.outcomes.length) {
        return {
            valid: false,
            error: `Invalid outcome index. Must be 0-${market.outcomes.length - 1}`,
            outcomeLabel: '',
            betAmountSol,
            expectedPayoutSol: 0,
            impliedOdds: 0,
            newOutcomePercent: 0,
        };
    }
    const outcome = market.outcomes[outcomeIndex];
    const currentPool = outcome.poolSol;
    const totalPool = market.totalPoolSol;
    // New pools after bet
    const newOutcomePool = currentPool + betAmountSol;
    const newTotalPool = totalPool + betAmountSol;
    // Share of outcome pool
    const share = betAmountSol / newOutcomePool;
    const grossPayout = share * newTotalPool;
    const profit = grossPayout - betAmountSol;
    const fee = profit > 0 ? (profit * market.platformFeeBps) / 10000 : 0;
    const expectedPayout = grossPayout - fee;
    // Implied odds
    const impliedOdds = newOutcomePool / newTotalPool * 100;
    return {
        valid: true,
        outcomeLabel: outcome.label,
        betAmountSol,
        expectedPayoutSol: round4(expectedPayout),
        impliedOdds: round2(impliedOdds),
        newOutcomePercent: round2((newOutcomePool / newTotalPool) * 100),
    };
}
// =============================================================================
// HELPERS
// =============================================================================
function round2(n) {
    return Math.round(n * 100) / 100;
}
function round4(n) {
    return Math.round(n * 10000) / 10000;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFjZS1tYXJrZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2hhbmRsZXJzL3JhY2UtbWFya2V0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUNILE9BQU8sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEQsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sRUFDTCxVQUFVLEVBQ1YsWUFBWSxFQUNaLGNBQWMsRUFDZCxtQkFBbUIsRUFDbkIsa0JBQWtCLEVBQ2xCLGFBQWEsR0FDZCxNQUFNLGNBQWMsQ0FBQztBQTJDdEIsZ0ZBQWdGO0FBQ2hGLHNCQUFzQjtBQUN0QixnRkFBZ0Y7QUFFaEY7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWlDRztBQUNILFNBQVMsZ0JBQWdCLENBQUMsSUFBWSxFQUFFLE1BQWlCO0lBQ3ZELElBQUksQ0FBQztRQUNILGlEQUFpRDtRQUNqRCwyRkFBMkY7UUFDM0YsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDO1lBQ3RCLE9BQU8sSUFBSSxDQUFDLENBQUMsdUNBQXVDO1FBQ3RELENBQUM7UUFFRCxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxxQkFBcUI7UUFFckMsa0JBQWtCO1FBQ2xCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDOUMsTUFBTSxJQUFJLENBQUMsQ0FBQztRQUVaLGtEQUFrRDtRQUNsRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLE1BQU0sSUFBSSxDQUFDLENBQUM7UUFFWixxRUFBcUU7UUFDckUsSUFBSSxXQUFXLEdBQUcsR0FBRyxJQUFJLFdBQVcsR0FBRyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQzVELE9BQU8s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R0FBRyxHQUFHLENBQUM7S0FDakUsQ0FBQztBQUNKLENBQUM7QUFFRCxnRkFBZ0Y7QUFDaEYsVUFBVTtBQUNWLGdGQUFnRjtBQUVoRixTQUFTLE1BQU0sQ0FBQyxDQUFTO0lBQ3ZCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO0FBQ25DLENBQUM7QUFFRCxTQUFTLE1BQU0sQ0FBQyxDQUFTO0lBQ3ZCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDO0FBQ3ZDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFJhY2UgTWFya2V0cyBIYW5kbGVyIC0gTXVsdGktT3V0Y29tZSBQcmVkaWN0aW9uIE1hcmtldHNcbiAqL1xuaW1wb3J0IHsgQ29ubmVjdGlvbiwgUHVibGljS2V5IH0gZnJvbSAnQHNvbGFuYS93ZWIzLmpzJztcbmltcG9ydCBiczU4IGZyb20gJ2JzNTgnO1xuaW1wb3J0IHtcbiAgUFJPR1JBTV9JRCxcbiAgUlBDX0VORFBPSU5ULFxuICBESVNDUklNSU5BVE9SUyxcbiAgTUFSS0VUX1NUQVRVU19OQU1FUyxcbiAgTUFSS0VUX0xBWUVSX05BTUVTLFxuICBsYW1wb3J0c1RvU29sLFxufSBmcm9tICcuLi9jb25maWcuanMnO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gVFlQRVNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmFjZU91dGNvbWUge1xuICBpbmRleDogbnVtYmVyO1xuICBsYWJlbDogc3RyaW5nO1xuICBwb29sU29sOiBudW1iZXI7XG4gIHBlcmNlbnQ6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSYWNlTWFya2V0IHtcbiAgcHVibGljS2V5OiBzdHJpbmc7XG4gIG1hcmtldElkOiBzdHJpbmc7XG4gIHF1ZXN0aW9uOiBzdHJpbmc7XG4gIG91dGNvbWVzOiBSYWNlT3V0Y29tZVtdO1xuICBjbG9zaW5nVGltZTogc3RyaW5nO1xuICByZXNvbHV0aW9uVGltZTogc3RyaW5nO1xuICBzdGF0dXM6IHN0cmluZztcbiAgc3RhdHVzQ29kZTogbnVtYmVyO1xuICB3aW5uaW5nT3V0Y29tZUluZGV4OiBudW1iZXIgfCBudWxsO1xuICB0b3RhbFBvb2xTb2w6IG51bWJlcjtcbiAgbGF5ZXI6IHN0cmluZztcbiAgbGF5ZXJDb2RlOiBudW1iZXI7XG4gIGFjY2Vzc0dhdGU6IHN0cmluZztcbiAgY3JlYXRvcjogc3RyaW5nO1xuICBwbGF0Zm9ybUZlZUJwczogbnVtYmVyO1xuICBpc0JldHRpbmdPcGVuOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJhY2VQb3NpdGlvbiB7XG4gIHB1YmxpY0tleTogc3RyaW5nO1xuICB1c2VyOiBzdHJpbmc7XG4gIHJhY2VNYXJrZXRQZGE6IHN0cmluZztcbiAgbWFya2V0SWQ6IHN0cmluZztcbiAgb3V0Y29tZUluZGV4OiBudW1iZXI7XG4gIGFtb3VudFNvbDogbnVtYmVyO1xuICBjbGFpbWVkOiBib29sZWFuO1xuICBjcmVhdGVkQXQ6IHN0cmluZztcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFJBQ0UgTUFSS0VUIERFQ09ERVJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogRGVjb2RlIFJhY2VNYXJrZXQgYWNjb3VudCBkYXRhXG4gKlxuICogUmFjZU1hcmtldCBzdHJ1Y3QgbGF5b3V0IChmcm9tIElETCB2NC43LjYpOlxuICogLSBkaXNjcmltaW5hdG9yICg4KVxuICogLSBtYXJrZXRfaWQgKHU2NCwgOClcbiAqIC0gcXVlc3Rpb24gKFN0cmluZzogNCArIGxlbilcbiAqIC0gY2xvc2luZ190aW1lIChpNjQsIDgpXG4gKiAtIHJlc29sdXRpb25fdGltZSAoaTY0LCA4KVxuICogLSBhdXRvX3N0b3BfYnVmZmVyIChpNjQsIDgpXG4gKiAtIG91dGNvbWVfY291bnQgKHU4LCAxKVxuICogLSBvdXRjb21lX2xhYmVscyAoW1t1ODsgMzJdOyAxMF0sIDMyMCBieXRlcyBGSVhFRClcbiAqIC0gb3V0Y29tZV9wb29scyAoW3U2NDsgMTBdLCA4MCBieXRlcyBGSVhFRClcbiAqIC0gdG90YWxfcG9vbCAodTY0LCA4KVxuICogLSBzbmFwc2hvdF9wb29scyAoW3U2NDsgMTBdLCA4MCBieXRlcylcbiAqIC0gc25hcHNob3RfdG90YWwgKHU2NCwgOClcbiAqIC0gc3RhdHVzIChlbnVtLCAxKVxuICogLSB3aW5uaW5nX291dGNvbWUgKE9wdGlvbjx1OD46IDEgKyAwLzEpXG4gKiAtIGN1cnJlbmN5X3R5cGUgKGVudW0sIDEpXG4gKiAtIHBsYXRmb3JtX2ZlZV9jb2xsZWN0ZWQgKHU2NCwgOClcbiAqIC0gY3JlYXRvcl9mZWVfY29sbGVjdGVkICh1NjQsIDgpXG4gKiAtIHRvdGFsX2NsYWltZWQgKHU2NCwgOClcbiAqIC0gbGFzdF9iZXRfdGltZSAoaTY0LCA4KVxuICogLSBidW1wICh1OCwgMSlcbiAqIC0gbGF5ZXIgKGVudW0sIDEpXG4gKiAtIHJlc29sdXRpb25fbW9kZSAoZW51bSwgMSlcbiAqIC0gYWNjZXNzX2dhdGUgKGVudW0sIDEpXG4gKiAtIGNyZWF0b3IgKFB1YmtleSwgMzIpXG4gKiAtIHBsYXRmb3JtX2ZlZV9icHNfYXRfY3JlYXRpb24gKHUxNiwgMilcbiAqIC0gYWZmaWxpYXRlX2ZlZV9icHNfYXRfY3JlYXRpb24gKHUxNiwgMilcbiAqIC0gYmV0dGluZ19mcmVlemVfc2Vjb25kc19hdF9jcmVhdGlvbiAoaTY0LCA4KVxuICogLSBkdXN0X3N3ZXB0IChib29sLCAxKVxuICogLSByZXNlcnZlZCAoW3U4OyAxOV0sIDE5KVxuICovXG5mdW5jdGlvbiBkZWNvZGVSYWNlTWFya2V0KGRhdGE6IEJ1ZmZlciwgcHVia2V5OiBQdWJsaWNLZXkpOiBSYWNlTWFya2V0IHwgbnVsbCB7XG4gIHRyeSB7XG4gICAgLy8gTWluaW11bSBleHBlY3RlZCBzaXplIGZvciBhIFJhY2VNYXJrZXQgYWNjb3VudFxuICAgIC8vIDggKGRpc2MpICsgOCAoaWQpICsgNCAocWxlbikgKyA4KjMgKHRpbWVzKSArIDEgKGNvdW50KSArIDMyMCAobGFiZWxzKSArIDgwIChwb29scykgKyAuLi5cbiAgICBpZiAoZGF0YS5sZW5ndGggPCA1MDApIHtcbiAgICAgIHJldHVybiBudWxsOyAvLyBBY2NvdW50IHRvbyBzbWFsbCB0byBiZSBhIFJhY2VNYXJrZXRcbiAgICB9XG5cbiAgICBsZXQgb2Zmc2V0ID0gODsgLy8gU2tpcCBkaXNjcmltaW5hdG9yXG5cbiAgICAvLyBtYXJrZXRfaWQgKHU2NClcbiAgICBjb25zdCBtYXJrZXRJZCA9IGRhdGEucmVhZEJpZ1VJbnQ2NExFKG9mZnNldCk7XG4gICAgb2Zmc2V0ICs9IDg7XG5cbiAgICAvLyBxdWVzdGlvbiAoU3RyaW5nOiA0IGJ5dGVzIGxlbmd0aCArIFVURi04IGJ5dGVzKVxuICAgIGNvbnN0IHF1ZXN0aW9uTGVuID0gZGF0YS5yZWFkVUludDMyTEUob2Zmc2V0KTtcbiAgICBvZmZzZXQgKz0gNDtcblxuICAgIC8vIFNhbml0eSBjaGVjazogcXVlc3Rpb24gbGVuZ3RoIHNob3VsZCBiZSByZWFzb25hYmxlIChtYXggMjAwIGNoYXJzKVxuICAgIGlmIChxdWVzdGlvbkxlbiA+IDUwMCB8fCBxdWVzdGlvbkxlbiArIG9mZnNldCA+IGRhdGEubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gbnVsbDsgLy8gSW52YWxpZCBxdWVzdGlvbiBsZW5ndGggLSBub3QgYSB2YWxpZCBSYWNlTWFya2V0XG4gICAgfVxuXG4gICAgY29uc3QgcXVlc3Rpb24gPSBkYXRhLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgcXVlc3Rpb25MZW4pLnRvU3RyaW5nKCd1dGY4Jyk7XG4gICAgb2Zmc2V0ICs9IHF1ZXN0aW9uTGVuO1xuXG4gICAgLy8gY2xvc2luZ190aW1lIChpNjQpXG4gICAgY29uc3QgY2xvc2luZ1RpbWUgPSBkYXRhLnJlYWRCaWdJbnQ2NExFKG9mZnNldCk7XG4gICAgb2Zmc2V0ICs9IDg7XG5cbiAgICAvLyByZXNvbHV0aW9uX3RpbWUgKGk2NClcbiAgICBjb25zdCByZXNvbHV0aW9uVGltZSA9IGRhdGEucmVhZEJpZ0ludDY0TEUob2Zmc2V0KTtcbiAgICBvZmZzZXQgKz0gODtcblxuICAgIC8vIGF1dG9fc3RvcF9idWZmZXIgKGk2NClcbiAgICBvZmZzZXQgKz0gODsgLy8gU2tpcCBmb3Igbm93XG5cbiAgICAvLyBvdXRjb21lX2NvdW50ICh1OClcbiAgICBjb25zdCBvdXRjb21lQ291bnQgPSBkYXRhLnJlYWRVSW50OChvZmZzZXQpO1xuICAgIG9mZnNldCArPSAxO1xuXG4gICAgLy8gb3V0Y29tZV9sYWJlbHM6IFtbdTg7IDMyXTsgMTBdID0gMzIwIGJ5dGVzIEZJWEVEXG4gICAgLy8gRWFjaCBsYWJlbCBpcyAzMiBieXRlcywgcGFkZGVkIHdpdGggemVyb3NcbiAgICBjb25zdCBvdXRjb21lTGFiZWxzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTA7IGkrKykge1xuICAgICAgY29uc3QgbGFiZWxCeXRlcyA9IGRhdGEuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyAzMik7XG4gICAgICAvLyBGaW5kIG51bGwgdGVybWluYXRvciBvciBlbmQgb2Ygc3RyaW5nXG4gICAgICBsZXQgbGFiZWxFbmQgPSAzMjtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMzI7IGorKykge1xuICAgICAgICBpZiAobGFiZWxCeXRlc1tqXSA9PT0gMCkge1xuICAgICAgICAgIGxhYmVsRW5kID0gajtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGkgPCBvdXRjb21lQ291bnQpIHtcbiAgICAgICAgb3V0Y29tZUxhYmVscy5wdXNoKGxhYmVsQnl0ZXMuc2xpY2UoMCwgbGFiZWxFbmQpLnRvU3RyaW5nKCd1dGY4JykpO1xuICAgICAgfVxuICAgICAgb2Zmc2V0ICs9IDMyO1xuICAgIH1cblxuICAgIC8vIG91dGNvbWVfcG9vbHM6IFt1NjQ7IDEwXSA9IDgwIGJ5dGVzIEZJWEVEXG4gICAgY29uc3Qgb3V0Y29tZVBvb2xzOiBiaWdpbnRbXSA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTA7IGkrKykge1xuICAgICAgY29uc3QgcG9vbCA9IGRhdGEucmVhZEJpZ1VJbnQ2NExFKG9mZnNldCk7XG4gICAgICBpZiAoaSA8IG91dGNvbWVDb3VudCkge1xuICAgICAgICBvdXRjb21lUG9vbHMucHVzaChwb29sKTtcbiAgICAgIH1cbiAgICAgIG9mZnNldCArPSA4O1xuICAgIH1cblxuICAgIC8vIHRvdGFsX3Bvb2wgKHU2NClcbiAgICBjb25zdCB0b3RhbFBvb2xMYW1wb3J0cyA9IGRhdGEucmVhZEJpZ1VJbnQ2NExFKG9mZnNldCk7XG4gICAgb2Zmc2V0ICs9IDg7XG5cbiAgICAvLyBzbmFwc2hvdF9wb29sczogW3U2NDsgMTBdID0gODAgYnl0ZXMgLSBza2lwXG4gICAgb2Zmc2V0ICs9IDgwO1xuXG4gICAgLy8gc25hcHNob3RfdG90YWwgKHU2NCkgLSBza2lwXG4gICAgb2Zmc2V0ICs9IDg7XG5cbiAgICAvLyBzdGF0dXMgKGVudW0sIDEgYnl0ZSlcbiAgICBjb25zdCBzdGF0dXNDb2RlID0gZGF0YS5yZWFkVUludDgob2Zmc2V0KTtcbiAgICBvZmZzZXQgKz0gMTtcblxuICAgIC8vIHdpbm5pbmdfb3V0Y29tZSAoT3B0aW9uPHU4PjogMSBieXRlIGRpc2NyaW1pbmFudCArIG9wdGlvbmFsIDEgYnl0ZSB2YWx1ZSlcbiAgICBjb25zdCBoYXNXaW5uaW5nT3V0Y29tZSA9IGRhdGEucmVhZFVJbnQ4KG9mZnNldCk7XG4gICAgb2Zmc2V0ICs9IDE7XG4gICAgbGV0IHdpbm5pbmdPdXRjb21lSW5kZXg6IG51bWJlciB8IG51bGwgPSBudWxsO1xuICAgIGlmIChoYXNXaW5uaW5nT3V0Y29tZSA9PT0gMSkge1xuICAgICAgd2lubmluZ091dGNvbWVJbmRleCA9IGRhdGEucmVhZFVJbnQ4KG9mZnNldCk7XG4gICAgICBvZmZzZXQgKz0gMTtcbiAgICB9XG5cbiAgICAvLyBjdXJyZW5jeV90eXBlIChlbnVtLCAxIGJ5dGUpXG4gICAgb2Zmc2V0ICs9IDE7XG5cbiAgICAvLyBwbGF0Zm9ybV9mZWVfY29sbGVjdGVkICh1NjQpXG4gICAgb2Zmc2V0ICs9IDg7XG5cbiAgICAvLyBjcmVhdG9yX2ZlZV9jb2xsZWN0ZWQgKHU2NClcbiAgICBvZmZzZXQgKz0gODtcblxuICAgIC8vIHRvdGFsX2NsYWltZWQgKHU2NClcbiAgICBvZmZzZXQgKz0gODtcblxuICAgIC8vIGxhc3RfYmV0X3RpbWUgKGk2NClcbiAgICBvZmZzZXQgKz0gODtcblxuICAgIC8vIGJ1bXAgKHU4KVxuICAgIG9mZnNldCArPSAxO1xuXG4gICAgLy8gbGF5ZXIgKGVudW0sIDEgYnl0ZSlcbiAgICBjb25zdCBsYXllckNvZGUgPSBkYXRhLnJlYWRVSW50OChvZmZzZXQpO1xuICAgIG9mZnNldCArPSAxO1xuXG4gICAgLy8gcmVzb2x1dGlvbl9tb2RlIChlbnVtLCAxIGJ5dGUpXG4gICAgb2Zmc2V0ICs9IDE7XG5cbiAgICAvLyBhY2Nlc3NfZ2F0ZSAoZW51bSwgMSBieXRlKVxuICAgIGNvbnN0IGFjY2Vzc0dhdGVDb2RlID0gZGF0YS5yZWFkVUludDgob2Zmc2V0KTtcbiAgICBvZmZzZXQgKz0gMTtcblxuICAgIC8vIGNyZWF0b3IgKFB1YmtleSwgMzIgYnl0ZXMpXG4gICAgY29uc3QgY3JlYXRvciA9IG5ldyBQdWJsaWNLZXkoZGF0YS5zbGljZShvZmZzZXQsIG9mZnNldCArIDMyKSk7XG4gICAgb2Zmc2V0ICs9IDMyO1xuXG4gICAgLy8gb3JhY2xlX2hvc3QgKE9wdGlvbjxQdWJrZXk+OiAxICsgMC8zMilcbiAgICBjb25zdCBoYXNPcmFjbGVIb3N0ID0gZGF0YS5yZWFkVUludDgob2Zmc2V0KTtcbiAgICBvZmZzZXQgKz0gMTtcbiAgICBpZiAoaGFzT3JhY2xlSG9zdCA9PT0gMSkge1xuICAgICAgb2Zmc2V0ICs9IDMyO1xuICAgIH1cblxuICAgIC8vIGNvdW5jaWw6IFtQdWJrZXk7IDVdID0gMTYwIGJ5dGVzIC0gc2tpcFxuICAgIG9mZnNldCArPSAxNjA7XG5cbiAgICAvLyBjb3VuY2lsX3NpemUgKHU4KVxuICAgIG9mZnNldCArPSAxO1xuXG4gICAgLy8gY291bmNpbF92b3RlczogW3U4OyAxMF0gPSAxMCBieXRlcyAtIHNraXBcbiAgICBvZmZzZXQgKz0gMTA7XG5cbiAgICAvLyBjb3VuY2lsX3RocmVzaG9sZCAodTgpXG4gICAgb2Zmc2V0ICs9IDE7XG5cbiAgICAvLyBjcmVhdG9yX2ZlZV9icHMgKHUxNilcbiAgICBvZmZzZXQgKz0gMjtcblxuICAgIC8vIGNyZWF0b3JfcHJvZmlsZSAoT3B0aW9uPFB1YmtleT46IDEgKyAwLzMyKVxuICAgIGNvbnN0IGhhc0NyZWF0b3JQcm9maWxlID0gZGF0YS5yZWFkVUludDgob2Zmc2V0KTtcbiAgICBvZmZzZXQgKz0gMTtcbiAgICBpZiAoaGFzQ3JlYXRvclByb2ZpbGUgPT09IDEpIHtcbiAgICAgIG9mZnNldCArPSAzMjtcbiAgICB9XG5cbiAgICAvLyBwbGF0Zm9ybV9mZWVfYnBzX2F0X2NyZWF0aW9uICh1MTYpXG4gICAgY29uc3QgcGxhdGZvcm1GZWVCcHMgPSBkYXRhLnJlYWRVSW50MTZMRShvZmZzZXQpO1xuICAgIG9mZnNldCArPSAyO1xuXG4gICAgLy8gQ2FsY3VsYXRlIGRlcml2ZWQgZmllbGRzXG4gICAgY29uc3QgdG90YWxQb29sU29sID0gbGFtcG9ydHNUb1NvbCh0b3RhbFBvb2xMYW1wb3J0cyk7XG5cbiAgICBjb25zdCBvdXRjb21lczogUmFjZU91dGNvbWVbXSA9IG91dGNvbWVMYWJlbHMubWFwKChsYWJlbCwgaSkgPT4ge1xuICAgICAgY29uc3QgcG9vbFNvbCA9IGxhbXBvcnRzVG9Tb2wob3V0Y29tZVBvb2xzW2ldIHx8IDBuKTtcbiAgICAgIGNvbnN0IHBlcmNlbnQgPSB0b3RhbFBvb2xTb2wgPiAwID8gKHBvb2xTb2wgLyB0b3RhbFBvb2xTb2wpICogMTAwIDogMTAwIC8gb3V0Y29tZUxhYmVscy5sZW5ndGg7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpbmRleDogaSxcbiAgICAgICAgbGFiZWwsXG4gICAgICAgIHBvb2xTb2w6IHJvdW5kNChwb29sU29sKSxcbiAgICAgICAgcGVyY2VudDogcm91bmQyKHBlcmNlbnQpLFxuICAgICAgfTtcbiAgICB9KTtcblxuICAgIC8vIEJldHRpbmcgb3BlbiBjaGVja1xuICAgIGNvbnN0IG5vdyA9IEJpZ0ludChNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKSk7XG4gICAgY29uc3QgZnJlZXplVGltZSA9IGNsb3NpbmdUaW1lIC0gMzAwbjsgLy8gNSBtaW4gZnJlZXplXG4gICAgY29uc3QgaXNCZXR0aW5nT3BlbiA9IHN0YXR1c0NvZGUgPT09IDAgJiYgbm93IDwgZnJlZXplVGltZTtcblxuICAgIHJldHVybiB7XG4gICAgICBwdWJsaWNLZXk6IHB1YmtleS50b0Jhc2U1OCgpLFxuICAgICAgbWFya2V0SWQ6IG1hcmtldElkLnRvU3RyaW5nKCksXG4gICAgICBxdWVzdGlvbixcbiAgICAgIG91dGNvbWVzLFxuICAgICAgY2xvc2luZ1RpbWU6IG5ldyBEYXRlKE51bWJlcihjbG9zaW5nVGltZSkgKiAxMDAwKS50b0lTT1N0cmluZygpLFxuICAgICAgcmVzb2x1dGlvblRpbWU6IG5ldyBEYXRlKE51bWJlcihyZXNvbHV0aW9uVGltZSkgKiAxMDAwKS50b0lTT1N0cmluZygpLFxuICAgICAgc3RhdHVzOiBNQVJLRVRfU1RBVFVTX05BTUVTW3N0YXR1c0NvZGVdIHx8ICdVbmtub3duJyxcbiAgICAgIHN0YXR1c0NvZGUsXG4gICAgICB3aW5uaW5nT3V0Y29tZUluZGV4LFxuICAgICAgdG90YWxQb29sU29sOiByb3VuZDQodG90YWxQb29sU29sKSxcbiAgICAgIGxheWVyOiBNQVJLRVRfTEFZRVJfTkFNRVNbbGF5ZXJDb2RlXSB8fCAnVW5rbm93bicsXG4gICAgICBsYXllckNvZGUsXG4gICAgICBhY2Nlc3NHYXRlOiBhY2Nlc3NHYXRlQ29kZSA9PT0gMCA/ICdQdWJsaWMnIDogJ1doaXRlbGlzdCcsXG4gICAgICBjcmVhdG9yOiBjcmVhdG9yLnRvQmFzZTU4KCksXG4gICAgICBwbGF0Zm9ybUZlZUJwcyxcbiAgICAgIGlzQmV0dGluZ09wZW4sXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZGVjb2RpbmcgcmFjZSBtYXJrZXQ6JywgZXJyKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gUFVCTElDIEFQSVxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBMaXN0IGFsbCByYWNlIG1hcmtldHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxpc3RSYWNlTWFya2V0cyhzdGF0dXM/OiBzdHJpbmcpOiBQcm9taXNlPFJhY2VNYXJrZXRbXT4ge1xuICBjb25zdCBjb25uZWN0aW9uID0gbmV3IENvbm5lY3Rpb24oUlBDX0VORFBPSU5ULCAnY29uZmlybWVkJyk7XG5cbiAgY29uc3QgYWNjb3VudHMgPSBhd2FpdCBjb25uZWN0aW9uLmdldFByb2dyYW1BY2NvdW50cyhQUk9HUkFNX0lELCB7XG4gICAgZmlsdGVyczogW1xuICAgICAge1xuICAgICAgICBtZW1jbXA6IHtcbiAgICAgICAgICBvZmZzZXQ6IDAsXG4gICAgICAgICAgYnl0ZXM6IGJzNTguZW5jb2RlKERJU0NSSU1JTkFUT1JTLlJBQ0VfTUFSS0VUKSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgXSxcbiAgfSk7XG5cbiAgY29uc3QgbWFya2V0czogUmFjZU1hcmtldFtdID0gW107XG5cbiAgZm9yIChjb25zdCB7IGFjY291bnQsIHB1YmtleSB9IG9mIGFjY291bnRzKSB7XG4gICAgY29uc3QgbWFya2V0ID0gZGVjb2RlUmFjZU1hcmtldChhY2NvdW50LmRhdGEgYXMgQnVmZmVyLCBwdWJrZXkpO1xuICAgIGlmIChtYXJrZXQpIHtcbiAgICAgIGlmICghc3RhdHVzIHx8IG1hcmtldC5zdGF0dXMudG9Mb3dlckNhc2UoKSA9PT0gc3RhdHVzLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgbWFya2V0cy5wdXNoKG1hcmtldCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gU29ydCBieSBjbG9zaW5nIHRpbWVcbiAgbWFya2V0cy5zb3J0KChhLCBiKSA9PiB7XG4gICAgaWYgKGEuc3RhdHVzID09PSAnQWN0aXZlJyAmJiBiLnN0YXR1cyAhPT0gJ0FjdGl2ZScpIHJldHVybiAtMTtcbiAgICBpZiAoYS5zdGF0dXMgIT09ICdBY3RpdmUnICYmIGIuc3RhdHVzID09PSAnQWN0aXZlJykgcmV0dXJuIDE7XG4gICAgcmV0dXJuIG5ldyBEYXRlKGEuY2xvc2luZ1RpbWUpLmdldFRpbWUoKSAtIG5ldyBEYXRlKGIuY2xvc2luZ1RpbWUpLmdldFRpbWUoKTtcbiAgfSk7XG5cbiAgcmV0dXJuIG1hcmtldHM7XG59XG5cbi8qKlxuICogR2V0IGEgc3BlY2lmaWMgcmFjZSBtYXJrZXRcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFJhY2VNYXJrZXQocHVibGljS2V5OiBzdHJpbmcpOiBQcm9taXNlPFJhY2VNYXJrZXQgfCBudWxsPiB7XG4gIGNvbnN0IGNvbm5lY3Rpb24gPSBuZXcgQ29ubmVjdGlvbihSUENfRU5EUE9JTlQsICdjb25maXJtZWQnKTtcblxuICB0cnkge1xuICAgIGNvbnN0IHB1YmtleSA9IG5ldyBQdWJsaWNLZXkocHVibGljS2V5KTtcbiAgICBjb25zdCBhY2NvdW50ID0gYXdhaXQgY29ubmVjdGlvbi5nZXRBY2NvdW50SW5mbyhwdWJrZXkpO1xuICAgIGlmICghYWNjb3VudCkgcmV0dXJuIG51bGw7XG4gICAgcmV0dXJuIGRlY29kZVJhY2VNYXJrZXQoYWNjb3VudC5kYXRhIGFzIEJ1ZmZlciwgcHVia2V5KTtcbiAgfSBjYXRjaCB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgcmFjZSBxdW90ZSBmb3IgYSBwb3RlbnRpYWwgYmV0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRSYWNlUXVvdGUoXG4gIG1hcmtldDogUmFjZU1hcmtldCxcbiAgb3V0Y29tZUluZGV4OiBudW1iZXIsXG4gIGJldEFtb3VudFNvbDogbnVtYmVyXG4pOiB7XG4gIHZhbGlkOiBib29sZWFuO1xuICBlcnJvcj86IHN0cmluZztcbiAgb3V0Y29tZUxhYmVsOiBzdHJpbmc7XG4gIGJldEFtb3VudFNvbDogbnVtYmVyO1xuICBleHBlY3RlZFBheW91dFNvbDogbnVtYmVyO1xuICBpbXBsaWVkT2RkczogbnVtYmVyO1xuICBuZXdPdXRjb21lUGVyY2VudDogbnVtYmVyO1xufSB7XG4gIGlmIChvdXRjb21lSW5kZXggPCAwIHx8IG91dGNvbWVJbmRleCA+PSBtYXJrZXQub3V0Y29tZXMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgIGVycm9yOiBgSW52YWxpZCBvdXRjb21lIGluZGV4LiBNdXN0IGJlIDAtJHttYXJrZXQub3V0Y29tZXMubGVuZ3RoIC0gMX1gLFxuICAgICAgb3V0Y29tZUxhYmVsOiAnJyxcbiAgICAgIGJldEFtb3VudFNvbCxcbiAgICAgIGV4cGVjdGVkUGF5b3V0U29sOiAwLFxuICAgICAgaW1wbGllZE9kZHM6IDAsXG4gICAgICBuZXdPdXRjb21lUGVyY2VudDogMCxcbiAgICB9O1xuICB9XG5cbiAgY29uc3Qgb3V0Y29tZSA9IG1hcmtldC5vdXRjb21lc1tvdXRjb21lSW5kZXhdO1xuICBjb25zdCBjdXJyZW50UG9vbCA9IG91dGNvbWUucG9vbFNvbDtcbiAgY29uc3QgdG90YWxQb29sID0gbWFya2V0LnRvdGFsUG9vbFNvbDtcblxuICAvLyBOZXcgcG9vbHMgYWZ0ZXIgYmV0XG4gIGNvbnN0IG5ld091dGNvbWVQb29sID0gY3VycmVudFBvb2wgKyBiZXRBbW91bnRTb2w7XG4gIGNvbnN0IG5ld1RvdGFsUG9vbCA9IHRvdGFsUG9vbCArIGJldEFtb3VudFNvbDtcblxuICAvLyBTaGFyZSBvZiBvdXRjb21lIHBvb2xcbiAgY29uc3Qgc2hhcmUgPSBiZXRBbW91bnRTb2wgLyBuZXdPdXRjb21lUG9vbDtcbiAgY29uc3QgZ3Jvc3NQYXlvdXQgPSBzaGFyZSAqIG5ld1RvdGFsUG9vbDtcbiAgY29uc3QgcHJvZml0ID0gZ3Jvc3NQYXlvdXQgLSBiZXRBbW91bnRTb2w7XG4gIGNvbnN0IGZlZSA9IHByb2ZpdCA+IDAgPyAocHJvZml0ICogbWFya2V0LnBsYXRmb3JtRmVlQnBzKSAvIDEwMDAwIDogMDtcbiAgY29uc3QgZXhwZWN0ZWRQYXlvdXQgPSBncm9zc1BheW91dCAtIGZlZTtcblxuICAvLyBJbXBsaWVkIG9kZHNcbiAgY29uc3QgaW1wbGllZE9kZHMgPSBuZXdPdXRjb21lUG9vbCAvIG5ld1RvdGFsUG9vbCAqIDEwMDtcblxuICByZXR1cm4ge1xuICAgIHZhbGlkOiB0cnVlLFxuICAgIG91dGNvbWVMYWJlbDogb3V0Y29tZS5sYWJlbCxcbiAgICBiZXRBbW91bnRTb2wsXG4gICAgZXhwZWN0ZWRQYXlvdXRTb2w6IHJvdW5kNChleHBlY3RlZFBheW91dCksXG4gICAgaW1wbGllZE9kZHM6IHJvdW5kMihpbXBsaWVkT2RkcyksXG4gICAgbmV3T3V0Y29tZVBlcmNlbnQ6IHJvdW5kMigobmV3T3V0Y29tZVBvb2wgLyBuZXdUb3RhbFBvb2wpICogMTAwKSxcbiAgfTtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEhFTFBFUlNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmZ1bmN0aW9uIHJvdW5kMihuOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gTWF0aC5yb3VuZChuICogMTAwKSAvIDEwMDtcbn1cblxuZnVuY3Rpb24gcm91bmQ0KG46IG51bWJlcik6IG51bWJlciB7XG4gIHJldHVybiBNYXRoLnJvdW5kKG4gKiAxMDAwMCkgLyAxMDAwMDtcbn1cbiJdfQ==