/**
 * Market Creation Validation Rules (v6.3 Compliant)
 *
 * Implements validation for:
 * - Rule A: Event-based markets (12-24h buffer before event)
 * - Rule B: Measurement-period markets (close before measurement starts)
 * - Rule C: Objective verifiability (v6.3) - blocks subjective outcomes
 * - Rule D: Manipulation prevention (v6.3) - blocks self-referential markets
 * - Rule E: Approved data sources (v6.3) - enforces verifiable resolution
 * - Race market outcome validation
 * - Question and timing constraints
 */
import { TIMING, FEES } from '../config.js';
import { validateParimutuelRules } from './parimutuel-rules.js';
// =============================================================================
// CONSTANTS
// =============================================================================
const MAX_QUESTION_LENGTH = 200;
const MIN_OUTCOMES = 2;
const MAX_OUTCOMES = 10;
const MAX_OUTCOME_LABEL_LENGTH = 50;
const MIN_RESOLUTION_BUFFER_SECONDS = 600; // 10 minutes
const MAX_MARKET_DURATION_DAYS = 365;
// Rent estimates (lamports)
const MARKET_RENT = 5_000_000; // ~0.005 SOL
const RACE_MARKET_BASE_RENT = 8_000_000; // ~0.008 SOL
const RACE_OUTCOME_RENT = 500_000; // ~0.0005 SOL per outcome
// =============================================================================
// MAIN VALIDATION
// =============================================================================
/**
 * Validate market creation parameters
 */
export function validateMarketCreation(params) {
    const errors = [];
    const warnings = [];
    const suggestions = [];
    // Determine rule type
    let ruleType = 'unknown';
    if (params.marketType === 'event' || params.eventTime) {
        ruleType = 'A';
    }
    else if (params.marketType === 'measurement' || params.measurementStart) {
        ruleType = 'B';
    }
    // =========================================================================
    // Question Validation
    // =========================================================================
    if (!params.question || params.question.trim().length === 0) {
        errors.push('Question is required');
    }
    else if (params.question.length > MAX_QUESTION_LENGTH) {
        errors.push(`Question exceeds ${MAX_QUESTION_LENGTH} characters (got ${params.question.length})`);
    }
    if (!params.question.endsWith('?')) {
        warnings.push('Question should end with a question mark for clarity');
    }
    // =========================================================================
    // Timing Validation
    // =========================================================================
    const now = new Date();
    // Closing time must be in future
    if (params.closingTime <= now) {
        errors.push('Closing time must be in the future');
    }
    // Maximum duration check
    const durationDays = (params.closingTime.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (durationDays > MAX_MARKET_DURATION_DAYS) {
        errors.push(`Market duration exceeds ${MAX_MARKET_DURATION_DAYS} days`);
    }
    // Resolution time must be after closing time
    if (params.resolutionTime <= params.closingTime) {
        errors.push('Resolution time must be after closing time');
    }
    // Minimum resolution buffer
    const resolutionBufferSec = (params.resolutionTime.getTime() - params.closingTime.getTime()) / 1000;
    if (resolutionBufferSec < MIN_RESOLUTION_BUFFER_SECONDS) {
        errors.push(`Resolution buffer too short: ${resolutionBufferSec}s (min ${MIN_RESOLUTION_BUFFER_SECONDS}s)`);
    }
    // =========================================================================
    // Rule A: Event-Based Validation
    // =========================================================================
    let bufferHours;
    let recommendedClosingTime;
    if (ruleType === 'A') {
        if (!params.eventTime) {
            errors.push('Event-based markets require event_time');
        }
        else {
            // Event must be after closing
            if (params.eventTime <= params.closingTime) {
                errors.push('Event time must be after closing time');
            }
            // Calculate buffer
            bufferHours = (params.eventTime.getTime() - params.closingTime.getTime()) / (1000 * 60 * 60);
            if (bufferHours < TIMING.MIN_EVENT_BUFFER_HOURS) {
                errors.push(`Event buffer too short: ${bufferHours.toFixed(1)}h. ` +
                    `Minimum ${TIMING.MIN_EVENT_BUFFER_HOURS}h required (v6.3 Rule A).`);
                // Suggest corrected closing time
                const suggestedClose = new Date(params.eventTime.getTime() - (TIMING.RECOMMENDED_EVENT_BUFFER_HOURS * 60 * 60 * 1000));
                recommendedClosingTime = suggestedClose.toISOString();
                suggestions.push(`Recommended closing time: ${recommendedClosingTime}`);
            }
            else if (bufferHours < 18) {
                warnings.push(`Buffer is ${bufferHours.toFixed(1)}h. ` +
                    `Recommend 18-24h for safety margin (v6.3 Rule A).`);
            }
            // Event must be in future
            if (params.eventTime <= now) {
                errors.push('Event time must be in the future');
            }
        }
    }
    // =========================================================================
    // Rule B: Measurement-Period Validation
    // =========================================================================
    if (ruleType === 'B') {
        if (!params.measurementStart) {
            errors.push('Measurement-period markets require measurement_start');
        }
        else {
            // CRITICAL: Betting must close BEFORE measurement starts
            if (params.closingTime >= params.measurementStart) {
                const overlapHours = (params.closingTime.getTime() - params.measurementStart.getTime()) / (1000 * 60 * 60);
                errors.push(`INVALID: Betting closes ${overlapHours.toFixed(1)}h AFTER measurement starts. ` +
                    `This allows information advantage! (v6.3 Rule B)`);
                // Suggest corrected closing time
                const suggestedClose = new Date(params.measurementStart.getTime() - (60 * 60 * 1000)); // 1h before
                recommendedClosingTime = suggestedClose.toISOString();
                suggestions.push(`Recommended closing time: ${recommendedClosingTime}`);
            }
            // Measurement end validation
            if (params.measurementEnd) {
                if (params.measurementEnd <= params.measurementStart) {
                    errors.push('Measurement end must be after measurement start');
                }
                const periodDays = (params.measurementEnd.getTime() - params.measurementStart.getTime()) / (1000 * 60 * 60 * 24);
                if (periodDays > 7) {
                    warnings.push(`Long measurement period: ${periodDays.toFixed(0)} days. ` +
                        `Prefer 2-7 days for better UX (v6.3 guidance).`);
                }
            }
        }
    }
    // =========================================================================
    // Race Market Validation
    // =========================================================================
    if (params.outcomes) {
        if (params.outcomes.length < MIN_OUTCOMES) {
            errors.push(`Race markets require at least ${MIN_OUTCOMES} outcomes`);
        }
        if (params.outcomes.length > MAX_OUTCOMES) {
            errors.push(`Race markets limited to ${MAX_OUTCOMES} outcomes (got ${params.outcomes.length})`);
        }
        // Check outcome labels
        for (let i = 0; i < params.outcomes.length; i++) {
            const outcome = params.outcomes[i];
            if (!outcome || outcome.trim().length === 0) {
                errors.push(`Outcome ${i} is empty`);
            }
            else if (outcome.length > MAX_OUTCOME_LABEL_LENGTH) {
                errors.push(`Outcome ${i} exceeds ${MAX_OUTCOME_LABEL_LENGTH} characters`);
            }
        }
        // Check for duplicates
        const uniqueOutcomes = new Set(params.outcomes.map(o => o.toLowerCase().trim()));
        if (uniqueOutcomes.size !== params.outcomes.length) {
            errors.push('Outcome labels must be unique');
        }
    }
    // =========================================================================
    // Layer-Specific Validation
    // =========================================================================
    let creationFeeSol;
    let platformFeeBps;
    switch (params.layer) {
        case 'official':
            creationFeeSol = FEES.OFFICIAL_CREATION_FEE / 1e9;
            platformFeeBps = FEES.OFFICIAL_PLATFORM_FEE_BPS;
            warnings.push('Official markets require admin approval');
            break;
        case 'private':
            creationFeeSol = FEES.PRIVATE_CREATION_FEE / 1e9;
            platformFeeBps = FEES.PRIVATE_PLATFORM_FEE_BPS;
            if (!params.inviteHash) {
                warnings.push('Private markets can use invite_hash for restricted access');
            }
            break;
        case 'lab':
        default:
            creationFeeSol = FEES.LAB_CREATION_FEE / 1e9;
            platformFeeBps = FEES.LAB_PLATFORM_FEE_BPS;
            break;
    }
    // =========================================================================
    // Rent Estimation
    // =========================================================================
    let estimatedRentSol;
    if (params.outcomes) {
        estimatedRentSol = (RACE_MARKET_BASE_RENT + (params.outcomes.length * RACE_OUTCOME_RENT)) / 1e9;
    }
    else {
        estimatedRentSol = MARKET_RENT / 1e9;
    }
    // =========================================================================
    // v6.3 Parimutuel Rules Validation (Strict enforcement for Lab markets)
    // =========================================================================
    if (params.layer === 'lab') {
        const parimutuelValidation = validateParimutuelRules({
            question: params.question,
            closingTime: params.closingTime,
            marketType: params.marketType,
            eventTime: params.eventTime,
            measurementStart: params.measurementStart,
            layer: params.layer,
        });
        // Add parimutuel errors (these are blocking for lab markets)
        if (parimutuelValidation.blocked) {
            for (const violation of parimutuelValidation.ruleViolations) {
                if (violation.severity === 'CRITICAL') {
                    errors.push(`[v6.3 ${violation.rule}] ${violation.description}`);
                }
            }
        }
        // Add parimutuel warnings
        for (const warning of parimutuelValidation.warnings) {
            warnings.push(`[v6.3] ${warning}`);
        }
    }
    return {
        valid: errors.length === 0,
        errors,
        warnings,
        suggestions,
        computed: {
            ruleType,
            bufferHours,
            recommendedClosingTime,
            creationFeeSol,
            platformFeeBps,
            estimatedRentSol,
        },
    };
}
// =============================================================================
// HELPER FUNCTIONS
// =============================================================================
/**
 * Calculate recommended resolution time from closing time
 */
export function calculateResolutionTime(closingTime, marketType, eventTime) {
    if (marketType === 'event' && eventTime) {
        // Resolution = event time + 1 hour buffer
        return new Date(eventTime.getTime() + (60 * 60 * 1000));
    }
    // Default: closing time + 1 day
    return new Date(closingTime.getTime() + (24 * 60 * 60 * 1000));
}
/**
 * Calculate recommended closing time for event
 */
export function calculateRecommendedClosingTime(eventTime, bufferHours = TIMING.RECOMMENDED_EVENT_BUFFER_HOURS) {
    return new Date(eventTime.getTime() - (bufferHours * 60 * 60 * 1000));
}
/**
 * Get creation fee for layer
 */
export function getCreationFee(layer) {
    let lamports;
    switch (layer) {
        case 'official':
            lamports = FEES.OFFICIAL_CREATION_FEE;
            break;
        case 'private':
            lamports = FEES.PRIVATE_CREATION_FEE;
            break;
        case 'lab':
        default:
            lamports = FEES.LAB_CREATION_FEE;
            break;
    }
    return { lamports, sol: lamports / 1e9 };
}
/**
 * Validate question format
 */
export function validateQuestion(question) {
    const errors = [];
    const suggestions = [];
    if (!question || question.trim().length === 0) {
        errors.push('Question is required');
    }
    else {
        if (question.length > MAX_QUESTION_LENGTH) {
            errors.push(`Question exceeds ${MAX_QUESTION_LENGTH} characters`);
        }
        if (!question.endsWith('?')) {
            suggestions.push('Add a question mark at the end');
        }
        if (question.length < 10) {
            suggestions.push('Consider a more descriptive question');
        }
    }
    return { valid: errors.length === 0, errors, suggestions };
}
/**
 * Validate race outcomes
 */
export function validateRaceOutcomes(outcomes) {
    const errors = [];
    if (outcomes.length < MIN_OUTCOMES) {
        errors.push(`Minimum ${MIN_OUTCOMES} outcomes required`);
    }
    if (outcomes.length > MAX_OUTCOMES) {
        errors.push(`Maximum ${MAX_OUTCOMES} outcomes allowed`);
    }
    for (let i = 0; i < outcomes.length; i++) {
        if (!outcomes[i] || outcomes[i].trim().length === 0) {
            errors.push(`Outcome ${i + 1} is empty`);
        }
        else if (outcomes[i].length > MAX_OUTCOME_LABEL_LENGTH) {
            errors.push(`Outcome ${i + 1} exceeds ${MAX_OUTCOME_LABEL_LENGTH} chars`);
        }
    }
    const unique = new Set(outcomes.map(o => o.toLowerCase().trim()));
    if (unique.size !== outcomes.length) {
        errors.push('Outcomes must be unique');
    }
    return { valid: errors.length === 0, errors };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRpb24tcnVsZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdmFsaWRhdGlvbi9jcmVhdGlvbi1ydWxlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7R0FXRztBQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFnQixNQUFNLGNBQWMsQ0FBQztBQUMxRCxPQUFPLEVBQUUsdUJBQXVCLEVBQW9CLE1BQU0sdUJBQXVCLENBQUM7QUE0Q2xGLGdGQUFnRjtBQUNoRixZQUFZO0FBQ1osZ0ZBQWdGO0FBRWhGLE1BQU0sbUJBQW1CLEdBQUcsR0FBRyxDQUFDO0FBQ2hDLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQztBQUN2QixNQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDeEIsTUFBTSx3QkFBd0IsR0FBRyxFQUFFLENBQUM7QUFDcEMsTUFBTSw2QkFBNkIsR0FBRyxHQUFHLENBQUMsQ0FBQyxhQUFhO0FBQ3hELE1BQU0sd0JBQXdCLEdBQUcsR0FBRyxDQUFDO0FBRXJDLDRCQUE0QjtBQUM1QixNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUMsQ0FBQyxhQUFhO0FBQzVDLE1BQU0scUJBQXFCLEdBQUcsU0FBUyxDQUFDLENBQUMsYUFBYTtBQUN0RCxNQUFNLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxDQUFDLDBCQUEwQjtBQUU3RCxnRkFBZ0Y7QUFDaEYsa0JBQWtCO0FBQ2xCLGdGQUFnRjtBQUVoRjs7R0FFRztBQUNILE1BQU0sVUFBVSxzQkFBc0IsQ0FBQyxNQUEwQjtJQUMvRCxNQUFNLE1BQU0sR0FBYSxFQUFFLENBQUM7SUFDNUIsTUFBTSxRQUFRLEdBQWEsRUFBRSxDQUFDO0lBQzlCLE1BQU0sV0FBVyxHQUFhLEVBQUUsQ0FBQztJQUVqQyxzQkFBc0I7SUFDdEIsSUFBSSxRQUFRLEdBQTBCLFNBQVMsQ0FBQztJQUNoRCxJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssT0FBTyxJQUFJLE1BQU0s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QUcsQ0FBQyxZQUFZLHdCQUF3QixRQUFRLENBQUMsQ0FBQztRQUM1RSxDQUFDO0lBQ0gsQ0FBQztJQUVELE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDO0FBQ2hELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIE1hcmtldCBDcmVhdGlvbiBWYWxpZGF0aW9uIFJ1bGVzICh2Ni4zIENvbXBsaWFudClcbiAqXG4gKiBJbXBsZW1lbnRzIHZhbGlkYXRpb24gZm9yOlxuICogLSBSdWxlIEE6IEV2ZW50LWJhc2VkIG1hcmtldHMgKDEyLTI0aCBidWZmZXIgYmVmb3JlIGV2ZW50KVxuICogLSBSdWxlIEI6IE1lYXN1cmVtZW50LXBlcmlvZCBtYXJrZXRzIChjbG9zZSBiZWZvcmUgbWVhc3VyZW1lbnQgc3RhcnRzKVxuICogLSBSdWxlIEM6IE9iamVjdGl2ZSB2ZXJpZmlhYmlsaXR5ICh2Ni4zKSAtIGJsb2NrcyBzdWJqZWN0aXZlIG91dGNvbWVzXG4gKiAtIFJ1bGUgRDogTWFuaXB1bGF0aW9uIHByZXZlbnRpb24gKHY2LjMpIC0gYmxvY2tzIHNlbGYtcmVmZXJlbnRpYWwgbWFya2V0c1xuICogLSBSdWxlIEU6IEFwcHJvdmVkIGRhdGEgc291cmNlcyAodjYuMykgLSBlbmZvcmNlcyB2ZXJpZmlhYmxlIHJlc29sdXRpb25cbiAqIC0gUmFjZSBtYXJrZXQgb3V0Y29tZSB2YWxpZGF0aW9uXG4gKiAtIFF1ZXN0aW9uIGFuZCB0aW1pbmcgY29uc3RyYWludHNcbiAqL1xuXG5pbXBvcnQgeyBUSU1JTkcsIEZFRVMsIE1BUktFVF9MQVlFUiB9IGZyb20gJy4uL2NvbmZpZy5qcyc7XG5pbXBvcnQgeyB2YWxpZGF0ZVBhcmltdXR1ZWxSdWxlcywgUEFSSU1VVFVFTF9SVUxFUyB9IGZyb20gJy4vcGFyaW11dHVlbC1ydWxlcy5qcyc7XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBUWVBFU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGludGVyZmFjZSBDcmVhdGVNYXJrZXRQYXJhbXMge1xuICBxdWVzdGlvbjogc3RyaW5nO1xuICBjbG9zaW5nVGltZTogRGF0ZTtcbiAgcmVzb2x1dGlvblRpbWU6IERhdGU7XG4gIGxheWVyOiAnb2ZmaWNpYWwnIHwgJ2xhYicgfCAncHJpdmF0ZSc7XG5cbiAgLy8gRXZlbnQtYmFzZWQgKFJ1bGUgQSlcbiAgbWFya2V0VHlwZT86ICdldmVudCcgfCAnbWVhc3VyZW1lbnQnO1xuICBldmVudFRpbWU/OiBEYXRlO1xuXG4gIC8vIE1lYXN1cmVtZW50LXBlcmlvZCAoUnVsZSBCKVxuICBtZWFzdXJlbWVudFN0YXJ0PzogRGF0ZTtcbiAgbWVhc3VyZW1lbnRFbmQ/OiBEYXRlO1xuXG4gIC8vIFJhY2UgbWFya2V0c1xuICBvdXRjb21lcz86IHN0cmluZ1tdO1xuXG4gIC8vIFByaXZhdGUgbWFya2V0XG4gIGludml0ZUhhc2g/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3JlYXRpb25WYWxpZGF0aW9uUmVzdWx0IHtcbiAgdmFsaWQ6IGJvb2xlYW47XG4gIGVycm9yczogc3RyaW5nW107XG4gIHdhcm5pbmdzOiBzdHJpbmdbXTtcbiAgc3VnZ2VzdGlvbnM6IHN0cmluZ1tdO1xuXG4gIC8vIENvbXB1dGVkIHZhbHVlc1xuICBjb21wdXRlZDoge1xuICAgIHJ1bGVUeXBlOiAnQScgfCAnQicgfCAndW5rbm93bic7XG4gICAgYnVmZmVySG91cnM/OiBudW1iZXI7XG4gICAgcmVjb21tZW5kZWRDbG9zaW5nVGltZT86IHN0cmluZztcbiAgICBjcmVhdGlvbkZlZVNvbDogbnVtYmVyO1xuICAgIHBsYXRmb3JtRmVlQnBzOiBudW1iZXI7XG4gICAgZXN0aW1hdGVkUmVudFNvbDogbnVtYmVyO1xuICB9O1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gQ09OU1RBTlRTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5jb25zdCBNQVhfUVVFU1RJT05fTEVOR1RIID0gMjAwO1xuY29uc3QgTUlOX09VVENPTUVTID0gMjtcbmNvbnN0IE1BWF9PVVRDT01FUyA9IDEwO1xuY29uc3QgTUFYX09VVENPTUVfTEFCRUxfTEVOR1RIID0gNTA7XG5jb25zdCBNSU5fUkVTT0xVVElPTl9CVUZGRVJfU0VDT05EUyA9IDYwMDsgLy8gMTAgbWludXRlc1xuY29uc3QgTUFYX01BUktFVF9EVVJBVElPTl9EQVlTID0gMzY1O1xuXG4vLyBSZW50IGVzdGltYXRlcyAobGFtcG9ydHMpXG5jb25zdCBNQVJLRVRfUkVOVCA9IDVfMDAwXzAwMDsgLy8gfjAuMDA1IFNPTFxuY29uc3QgUkFDRV9NQVJLRVRfQkFTRV9SRU5UID0gOF8wMDBfMDAwOyAvLyB+MC4wMDggU09MXG5jb25zdCBSQUNFX09VVENPTUVfUkVOVCA9IDUwMF8wMDA7IC8vIH4wLjAwMDUgU09MIHBlciBvdXRjb21lXG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBNQUlOIFZBTElEQVRJT05cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogVmFsaWRhdGUgbWFya2V0IGNyZWF0aW9uIHBhcmFtZXRlcnNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlTWFya2V0Q3JlYXRpb24ocGFyYW1zOiBDcmVhdGVNYXJrZXRQYXJhbXMpOiBDcmVhdGlvblZhbGlkYXRpb25SZXN1bHQge1xuICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IHdhcm5pbmdzOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCBzdWdnZXN0aW9uczogc3RyaW5nW10gPSBbXTtcblxuICAvLyBEZXRlcm1pbmUgcnVsZSB0eXBlXG4gIGxldCBydWxlVHlwZTogJ0EnIHwgJ0InIHwgJ3Vua25vd24nID0gJ3Vua25vd24nO1xuICBpZiAocGFyYW1zLm1hcmtldFR5cGUgPT09ICdldmVudCcgfHwgcGFyYW1zLmV2ZW50VGltZSkge1xuICAgIHJ1bGVUeXBlID0gJ0EnO1xuICB9IGVsc2UgaWYgKHBhcmFtcy5tYXJrZXRUeXBlID09PSAnbWVhc3VyZW1lbnQnIHx8IHBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0KSB7XG4gICAgcnVsZVR5cGUgPSAnQic7XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIFF1ZXN0aW9uIFZhbGlkYXRpb25cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIGlmICghcGFyYW1zLnF1ZXN0aW9uIHx8IHBhcmFtcy5xdWVzdGlvbi50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgZXJyb3JzLnB1c2goJ1F1ZXN0aW9uIGlzIHJlcXVpcmVkJyk7XG4gIH0gZWxzZSBpZiAocGFyYW1zLnF1ZXN0aW9uLmxlbmd0aCA+IE1BWF9RVUVTVElPTl9MRU5HVEgpIHtcbiAgICBlcnJvcnMucHVzaChgUXVlc3Rpb24gZXhjZWVkcyAke01BWF9RVUVTVElPTl9MRU5HVEh9IGNoYXJhY3RlcnMgKGdvdCAke3BhcmFtcy5xdWVzdGlvbi5sZW5ndGh9KWApO1xuICB9XG5cbiAgaWYgKCFwYXJhbXMucXVlc3Rpb24uZW5kc1dpdGgoJz8nKSkge1xuICAgIHdhcm5pbmdzLnB1c2goJ1F1ZXN0aW9uIHNob3VsZCBlbmQgd2l0aCBhIHF1ZXN0aW9uIG1hcmsgZm9yIGNsYXJpdHknKTtcbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gVGltaW5nIFZhbGlkYXRpb25cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG5cbiAgLy8gQ2xvc2luZyB0aW1lIG11c3QgYmUgaW4gZnV0dXJlXG4gIGlmIChwYXJhbXMuY2xvc2luZ1RpbWUgPD0gbm93KSB7XG4gICAgZXJyb3JzLnB1c2goJ0Nsb3NpbmcgdGltZSBtdXN0IGJlIGluIHRoZSBmdXR1cmUnKTtcbiAgfVxuXG4gIC8vIE1heGltdW0gZHVyYXRpb24gY2hlY2tcbiAgY29uc3QgZHVyYXRpb25EYXlzID0gKHBhcmFtcy5jbG9zaW5nVGltZS5nZXRUaW1lKCkgLSBub3cuZ2V0VGltZSgpKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KTtcbiAgaWYgKGR1cmF0aW9uRGF5cyA+IE1BWF9NQVJLRVRfRFVSQVRJT05fREFZUykge1xuICAgIGVycm9ycy5wdXNoKGBNYXJrZXQgZHVyYXRpb24gZXhjZWVkcyAke01BWF9NQVJLRVRfRFVSQVRJT05fREFZU30gZGF5c2ApO1xuICB9XG5cbiAgLy8gUmVzb2x1dGlvbiB0aW1lIG11c3QgYmUgYWZ0ZXIgY2xvc2luZyB0aW1lXG4gIGlmIChwYXJhbXMucmVzb2x1dGlvblRpbWUgPD0gcGFyYW1zLmNsb3NpbmdUaW1lKSB7XG4gICAgZXJyb3JzLnB1c2goJ1Jlc29sdXRpb24gdGltZSBtdXN0IGJlIGFmdGVyIGNsb3NpbmcgdGltZScpO1xuICB9XG5cbiAgLy8gTWluaW11bSByZXNvbHV0aW9uIGJ1ZmZlclxuICBjb25zdCByZXNvbHV0aW9uQnVmZmVyU2VjID0gKHBhcmFtcy5yZXNvbHV0aW9uVGltZS5nZXRUaW1lKCkgLSBwYXJhbXMuY2xvc2luZ1RpbWUuZ2V0VGltZSgpKSAvIDEwMDA7XG4gIGlmIChyZXNvbHV0aW9uQnVmZmVyU2VjIDwgTUlOX1JFU09MVVRJT05fQlVGRkVSX1NFQ09ORFMpIHtcbiAgICBlcnJvcnMucHVzaChgUmVzb2x1dGlvbiBidWZmZXIgdG9vIHNob3J0OiAke3Jlc29sdXRpb25CdWZmZXJTZWN9cyAobWluICR7TUlOX1JFU09MVVRJT05fQlVGRkVSX1NFQ09ORFN9cylgKTtcbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gUnVsZSBBOiBFdmVudC1CYXNlZCBWYWxpZGF0aW9uXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBsZXQgYnVmZmVySG91cnM6IG51bWJlciB8IHVuZGVmaW5lZDtcbiAgbGV0IHJlY29tbWVuZGVkQ2xvc2luZ1RpbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICBpZiAocnVsZVR5cGUgPT09ICdBJykge1xuICAgIGlmICghcGFyYW1zLmV2ZW50VGltZSkge1xuICAgICAgZXJyb3JzLnB1c2goJ0V2ZW50LWJhc2VkIG1hcmtldHMgcmVxdWlyZSBldmVudF90aW1lJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEV2ZW50IG11c3QgYmUgYWZ0ZXIgY2xvc2luZ1xuICAgICAgaWYgKHBhcmFtcy5ldmVudFRpbWUgPD0gcGFyYW1zLmNsb3NpbmdUaW1lKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdFdmVudCB0aW1lIG11c3QgYmUgYWZ0ZXIgY2xvc2luZyB0aW1lJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIENhbGN1bGF0ZSBidWZmZXJcbiAgICAgIGJ1ZmZlckhvdXJzID0gKHBhcmFtcy5ldmVudFRpbWUuZ2V0VGltZSgpIC0gcGFyYW1zLmNsb3NpbmdUaW1lLmdldFRpbWUoKSkgLyAoMTAwMCAqIDYwICogNjApO1xuXG4gICAgICBpZiAoYnVmZmVySG91cnMgPCBUSU1JTkcuTUlOX0VWRU5UX0JVRkZFUl9IT1VSUykge1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICBgRXZlbnQgYnVmZmVyIHRvbyBzaG9ydDogJHtidWZmZXJIb3Vycy50b0ZpeGVkKDEpfWguIGAgK1xuICAgICAgICAgIGBNaW5pbXVtICR7VElNSU5HLk1JTl9FVkVOVF9CVUZGRVJfSE9VUlN9aCByZXF1aXJlZCAodjYuMyBSdWxlIEEpLmBcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBTdWdnZXN0IGNvcnJlY3RlZCBjbG9zaW5nIHRpbWVcbiAgICAgICAgY29uc3Qgc3VnZ2VzdGVkQ2xvc2UgPSBuZXcgRGF0ZShcbiAgICAgICAgICBwYXJhbXMuZXZlbnRUaW1lLmdldFRpbWUoKSAtIChUSU1JTkcuUkVDT01NRU5ERURfRVZFTlRfQlVGRkVSX0hPVVJTICogNjAgKiA2MCAqIDEwMDApXG4gICAgICAgICk7XG4gICAgICAgIHJlY29tbWVuZGVkQ2xvc2luZ1RpbWUgPSBzdWdnZXN0ZWRDbG9zZS50b0lTT1N0cmluZygpO1xuICAgICAgICBzdWdnZXN0aW9ucy5wdXNoKGBSZWNvbW1lbmRlZCBjbG9zaW5nIHRpbWU6ICR7cmVjb21tZW5kZWRDbG9zaW5nVGltZX1gKTtcbiAgICAgIH0gZWxzZSBpZiAoYnVmZmVySG91cnMgPCAxOCkge1xuICAgICAgICB3YXJuaW5ncy5wdXNoKFxuICAgICAgICAgIGBCdWZmZXIgaXMgJHtidWZmZXJIb3Vycy50b0ZpeGVkKDEpfWguIGAgK1xuICAgICAgICAgIGBSZWNvbW1lbmQgMTgtMjRoIGZvciBzYWZldHkgbWFyZ2luICh2Ni4zIFJ1bGUgQSkuYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBFdmVudCBtdXN0IGJlIGluIGZ1dHVyZVxuICAgICAgaWYgKHBhcmFtcy5ldmVudFRpbWUgPD0gbm93KSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdFdmVudCB0aW1lIG11c3QgYmUgaW4gdGhlIGZ1dHVyZScpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gUnVsZSBCOiBNZWFzdXJlbWVudC1QZXJpb2QgVmFsaWRhdGlvblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgaWYgKHJ1bGVUeXBlID09PSAnQicpIHtcbiAgICBpZiAoIXBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0KSB7XG4gICAgICBlcnJvcnMucHVzaCgnTWVhc3VyZW1lbnQtcGVyaW9kIG1hcmtldHMgcmVxdWlyZSBtZWFzdXJlbWVudF9zdGFydCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBDUklUSUNBTDogQmV0dGluZyBtdXN0IGNsb3NlIEJFRk9SRSBtZWFzdXJlbWVudCBzdGFydHNcbiAgICAgIGlmIChwYXJhbXMuY2xvc2luZ1RpbWUgPj0gcGFyYW1zLm1lYXN1cmVtZW50U3RhcnQpIHtcbiAgICAgICAgY29uc3Qgb3ZlcmxhcEhvdXJzID0gKHBhcmFtcy5jbG9zaW5nVGltZS5nZXRUaW1lKCkgLSBwYXJhbXMubWVhc3VyZW1lbnRTdGFydC5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCAqIDYwKTtcbiAgICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgICAgYElOVkFMSUQ6IEJldHRpbmcgY2xvc2VzICR7b3ZlcmxhcEhvdXJzLnRvRml4ZWQoMSl9aCBBRlRFUiBtZWFzdXJlbWVudCBzdGFydHMuIGAgK1xuICAgICAgICAgIGBUaGlzIGFsbG93cyBpbmZvcm1hdGlvbiBhZHZhbnRhZ2UhICh2Ni4zIFJ1bGUgQilgXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gU3VnZ2VzdCBjb3JyZWN0ZWQgY2xvc2luZyB0aW1lXG4gICAgICAgIGNvbnN0IHN1Z2dlc3RlZENsb3NlID0gbmV3IERhdGUocGFyYW1zLm1lYXN1cmVtZW50U3RhcnQuZ2V0VGltZSgpIC0gKDYwICogNjAgKiAxMDAwKSk7IC8vIDFoIGJlZm9yZVxuICAgICAgICByZWNvbW1lbmRlZENsb3NpbmdUaW1lID0gc3VnZ2VzdGVkQ2xvc2UudG9JU09TdHJpbmcoKTtcbiAgICAgICAgc3VnZ2VzdGlvbnMucHVzaChgUmVjb21tZW5kZWQgY2xvc2luZyB0aW1lOiAke3JlY29tbWVuZGVkQ2xvc2luZ1RpbWV9YCk7XG4gICAgICB9XG5cbiAgICAgIC8vIE1lYXN1cmVtZW50IGVuZCB2YWxpZGF0aW9uXG4gICAgICBpZiAocGFyYW1zLm1lYXN1cmVtZW50RW5kKSB7XG4gICAgICAgIGlmIChwYXJhbXMubWVhc3VyZW1lbnRFbmQgPD0gcGFyYW1zLm1lYXN1cmVtZW50U3RhcnQpIHtcbiAgICAgICAgICBlcnJvcnMucHVzaCgnTWVhc3VyZW1lbnQgZW5kIG11c3QgYmUgYWZ0ZXIgbWVhc3VyZW1lbnQgc3RhcnQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBlcmlvZERheXMgPSAocGFyYW1zLm1lYXN1cmVtZW50RW5kLmdldFRpbWUoKSAtIHBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0LmdldFRpbWUoKSkgLyAoMTAwMCAqIDYwICogNjAgKiAyNCk7XG4gICAgICAgIGlmIChwZXJpb2REYXlzID4gNykge1xuICAgICAgICAgIHdhcm5pbmdzLnB1c2goXG4gICAgICAgICAgICBgTG9uZyBtZWFzdXJlbWVudCBwZXJpb2Q6ICR7cGVyaW9kRGF5cy50b0ZpeGVkKDApfSBkYXlzLiBgICtcbiAgICAgICAgICAgIGBQcmVmZXIgMi03IGRheXMgZm9yIGJldHRlciBVWCAodjYuMyBndWlkYW5jZSkuYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIFJhY2UgTWFya2V0IFZhbGlkYXRpb25cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIGlmIChwYXJhbXMub3V0Y29tZXMpIHtcbiAgICBpZiAocGFyYW1zLm91dGNvbWVzLmxlbmd0aCA8IE1JTl9PVVRDT01FUykge1xuICAgICAgZXJyb3JzLnB1c2goYFJhY2UgbWFya2V0cyByZXF1aXJlIGF0IGxlYXN0ICR7TUlOX09VVENPTUVTfSBvdXRjb21lc2ApO1xuICAgIH1cbiAgICBpZiAocGFyYW1zLm91dGNvbWVzLmxlbmd0aCA+IE1BWF9PVVRDT01FUykge1xuICAgICAgZXJyb3JzLnB1c2goYFJhY2UgbWFya2V0cyBsaW1pdGVkIHRvICR7TUFYX09VVENPTUVTfSBvdXRjb21lcyAoZ290ICR7cGFyYW1zLm91dGNvbWVzLmxlbmd0aH0pYCk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgb3V0Y29tZSBsYWJlbHNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmFtcy5vdXRjb21lcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3Qgb3V0Y29tZSA9IHBhcmFtcy5vdXRjb21lc1tpXTtcbiAgICAgIGlmICghb3V0Y29tZSB8fCBvdXRjb21lLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYE91dGNvbWUgJHtpfSBpcyBlbXB0eWApO1xuICAgICAgfSBlbHNlIGlmIChvdXRjb21lLmxlbmd0aCA+IE1BWF9PVVRDT01FX0xBQkVMX0xFTkdUSCkge1xuICAgICAgICBlcnJvcnMucHVzaChgT3V0Y29tZSAke2l9IGV4Y2VlZHMgJHtNQVhfT1VUQ09NRV9MQUJFTF9MRU5HVEh9IGNoYXJhY3RlcnNgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgZHVwbGljYXRlc1xuICAgIGNvbnN0IHVuaXF1ZU91dGNvbWVzID0gbmV3IFNldChwYXJhbXMub3V0Y29tZXMubWFwKG8gPT4gby50b0xvd2VyQ2FzZSgpLnRyaW0oKSkpO1xuICAgIGlmICh1bmlxdWVPdXRjb21lcy5zaXplICE9PSBwYXJhbXMub3V0Y29tZXMubGVuZ3RoKSB7XG4gICAgICBlcnJvcnMucHVzaCgnT3V0Y29tZSBsYWJlbHMgbXVzdCBiZSB1bmlxdWUnKTtcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIExheWVyLVNwZWNpZmljIFZhbGlkYXRpb25cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIGxldCBjcmVhdGlvbkZlZVNvbDogbnVtYmVyO1xuICBsZXQgcGxhdGZvcm1GZWVCcHM6IG51bWJlcjtcblxuICBzd2l0Y2ggKHBhcmFtcy5sYXllcikge1xuICAgIGNhc2UgJ29mZmljaWFsJzpcbiAgICAgIGNyZWF0aW9uRmVlU29sID0gRkVFUy5PRkZJQ0lBTF9DUkVBVElPTl9GRUUgLyAxZTk7XG4gICAgICBwbGF0Zm9ybUZlZUJwcyA9IEZFRVMuT0ZGSUNJQUxfUExBVEZPUk1fRkVFX0JQUztcbiAgICAgIHdhcm5pbmdzLnB1c2goJ09mZmljaWFsIG1hcmtldHMgcmVxdWlyZSBhZG1pbiBhcHByb3ZhbCcpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAncHJpdmF0ZSc6XG4gICAgICBjcmVhdGlvbkZlZVNvbCA9IEZFRVMuUFJJVkFURV9DUkVBVElPTl9GRUUgLyAxZTk7XG4gICAgICBwbGF0Zm9ybUZlZUJwcyA9IEZFRVMuUFJJVkFURV9QTEFURk9STV9GRUVfQlBTO1xuICAgICAgaWYgKCFwYXJhbXMuaW52aXRlSGFzaCkge1xuICAgICAgICB3YXJuaW5ncy5wdXNoKCdQcml2YXRlIG1hcmtldHMgY2FuIHVzZSBpbnZpdGVfaGFzaCBmb3IgcmVzdHJpY3RlZCBhY2Nlc3MnKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2xhYic6XG4gICAgZGVmYXVsdDpcbiAgICAgIGNyZWF0aW9uRmVlU29sID0gRkVFUy5MQUJfQ1JFQVRJT05fRkVFIC8gMWU5O1xuICAgICAgcGxhdGZvcm1GZWVCcHMgPSBGRUVTLkxBQl9QTEFURk9STV9GRUVfQlBTO1xuICAgICAgYnJlYWs7XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIFJlbnQgRXN0aW1hdGlvblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgbGV0IGVzdGltYXRlZFJlbnRTb2w6IG51bWJlcjtcbiAgaWYgKHBhcmFtcy5vdXRjb21lcykge1xuICAgIGVzdGltYXRlZFJlbnRTb2wgPSAoUkFDRV9NQVJLRVRfQkFTRV9SRU5UICsgKHBhcmFtcy5vdXRjb21lcy5sZW5ndGggKiBSQUNFX09VVENPTUVfUkVOVCkpIC8gMWU5O1xuICB9IGVsc2Uge1xuICAgIGVzdGltYXRlZFJlbnRTb2wgPSBNQVJLRVRfUkVOVCAvIDFlOTtcbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gdjYuMyBQYXJpbXV0dWVsIFJ1bGVzIFZhbGlkYXRpb24gKFN0cmljdCBlbmZvcmNlbWVudCBmb3IgTGFiIG1hcmtldHMpXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBpZiAocGFyYW1zLmxheWVyID09PSAnbGFiJykge1xuICAgIGNvbnN0IHBhcmltdXR1ZWxWYWxpZGF0aW9uID0gdmFsaWRhdGVQYXJpbXV0dWVsUnVsZXMoe1xuICAgICAgcXVlc3Rpb246IHBhcmFtcy5xdWVzdGlvbixcbiAgICAgIGNsb3NpbmdUaW1lOiBwYXJhbXMuY2xvc2luZ1RpbWUsXG4gICAgICBtYXJrZXRUeXBlOiBwYXJhbXMubWFya2V0VHlwZSxcbiAgICAgIGV2ZW50VGltZTogcGFyYW1zLmV2ZW50VGltZSxcbiAgICAgIG1lYXN1cmVtZW50U3RhcnQ6IHBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0LFxuICAgICAgbGF5ZXI6IHBhcmFtcy5sYXllcixcbiAgICB9KTtcblxuICAgIC8vIEFkZCBwYXJpbXV0dWVsIGVycm9ycyAodGhlc2UgYXJlIGJsb2NraW5nIGZvciBsYWIgbWFya2V0cylcbiAgICBpZiAocGFyaW11dHVlbFZhbGlkYXRpb24uYmxvY2tlZCkge1xuICAgICAgZm9yIChjb25zdCB2aW9sYXRpb24gb2YgcGFyaW11dHVlbFZhbGlkYXRpb24ucnVsZVZpb2xhdGlvbnMpIHtcbiAgICAgICAgaWYgKHZpb2xhdGlvbi5zZXZlcml0eSA9PT0gJ0NSSVRJQ0FMJykge1xuICAgICAgICAgIGVycm9ycy5wdXNoKGBbdjYuMyAke3Zpb2xhdGlvbi5ydWxlfV0gJHt2aW9sYXRpb24uZGVzY3JpcHRpb259YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBZGQgcGFyaW11dHVlbCB3YXJuaW5nc1xuICAgIGZvciAoY29uc3Qgd2FybmluZyBvZiBwYXJpbXV0dWVsVmFsaWRhdGlvbi53YXJuaW5ncykge1xuICAgICAgd2FybmluZ3MucHVzaChgW3Y2LjNdICR7d2FybmluZ31gKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLFxuICAgIGVycm9ycyxcbiAgICB3YXJuaW5ncyxcbiAgICBzdWdnZXN0aW9ucyxcbiAgICBjb21wdXRlZDoge1xuICAgICAgcnVsZVR5cGUsXG4gICAgICBidWZmZXJIb3VycyxcbiAgICAgIHJlY29tbWVuZGVkQ2xvc2luZ1RpbWUsXG4gICAgICBjcmVhdGlvbkZlZVNvbCxcbiAgICAgIHBsYXRmb3JtRmVlQnBzLFxuICAgICAgZXN0aW1hdGVkUmVudFNvbCxcbiAgICB9LFxuICB9O1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gSEVMUEVSIEZVTkNUSU9OU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBDYWxjdWxhdGUgcmVjb21tZW5kZWQgcmVzb2x1dGlvbiB0aW1lIGZyb20gY2xvc2luZyB0aW1lXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVSZXNvbHV0aW9uVGltZShcbiAgY2xvc2luZ1RpbWU6IERhdGUsXG4gIG1hcmtldFR5cGU6ICdldmVudCcgfCAnbWVhc3VyZW1lbnQnLFxuICBldmVudFRpbWU/OiBEYXRlXG4pOiBEYXRlIHtcbiAgaWYgKG1hcmtldFR5cGUgPT09ICdldmVudCcgJiYgZXZlbnRUaW1lKSB7XG4gICAgLy8gUmVzb2x1dGlvbiA9IGV2ZW50IHRpbWUgKyAxIGhvdXIgYnVmZmVyXG4gICAgcmV0dXJuIG5ldyBEYXRlKGV2ZW50VGltZS5nZXRUaW1lKCkgKyAoNjAgKiA2MCAqIDEwMDApKTtcbiAgfVxuICAvLyBEZWZhdWx0OiBjbG9zaW5nIHRpbWUgKyAxIGRheVxuICByZXR1cm4gbmV3IERhdGUoY2xvc2luZ1RpbWUuZ2V0VGltZSgpICsgKDI0ICogNjAgKiA2MCAqIDEwMDApKTtcbn1cblxuLyoqXG4gKiBDYWxjdWxhdGUgcmVjb21tZW5kZWQgY2xvc2luZyB0aW1lIGZvciBldmVudFxuICovXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlUmVjb21tZW5kZWRDbG9zaW5nVGltZShcbiAgZXZlbnRUaW1lOiBEYXRlLFxuICBidWZmZXJIb3VyczogbnVtYmVyID0gVElNSU5HLlJFQ09NTUVOREVEX0VWRU5UX0JVRkZFUl9IT1VSU1xuKTogRGF0ZSB7XG4gIHJldHVybiBuZXcgRGF0ZShldmVudFRpbWUuZ2V0VGltZSgpIC0gKGJ1ZmZlckhvdXJzICogNjAgKiA2MCAqIDEwMDApKTtcbn1cblxuLyoqXG4gKiBHZXQgY3JlYXRpb24gZmVlIGZvciBsYXllclxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3JlYXRpb25GZWUobGF5ZXI6ICdvZmZpY2lhbCcgfCAnbGFiJyB8ICdwcml2YXRlJyk6IHtcbiAgbGFtcG9ydHM6IG51bWJlcjtcbiAgc29sOiBudW1iZXI7XG59IHtcbiAgbGV0IGxhbXBvcnRzOiBudW1iZXI7XG4gIHN3aXRjaCAobGF5ZXIpIHtcbiAgICBjYXNlICdvZmZpY2lhbCc6XG4gICAgICBsYW1wb3J0cyA9IEZFRVMuT0ZGSUNJQUxfQ1JFQVRJT05fRkVFO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAncHJpdmF0ZSc6XG4gICAgICBsYW1wb3J0cyA9IEZFRVMuUFJJVkFURV9DUkVBVElPTl9GRUU7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdsYWInOlxuICAgIGRlZmF1bHQ6XG4gICAgICBsYW1wb3J0cyA9IEZFRVMuTEFCX0NSRUFUSU9OX0ZFRTtcbiAgICAgIGJyZWFrO1xuICB9XG4gIHJldHVybiB7IGxhbXBvcnRzLCBzb2w6IGxhbXBvcnRzIC8gMWU5IH07XG59XG5cbi8qKlxuICogVmFsaWRhdGUgcXVlc3Rpb24gZm9ybWF0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVF1ZXN0aW9uKHF1ZXN0aW9uOiBzdHJpbmcpOiB7XG4gIHZhbGlkOiBib29sZWFuO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xuICBzdWdnZXN0aW9uczogc3RyaW5nW107XG59IHtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCBzdWdnZXN0aW9uczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAoIXF1ZXN0aW9uIHx8IHF1ZXN0aW9uLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICBlcnJvcnMucHVzaCgnUXVlc3Rpb24gaXMgcmVxdWlyZWQnKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAocXVlc3Rpb24ubGVuZ3RoID4gTUFYX1FVRVNUSU9OX0xFTkdUSCkge1xuICAgICAgZXJyb3JzLnB1c2goYFF1ZXN0aW9uIGV4Y2VlZHMgJHtNQVhfUVVFU1RJT05fTEVOR1RIfSBjaGFyYWN0ZXJzYCk7XG4gICAgfVxuICAgIGlmICghcXVlc3Rpb24uZW5kc1dpdGgoJz8nKSkge1xuICAgICAgc3VnZ2VzdGlvbnMucHVzaCgnQWRkIGEgcXVlc3Rpb24gbWFyayBhdCB0aGUgZW5kJyk7XG4gICAgfVxuICAgIGlmIChxdWVzdGlvbi5sZW5ndGggPCAxMCkge1xuICAgICAgc3VnZ2VzdGlvbnMucHVzaCgnQ29uc2lkZXIgYSBtb3JlIGRlc2NyaXB0aXZlIHF1ZXN0aW9uJyk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHsgdmFsaWQ6IGVycm9ycy5sZW5ndGggPT09IDAsIGVycm9ycywgc3VnZ2VzdGlvbnMgfTtcbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSByYWNlIG91dGNvbWVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVJhY2VPdXRjb21lcyhvdXRjb21lczogc3RyaW5nW10pOiB7XG4gIHZhbGlkOiBib29sZWFuO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xufSB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAob3V0Y29tZXMubGVuZ3RoIDwgTUlOX09VVENPTUVTKSB7XG4gICAgZXJyb3JzLnB1c2goYE1pbmltdW0gJHtNSU5fT1VUQ09NRVN9IG91dGNvbWVzIHJlcXVpcmVkYCk7XG4gIH1cbiAgaWYgKG91dGNvbWVzLmxlbmd0aCA+IE1BWF9PVVRDT01FUykge1xuICAgIGVycm9ycy5wdXNoKGBNYXhpbXVtICR7TUFYX09VVENPTUVTfSBvdXRjb21lcyBhbGxvd2VkYCk7XG4gIH1cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IG91dGNvbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKCFvdXRjb21lc1tpXSB8fCBvdXRjb21lc1tpXS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICBlcnJvcnMucHVzaChgT3V0Y29tZSAke2kgKyAxfSBpcyBlbXB0eWApO1xuICAgIH0gZWxzZSBpZiAob3V0Y29tZXNbaV0ubGVuZ3RoID4gTUFYX09VVENPTUVfTEFCRUxfTEVOR1RIKSB7XG4gICAgICBlcnJvcnMucHVzaChgT3V0Y29tZSAke2kgKyAxfSBleGNlZWRzICR7TUFYX09VVENPTUVfTEFCRUxfTEVOR1RIfSBjaGFyc2ApO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHVuaXF1ZSA9IG5ldyBTZXQob3V0Y29tZXMubWFwKG8gPT4gby50b0xvd2VyQ2FzZSgpLnRyaW0oKSkpO1xuICBpZiAodW5pcXVlLnNpemUgIT09IG91dGNvbWVzLmxlbmd0aCkge1xuICAgIGVycm9ycy5wdXNoKCdPdXRjb21lcyBtdXN0IGJlIHVuaXF1ZScpO1xuICB9XG5cbiAgcmV0dXJuIHsgdmFsaWQ6IGVycm9ycy5sZW5ndGggPT09IDAsIGVycm9ycyB9O1xufVxuIl19