/**
 * Market Creation Validation Rules (v6.2 Compliant)
 *
 * Implements validation for:
 * - Rule A: Event-based markets (12-24h buffer before event)
 * - Rule B: Measurement-period markets (close before measurement starts)
 * - Race market outcome validation
 * - Question and timing constraints
 */
import { TIMING, FEES } from '../config.js';
// =============================================================================
// CONSTANTS
// =============================================================================
const MAX_QUESTION_LENGTH = 200;
const MIN_OUTCOMES = 2;
const MAX_OUTCOMES = 10;
const MAX_OUTCOME_LABEL_LENGTH = 50;
const MIN_RESOLUTION_BUFFER_SECONDS = 600; // 10 minutes
const MAX_MARKET_DURATION_DAYS = 365;
// Rent estimates (lamports)
const MARKET_RENT = 5_000_000; // ~0.005 SOL
const RACE_MARKET_BASE_RENT = 8_000_000; // ~0.008 SOL
const RACE_OUTCOME_RENT = 500_000; // ~0.0005 SOL per outcome
// =============================================================================
// MAIN VALIDATION
// =============================================================================
/**
 * Validate market creation parameters
 */
export function validateMarketCreation(params) {
    const errors = [];
    const warnings = [];
    const suggestions = [];
    // Determine rule type
    let ruleType = 'unknown';
    if (params.marketType === 'event' || params.eventTime) {
        ruleType = 'A';
    }
    else if (params.marketType === 'measurement' || params.measurementStart) {
        ruleType = 'B';
    }
    // =========================================================================
    // Question Validation
    // =========================================================================
    if (!params.question || params.question.trim().length === 0) {
        errors.push('Question is required');
    }
    else if (params.question.length > MAX_QUESTION_LENGTH) {
        errors.push(`Question exceeds ${MAX_QUESTION_LENGTH} characters (got ${params.question.length})`);
    }
    if (!params.question.endsWith('?')) {
        warnings.push('Question should end with a question mark for clarity');
    }
    // =========================================================================
    // Timing Validation
    // =========================================================================
    const now = new Date();
    // Closing time must be in future
    if (params.closingTime <= now) {
        errors.push('Closing time must be in the future');
    }
    // Maximum duration check
    const durationDays = (params.closingTime.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (durationDays > MAX_MARKET_DURATION_DAYS) {
        errors.push(`Market duration exceeds ${MAX_MARKET_DURATION_DAYS} days`);
    }
    // Resolution time must be after closing time
    if (params.resolutionTime <= params.closingTime) {
        errors.push('Resolution time must be after closing time');
    }
    // Minimum resolution buffer
    const resolutionBufferSec = (params.resolutionTime.getTime() - params.closingTime.getTime()) / 1000;
    if (resolutionBufferSec < MIN_RESOLUTION_BUFFER_SECONDS) {
        errors.push(`Resolution buffer too short: ${resolutionBufferSec}s (min ${MIN_RESOLUTION_BUFFER_SECONDS}s)`);
    }
    // =========================================================================
    // Rule A: Event-Based Validation
    // =========================================================================
    let bufferHours;
    let recommendedClosingTime;
    if (ruleType === 'A') {
        if (!params.eventTime) {
            errors.push('Event-based markets require event_time');
        }
        else {
            // Event must be after closing
            if (params.eventTime <= params.closingTime) {
                errors.push('Event time must be after closing time');
            }
            // Calculate buffer
            bufferHours = (params.eventTime.getTime() - params.closingTime.getTime()) / (1000 * 60 * 60);
            if (bufferHours < TIMING.MIN_EVENT_BUFFER_HOURS) {
                errors.push(`Event buffer too short: ${bufferHours.toFixed(1)}h. ` +
                    `Minimum ${TIMING.MIN_EVENT_BUFFER_HOURS}h required (v6.2 Rule A).`);
                // Suggest corrected closing time
                const suggestedClose = new Date(params.eventTime.getTime() - (TIMING.RECOMMENDED_EVENT_BUFFER_HOURS * 60 * 60 * 1000));
                recommendedClosingTime = suggestedClose.toISOString();
                suggestions.push(`Recommended closing time: ${recommendedClosingTime}`);
            }
            else if (bufferHours < 18) {
                warnings.push(`Buffer is ${bufferHours.toFixed(1)}h. ` +
                    `Recommend 18-24h for safety margin (v6.2 Rule A).`);
            }
            // Event must be in future
            if (params.eventTime <= now) {
                errors.push('Event time must be in the future');
            }
        }
    }
    // =========================================================================
    // Rule B: Measurement-Period Validation
    // =========================================================================
    if (ruleType === 'B') {
        if (!params.measurementStart) {
            errors.push('Measurement-period markets require measurement_start');
        }
        else {
            // CRITICAL: Betting must close BEFORE measurement starts
            if (params.closingTime >= params.measurementStart) {
                const overlapHours = (params.closingTime.getTime() - params.measurementStart.getTime()) / (1000 * 60 * 60);
                errors.push(`INVALID: Betting closes ${overlapHours.toFixed(1)}h AFTER measurement starts. ` +
                    `This allows information advantage! (v6.2 Rule B)`);
                // Suggest corrected closing time
                const suggestedClose = new Date(params.measurementStart.getTime() - (60 * 60 * 1000)); // 1h before
                recommendedClosingTime = suggestedClose.toISOString();
                suggestions.push(`Recommended closing time: ${recommendedClosingTime}`);
            }
            // Measurement end validation
            if (params.measurementEnd) {
                if (params.measurementEnd <= params.measurementStart) {
                    errors.push('Measurement end must be after measurement start');
                }
                const periodDays = (params.measurementEnd.getTime() - params.measurementStart.getTime()) / (1000 * 60 * 60 * 24);
                if (periodDays > 7) {
                    warnings.push(`Long measurement period: ${periodDays.toFixed(0)} days. ` +
                        `Prefer 2-7 days for better UX (v6.2 guidance).`);
                }
            }
        }
    }
    // =========================================================================
    // Race Market Validation
    // =========================================================================
    if (params.outcomes) {
        if (params.outcomes.length < MIN_OUTCOMES) {
            errors.push(`Race markets require at least ${MIN_OUTCOMES} outcomes`);
        }
        if (params.outcomes.length > MAX_OUTCOMES) {
            errors.push(`Race markets limited to ${MAX_OUTCOMES} outcomes (got ${params.outcomes.length})`);
        }
        // Check outcome labels
        for (let i = 0; i < params.outcomes.length; i++) {
            const outcome = params.outcomes[i];
            if (!outcome || outcome.trim().length === 0) {
                errors.push(`Outcome ${i} is empty`);
            }
            else if (outcome.length > MAX_OUTCOME_LABEL_LENGTH) {
                errors.push(`Outcome ${i} exceeds ${MAX_OUTCOME_LABEL_LENGTH} characters`);
            }
        }
        // Check for duplicates
        const uniqueOutcomes = new Set(params.outcomes.map(o => o.toLowerCase().trim()));
        if (uniqueOutcomes.size !== params.outcomes.length) {
            errors.push('Outcome labels must be unique');
        }
    }
    // =========================================================================
    // Layer-Specific Validation
    // =========================================================================
    let creationFeeSol;
    let platformFeeBps;
    switch (params.layer) {
        case 'official':
            creationFeeSol = FEES.OFFICIAL_CREATION_FEE / 1e9;
            platformFeeBps = FEES.OFFICIAL_PLATFORM_FEE_BPS;
            warnings.push('Official markets require admin approval');
            break;
        case 'private':
            creationFeeSol = FEES.PRIVATE_CREATION_FEE / 1e9;
            platformFeeBps = FEES.PRIVATE_PLATFORM_FEE_BPS;
            if (!params.inviteHash) {
                warnings.push('Private markets can use invite_hash for restricted access');
            }
            break;
        case 'lab':
        default:
            creationFeeSol = FEES.LAB_CREATION_FEE / 1e9;
            platformFeeBps = FEES.LAB_PLATFORM_FEE_BPS;
            break;
    }
    // =========================================================================
    // Rent Estimation
    // =========================================================================
    let estimatedRentSol;
    if (params.outcomes) {
        estimatedRentSol = (RACE_MARKET_BASE_RENT + (params.outcomes.length * RACE_OUTCOME_RENT)) / 1e9;
    }
    else {
        estimatedRentSol = MARKET_RENT / 1e9;
    }
    return {
        valid: errors.length === 0,
        errors,
        warnings,
        suggestions,
        computed: {
            ruleType,
            bufferHours,
            recommendedClosingTime,
            creationFeeSol,
            platformFeeBps,
            estimatedRentSol,
        },
    };
}
// =============================================================================
// HELPER FUNCTIONS
// =============================================================================
/**
 * Calculate recommended resolution time from closing time
 */
export function calculateResolutionTime(closingTime, marketType, eventTime) {
    if (marketType === 'event' && eventTime) {
        // Resolution = event time + 1 hour buffer
        return new Date(eventTime.getTime() + (60 * 60 * 1000));
    }
    // Default: closing time + 1 day
    return new Date(closingTime.getTime() + (24 * 60 * 60 * 1000));
}
/**
 * Calculate recommended closing time for event
 */
export function calculateRecommendedClosingTime(eventTime, bufferHours = TIMING.RECOMMENDED_EVENT_BUFFER_HOURS) {
    return new Date(eventTime.getTime() - (bufferHours * 60 * 60 * 1000));
}
/**
 * Get creation fee for layer
 */
export function getCreationFee(layer) {
    let lamports;
    switch (layer) {
        case 'official':
            lamports = FEES.OFFICIAL_CREATION_FEE;
            break;
        case 'private':
            lamports = FEES.PRIVATE_CREATION_FEE;
            break;
        case 'lab':
        default:
            lamports = FEES.LAB_CREATION_FEE;
            break;
    }
    return { lamports, sol: lamports / 1e9 };
}
/**
 * Validate question format
 */
export function validateQuestion(question) {
    const errors = [];
    const suggestions = [];
    if (!question || question.trim().length === 0) {
        errors.push('Question is required');
    }
    else {
        if (question.length > MAX_QUESTION_LENGTH) {
            errors.push(`Question exceeds ${MAX_QUESTION_LENGTH} characters`);
        }
        if (!question.endsWith('?')) {
            suggestions.push('Add a question mark at the end');
        }
        if (question.length < 10) {
            suggestions.push('Consider a more descriptive question');
        }
    }
    return { valid: errors.length === 0, errors, suggestions };
}
/**
 * Validate race outcomes
 */
export function validateRaceOutcomes(outcomes) {
    const errors = [];
    if (outcomes.length < MIN_OUTCOMES) {
        errors.push(`Minimum ${MIN_OUTCOMES} outcomes required`);
    }
    if (outcomes.length > MAX_OUTCOMES) {
        errors.push(`Maximum ${MAX_OUTCOMES} outcomes allowed`);
    }
    for (let i = 0; i < outcomes.length; i++) {
        if (!outcomes[i] || outcomes[i].trim().length === 0) {
            errors.push(`Outcome ${i + 1} is empty`);
        }
        else if (outcomes[i].length > MAX_OUTCOME_LABEL_LENGTH) {
            errors.push(`Outcome ${i + 1} exceeds ${MAX_OUTCOME_LABEL_LENGTH} chars`);
        }
    }
    const unique = new Set(outcomes.map(o => o.toLowerCase().trim()));
    if (unique.size !== outcomes.length) {
        errors.push('Outcomes must be unique');
    }
    return { valid: errors.length === 0, errors };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRpb24tcnVsZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdmFsaWRhdGlvbi9jcmVhdGlvbi1ydWxlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7R0FRRztBQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFnQixNQUFNLGNBQWMsQ0FBQztBQTRDMUQsZ0ZBQWdGO0FBQ2hGLFlBQVk7QUFDWixnRkFBZ0Y7QUFFaEYsTUFBTSxtQkFBbUIsR0FBRyxHQUFHLENBQUM7QUFDaEMsTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQU0sWUFBWSxHQUFHLEVBQUUsQ0FBQztBQUN4QixNQUFNLHdCQUF3QixHQUFHLEVBQUUsQ0FBQztBQUNwQyxNQUFNLDZCQUE2QixHQUFHLEdBQUcsQ0FBQyxDQUFDLGFBQWE7QUFDeEQsTUFBTSx3QkFBd0IsR0FBRyxHQUFHLENBQUM7QUFFckMsNEJBQTRCO0FBQzVCLE1BQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQyxDQUFDLGFBQWE7QUFDNUMsTUFBTSxxQkFBcUIsR0FBRyxTQUFTLENBQUMsQ0FBQyxhQUFhO0FBQ3RELE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLENBQUMsMEJBQTBCO0FBRTdELGdGQUFnRjtBQUNoRixrQkFBa0I7QUFDbEIsZ0ZBQWdGO0FBRWhGOztHQUVHO0FBQ0gsTUFBTSxVQUFVLHNCQUFzQixDQUFDLE1BQTBCO0lBQy9ELE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztJQUM1QixNQUFNLFFBQVEsR0FBYSxFQUFFLENBQUM7SUFDOUIsTUFBTSxXQUFXLEdBQWEsRUFBRSxDQUFDO0lBRWpDLHNCQUFzQjtJQUN0QixJQUFJLFFBQVEsR0FBMEIsU0FBUyxDQUFDO0lBQ2hELElBQUksTUFBTSxDQUFDLFVBQVUsS0FBSyxPQUFPLElBQUksTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3RELFFBQVEsR0FBRyxHQUFHLENBQUM7SUFD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QUFXLENBQUMsQ0FBQztRQUMzQyxDQUFDO2FBQU0sSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLHdCQUF3QixFQUFFLENBQUM7WUFDekQsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFlBQVksd0JBQXdCLFFBQVEsQ0FBQyxDQUFDO1FBQzVFLENBQUM7SUFDSCxDQUFDO0lBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDbEUsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFDaEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogTWFya2V0IENyZWF0aW9uIFZhbGlkYXRpb24gUnVsZXMgKHY2LjIgQ29tcGxpYW50KVxuICpcbiAqIEltcGxlbWVudHMgdmFsaWRhdGlvbiBmb3I6XG4gKiAtIFJ1bGUgQTogRXZlbnQtYmFzZWQgbWFya2V0cyAoMTItMjRoIGJ1ZmZlciBiZWZvcmUgZXZlbnQpXG4gKiAtIFJ1bGUgQjogTWVhc3VyZW1lbnQtcGVyaW9kIG1hcmtldHMgKGNsb3NlIGJlZm9yZSBtZWFzdXJlbWVudCBzdGFydHMpXG4gKiAtIFJhY2UgbWFya2V0IG91dGNvbWUgdmFsaWRhdGlvblxuICogLSBRdWVzdGlvbiBhbmQgdGltaW5nIGNvbnN0cmFpbnRzXG4gKi9cblxuaW1wb3J0IHsgVElNSU5HLCBGRUVTLCBNQVJLRVRfTEFZRVIgfSBmcm9tICcuLi9jb25maWcuanMnO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gVFlQRVNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3JlYXRlTWFya2V0UGFyYW1zIHtcbiAgcXVlc3Rpb246IHN0cmluZztcbiAgY2xvc2luZ1RpbWU6IERhdGU7XG4gIHJlc29sdXRpb25UaW1lOiBEYXRlO1xuICBsYXllcjogJ29mZmljaWFsJyB8ICdsYWInIHwgJ3ByaXZhdGUnO1xuXG4gIC8vIEV2ZW50LWJhc2VkIChSdWxlIEEpXG4gIG1hcmtldFR5cGU/OiAnZXZlbnQnIHwgJ21lYXN1cmVtZW50JztcbiAgZXZlbnRUaW1lPzogRGF0ZTtcblxuICAvLyBNZWFzdXJlbWVudC1wZXJpb2QgKFJ1bGUgQilcbiAgbWVhc3VyZW1lbnRTdGFydD86IERhdGU7XG4gIG1lYXN1cmVtZW50RW5kPzogRGF0ZTtcblxuICAvLyBSYWNlIG1hcmtldHNcbiAgb3V0Y29tZXM/OiBzdHJpbmdbXTtcblxuICAvLyBQcml2YXRlIG1hcmtldFxuICBpbnZpdGVIYXNoPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENyZWF0aW9uVmFsaWRhdGlvblJlc3VsdCB7XG4gIHZhbGlkOiBib29sZWFuO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xuICB3YXJuaW5nczogc3RyaW5nW107XG4gIHN1Z2dlc3Rpb25zOiBzdHJpbmdbXTtcblxuICAvLyBDb21wdXRlZCB2YWx1ZXNcbiAgY29tcHV0ZWQ6IHtcbiAgICBydWxlVHlwZTogJ0EnIHwgJ0InIHwgJ3Vua25vd24nO1xuICAgIGJ1ZmZlckhvdXJzPzogbnVtYmVyO1xuICAgIHJlY29tbWVuZGVkQ2xvc2luZ1RpbWU/OiBzdHJpbmc7XG4gICAgY3JlYXRpb25GZWVTb2w6IG51bWJlcjtcbiAgICBwbGF0Zm9ybUZlZUJwczogbnVtYmVyO1xuICAgIGVzdGltYXRlZFJlbnRTb2w6IG51bWJlcjtcbiAgfTtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIENPTlNUQU5UU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuY29uc3QgTUFYX1FVRVNUSU9OX0xFTkdUSCA9IDIwMDtcbmNvbnN0IE1JTl9PVVRDT01FUyA9IDI7XG5jb25zdCBNQVhfT1VUQ09NRVMgPSAxMDtcbmNvbnN0IE1BWF9PVVRDT01FX0xBQkVMX0xFTkdUSCA9IDUwO1xuY29uc3QgTUlOX1JFU09MVVRJT05fQlVGRkVSX1NFQ09ORFMgPSA2MDA7IC8vIDEwIG1pbnV0ZXNcbmNvbnN0IE1BWF9NQVJLRVRfRFVSQVRJT05fREFZUyA9IDM2NTtcblxuLy8gUmVudCBlc3RpbWF0ZXMgKGxhbXBvcnRzKVxuY29uc3QgTUFSS0VUX1JFTlQgPSA1XzAwMF8wMDA7IC8vIH4wLjAwNSBTT0xcbmNvbnN0IFJBQ0VfTUFSS0VUX0JBU0VfUkVOVCA9IDhfMDAwXzAwMDsgLy8gfjAuMDA4IFNPTFxuY29uc3QgUkFDRV9PVVRDT01FX1JFTlQgPSA1MDBfMDAwOyAvLyB+MC4wMDA1IFNPTCBwZXIgb3V0Y29tZVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gTUFJTiBWQUxJREFUSU9OXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIFZhbGlkYXRlIG1hcmtldCBjcmVhdGlvbiBwYXJhbWV0ZXJzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZU1hcmtldENyZWF0aW9uKHBhcmFtczogQ3JlYXRlTWFya2V0UGFyYW1zKTogQ3JlYXRpb25WYWxpZGF0aW9uUmVzdWx0IHtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCB3YXJuaW5nczogc3RyaW5nW10gPSBbXTtcbiAgY29uc3Qgc3VnZ2VzdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgLy8gRGV0ZXJtaW5lIHJ1bGUgdHlwZVxuICBsZXQgcnVsZVR5cGU6ICdBJyB8ICdCJyB8ICd1bmtub3duJyA9ICd1bmtub3duJztcbiAgaWYgKHBhcmFtcy5tYXJrZXRUeXBlID09PSAnZXZlbnQnIHx8IHBhcmFtcy5ldmVudFRpbWUpIHtcbiAgICBydWxlVHlwZSA9ICdBJztcbiAgfSBlbHNlIGlmIChwYXJhbXMubWFya2V0VHlwZSA9PT0gJ21lYXN1cmVtZW50JyB8fCBwYXJhbXMubWVhc3VyZW1lbnRTdGFydCkge1xuICAgIHJ1bGVUeXBlID0gJ0InO1xuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBRdWVzdGlvbiBWYWxpZGF0aW9uXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBpZiAoIXBhcmFtcy5xdWVzdGlvbiB8fCBwYXJhbXMucXVlc3Rpb24udHJpbSgpLmxlbmd0aCA9PT0gMCkge1xuICAgIGVycm9ycy5wdXNoKCdRdWVzdGlvbiBpcyByZXF1aXJlZCcpO1xuICB9IGVsc2UgaWYgKHBhcmFtcy5xdWVzdGlvbi5sZW5ndGggPiBNQVhfUVVFU1RJT05fTEVOR1RIKSB7XG4gICAgZXJyb3JzLnB1c2goYFF1ZXN0aW9uIGV4Y2VlZHMgJHtNQVhfUVVFU1RJT05fTEVOR1RIfSBjaGFyYWN0ZXJzIChnb3QgJHtwYXJhbXMucXVlc3Rpb24ubGVuZ3RofSlgKTtcbiAgfVxuXG4gIGlmICghcGFyYW1zLnF1ZXN0aW9uLmVuZHNXaXRoKCc/JykpIHtcbiAgICB3YXJuaW5ncy5wdXNoKCdRdWVzdGlvbiBzaG91bGQgZW5kIHdpdGggYSBxdWVzdGlvbiBtYXJrIGZvciBjbGFyaXR5Jyk7XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIFRpbWluZyBWYWxpZGF0aW9uXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuXG4gIC8vIENsb3NpbmcgdGltZSBtdXN0IGJlIGluIGZ1dHVyZVxuICBpZiAocGFyYW1zLmNsb3NpbmdUaW1lIDw9IG5vdykge1xuICAgIGVycm9ycy5wdXNoKCdDbG9zaW5nIHRpbWUgbXVzdCBiZSBpbiB0aGUgZnV0dXJlJyk7XG4gIH1cblxuICAvLyBNYXhpbXVtIGR1cmF0aW9uIGNoZWNrXG4gIGNvbnN0IGR1cmF0aW9uRGF5cyA9IChwYXJhbXMuY2xvc2luZ1RpbWUuZ2V0VGltZSgpIC0gbm93LmdldFRpbWUoKSkgLyAoMTAwMCAqIDYwICogNjAgKiAyNCk7XG4gIGlmIChkdXJhdGlvbkRheXMgPiBNQVhfTUFSS0VUX0RVUkFUSU9OX0RBWVMpIHtcbiAgICBlcnJvcnMucHVzaChgTWFya2V0IGR1cmF0aW9uIGV4Y2VlZHMgJHtNQVhfTUFSS0VUX0RVUkFUSU9OX0RBWVN9IGRheXNgKTtcbiAgfVxuXG4gIC8vIFJlc29sdXRpb24gdGltZSBtdXN0IGJlIGFmdGVyIGNsb3NpbmcgdGltZVxuICBpZiAocGFyYW1zLnJlc29sdXRpb25UaW1lIDw9IHBhcmFtcy5jbG9zaW5nVGltZSkge1xuICAgIGVycm9ycy5wdXNoKCdSZXNvbHV0aW9uIHRpbWUgbXVzdCBiZSBhZnRlciBjbG9zaW5nIHRpbWUnKTtcbiAgfVxuXG4gIC8vIE1pbmltdW0gcmVzb2x1dGlvbiBidWZmZXJcbiAgY29uc3QgcmVzb2x1dGlvbkJ1ZmZlclNlYyA9IChwYXJhbXMucmVzb2x1dGlvblRpbWUuZ2V0VGltZSgpIC0gcGFyYW1zLmNsb3NpbmdUaW1lLmdldFRpbWUoKSkgLyAxMDAwO1xuICBpZiAocmVzb2x1dGlvbkJ1ZmZlclNlYyA8IE1JTl9SRVNPTFVUSU9OX0JVRkZFUl9TRUNPTkRTKSB7XG4gICAgZXJyb3JzLnB1c2goYFJlc29sdXRpb24gYnVmZmVyIHRvbyBzaG9ydDogJHtyZXNvbHV0aW9uQnVmZmVyU2VjfXMgKG1pbiAke01JTl9SRVNPTFVUSU9OX0JVRkZFUl9TRUNPTkRTfXMpYCk7XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIFJ1bGUgQTogRXZlbnQtQmFzZWQgVmFsaWRhdGlvblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgbGV0IGJ1ZmZlckhvdXJzOiBudW1iZXIgfCB1bmRlZmluZWQ7XG4gIGxldCByZWNvbW1lbmRlZENsb3NpbmdUaW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgaWYgKHJ1bGVUeXBlID09PSAnQScpIHtcbiAgICBpZiAoIXBhcmFtcy5ldmVudFRpbWUpIHtcbiAgICAgIGVycm9ycy5wdXNoKCdFdmVudC1iYXNlZCBtYXJrZXRzIHJlcXVpcmUgZXZlbnRfdGltZScpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBFdmVudCBtdXN0IGJlIGFmdGVyIGNsb3NpbmdcbiAgICAgIGlmIChwYXJhbXMuZXZlbnRUaW1lIDw9IHBhcmFtcy5jbG9zaW5nVGltZSkge1xuICAgICAgICBlcnJvcnMucHVzaCgnRXZlbnQgdGltZSBtdXN0IGJlIGFmdGVyIGNsb3NpbmcgdGltZScpO1xuICAgICAgfVxuXG4gICAgICAvLyBDYWxjdWxhdGUgYnVmZmVyXG4gICAgICBidWZmZXJIb3VycyA9IChwYXJhbXMuZXZlbnRUaW1lLmdldFRpbWUoKSAtIHBhcmFtcy5jbG9zaW5nVGltZS5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCAqIDYwKTtcblxuICAgICAgaWYgKGJ1ZmZlckhvdXJzIDwgVElNSU5HLk1JTl9FVkVOVF9CVUZGRVJfSE9VUlMpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgICAgYEV2ZW50IGJ1ZmZlciB0b28gc2hvcnQ6ICR7YnVmZmVySG91cnMudG9GaXhlZCgxKX1oLiBgICtcbiAgICAgICAgICBgTWluaW11bSAke1RJTUlORy5NSU5fRVZFTlRfQlVGRkVSX0hPVVJTfWggcmVxdWlyZWQgKHY2LjIgUnVsZSBBKS5gXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gU3VnZ2VzdCBjb3JyZWN0ZWQgY2xvc2luZyB0aW1lXG4gICAgICAgIGNvbnN0IHN1Z2dlc3RlZENsb3NlID0gbmV3IERhdGUoXG4gICAgICAgICAgcGFyYW1zLmV2ZW50VGltZS5nZXRUaW1lKCkgLSAoVElNSU5HLlJFQ09NTUVOREVEX0VWRU5UX0JVRkZFUl9IT1VSUyAqIDYwICogNjAgKiAxMDAwKVxuICAgICAgICApO1xuICAgICAgICByZWNvbW1lbmRlZENsb3NpbmdUaW1lID0gc3VnZ2VzdGVkQ2xvc2UudG9JU09TdHJpbmcoKTtcbiAgICAgICAgc3VnZ2VzdGlvbnMucHVzaChgUmVjb21tZW5kZWQgY2xvc2luZyB0aW1lOiAke3JlY29tbWVuZGVkQ2xvc2luZ1RpbWV9YCk7XG4gICAgICB9IGVsc2UgaWYgKGJ1ZmZlckhvdXJzIDwgMTgpIHtcbiAgICAgICAgd2FybmluZ3MucHVzaChcbiAgICAgICAgICBgQnVmZmVyIGlzICR7YnVmZmVySG91cnMudG9GaXhlZCgxKX1oLiBgICtcbiAgICAgICAgICBgUmVjb21tZW5kIDE4LTI0aCBmb3Igc2FmZXR5IG1hcmdpbiAodjYuMiBSdWxlIEEpLmBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gRXZlbnQgbXVzdCBiZSBpbiBmdXR1cmVcbiAgICAgIGlmIChwYXJhbXMuZXZlbnRUaW1lIDw9IG5vdykge1xuICAgICAgICBlcnJvcnMucHVzaCgnRXZlbnQgdGltZSBtdXN0IGJlIGluIHRoZSBmdXR1cmUnKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIFJ1bGUgQjogTWVhc3VyZW1lbnQtUGVyaW9kIFZhbGlkYXRpb25cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIGlmIChydWxlVHlwZSA9PT0gJ0InKSB7XG4gICAgaWYgKCFwYXJhbXMubWVhc3VyZW1lbnRTdGFydCkge1xuICAgICAgZXJyb3JzLnB1c2goJ01lYXN1cmVtZW50LXBlcmlvZCBtYXJrZXRzIHJlcXVpcmUgbWVhc3VyZW1lbnRfc3RhcnQnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ1JJVElDQUw6IEJldHRpbmcgbXVzdCBjbG9zZSBCRUZPUkUgbWVhc3VyZW1lbnQgc3RhcnRzXG4gICAgICBpZiAocGFyYW1zLmNsb3NpbmdUaW1lID49IHBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0KSB7XG4gICAgICAgIGNvbnN0IG92ZXJsYXBIb3VycyA9IChwYXJhbXMuY2xvc2luZ1RpbWUuZ2V0VGltZSgpIC0gcGFyYW1zLm1lYXN1cmVtZW50U3RhcnQuZ2V0VGltZSgpKSAvICgxMDAwICogNjAgKiA2MCk7XG4gICAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICAgIGBJTlZBTElEOiBCZXR0aW5nIGNsb3NlcyAke292ZXJsYXBIb3Vycy50b0ZpeGVkKDEpfWggQUZURVIgbWVhc3VyZW1lbnQgc3RhcnRzLiBgICtcbiAgICAgICAgICBgVGhpcyBhbGxvd3MgaW5mb3JtYXRpb24gYWR2YW50YWdlISAodjYuMiBSdWxlIEIpYFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIFN1Z2dlc3QgY29ycmVjdGVkIGNsb3NpbmcgdGltZVxuICAgICAgICBjb25zdCBzdWdnZXN0ZWRDbG9zZSA9IG5ldyBEYXRlKHBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0LmdldFRpbWUoKSAtICg2MCAqIDYwICogMTAwMCkpOyAvLyAxaCBiZWZvcmVcbiAgICAgICAgcmVjb21tZW5kZWRDbG9zaW5nVGltZSA9IHN1Z2dlc3RlZENsb3NlLnRvSVNPU3RyaW5nKCk7XG4gICAgICAgIHN1Z2dlc3Rpb25zLnB1c2goYFJlY29tbWVuZGVkIGNsb3NpbmcgdGltZTogJHtyZWNvbW1lbmRlZENsb3NpbmdUaW1lfWApO1xuICAgICAgfVxuXG4gICAgICAvLyBNZWFzdXJlbWVudCBlbmQgdmFsaWRhdGlvblxuICAgICAgaWYgKHBhcmFtcy5tZWFzdXJlbWVudEVuZCkge1xuICAgICAgICBpZiAocGFyYW1zLm1lYXN1cmVtZW50RW5kIDw9IHBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0KSB7XG4gICAgICAgICAgZXJyb3JzLnB1c2goJ01lYXN1cmVtZW50IGVuZCBtdXN0IGJlIGFmdGVyIG1lYXN1cmVtZW50IHN0YXJ0Jyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwZXJpb2REYXlzID0gKHBhcmFtcy5tZWFzdXJlbWVudEVuZC5nZXRUaW1lKCkgLSBwYXJhbXMubWVhc3VyZW1lbnRTdGFydC5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpO1xuICAgICAgICBpZiAocGVyaW9kRGF5cyA+IDcpIHtcbiAgICAgICAgICB3YXJuaW5ncy5wdXNoKFxuICAgICAgICAgICAgYExvbmcgbWVhc3VyZW1lbnQgcGVyaW9kOiAke3BlcmlvZERheXMudG9GaXhlZCgwKX0gZGF5cy4gYCArXG4gICAgICAgICAgICBgUHJlZmVyIDItNyBkYXlzIGZvciBiZXR0ZXIgVVggKHY2LjIgZ3VpZGFuY2UpLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBSYWNlIE1hcmtldCBWYWxpZGF0aW9uXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBpZiAocGFyYW1zLm91dGNvbWVzKSB7XG4gICAgaWYgKHBhcmFtcy5vdXRjb21lcy5sZW5ndGggPCBNSU5fT1VUQ09NRVMpIHtcbiAgICAgIGVycm9ycy5wdXNoKGBSYWNlIG1hcmtldHMgcmVxdWlyZSBhdCBsZWFzdCAke01JTl9PVVRDT01FU30gb3V0Y29tZXNgKTtcbiAgICB9XG4gICAgaWYgKHBhcmFtcy5vdXRjb21lcy5sZW5ndGggPiBNQVhfT1VUQ09NRVMpIHtcbiAgICAgIGVycm9ycy5wdXNoKGBSYWNlIG1hcmtldHMgbGltaXRlZCB0byAke01BWF9PVVRDT01FU30gb3V0Y29tZXMgKGdvdCAke3BhcmFtcy5vdXRjb21lcy5sZW5ndGh9KWApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIG91dGNvbWUgbGFiZWxzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJhbXMub3V0Y29tZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IG91dGNvbWUgPSBwYXJhbXMub3V0Y29tZXNbaV07XG4gICAgICBpZiAoIW91dGNvbWUgfHwgb3V0Y29tZS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGBPdXRjb21lICR7aX0gaXMgZW1wdHlgKTtcbiAgICAgIH0gZWxzZSBpZiAob3V0Y29tZS5sZW5ndGggPiBNQVhfT1VUQ09NRV9MQUJFTF9MRU5HVEgpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYE91dGNvbWUgJHtpfSBleGNlZWRzICR7TUFYX09VVENPTUVfTEFCRUxfTEVOR1RIfSBjaGFyYWN0ZXJzYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIGR1cGxpY2F0ZXNcbiAgICBjb25zdCB1bmlxdWVPdXRjb21lcyA9IG5ldyBTZXQocGFyYW1zLm91dGNvbWVzLm1hcChvID0+IG8udG9Mb3dlckNhc2UoKS50cmltKCkpKTtcbiAgICBpZiAodW5pcXVlT3V0Y29tZXMuc2l6ZSAhPT0gcGFyYW1zLm91dGNvbWVzLmxlbmd0aCkge1xuICAgICAgZXJyb3JzLnB1c2goJ091dGNvbWUgbGFiZWxzIG11c3QgYmUgdW5pcXVlJyk7XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBMYXllci1TcGVjaWZpYyBWYWxpZGF0aW9uXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBsZXQgY3JlYXRpb25GZWVTb2w6IG51bWJlcjtcbiAgbGV0IHBsYXRmb3JtRmVlQnBzOiBudW1iZXI7XG5cbiAgc3dpdGNoIChwYXJhbXMubGF5ZXIpIHtcbiAgICBjYXNlICdvZmZpY2lhbCc6XG4gICAgICBjcmVhdGlvbkZlZVNvbCA9IEZFRVMuT0ZGSUNJQUxfQ1JFQVRJT05fRkVFIC8gMWU5O1xuICAgICAgcGxhdGZvcm1GZWVCcHMgPSBGRUVTLk9GRklDSUFMX1BMQVRGT1JNX0ZFRV9CUFM7XG4gICAgICB3YXJuaW5ncy5wdXNoKCdPZmZpY2lhbCBtYXJrZXRzIHJlcXVpcmUgYWRtaW4gYXBwcm92YWwnKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3ByaXZhdGUnOlxuICAgICAgY3JlYXRpb25GZWVTb2wgPSBGRUVTLlBSSVZBVEVfQ1JFQVRJT05fRkVFIC8gMWU5O1xuICAgICAgcGxhdGZvcm1GZWVCcHMgPSBGRUVTLlBSSVZBVEVfUExBVEZPUk1fRkVFX0JQUztcbiAgICAgIGlmICghcGFyYW1zLmludml0ZUhhc2gpIHtcbiAgICAgICAgd2FybmluZ3MucHVzaCgnUHJpdmF0ZSBtYXJrZXRzIGNhbiB1c2UgaW52aXRlX2hhc2ggZm9yIHJlc3RyaWN0ZWQgYWNjZXNzJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdsYWInOlxuICAgIGRlZmF1bHQ6XG4gICAgICBjcmVhdGlvbkZlZVNvbCA9IEZFRVMuTEFCX0NSRUFUSU9OX0ZFRSAvIDFlOTtcbiAgICAgIHBsYXRmb3JtRmVlQnBzID0gRkVFUy5MQUJfUExBVEZPUk1fRkVFX0JQUztcbiAgICAgIGJyZWFrO1xuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBSZW50IEVzdGltYXRpb25cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIGxldCBlc3RpbWF0ZWRSZW50U29sOiBudW1iZXI7XG4gIGlmIChwYXJhbXMub3V0Y29tZXMpIHtcbiAgICBlc3RpbWF0ZWRSZW50U29sID0gKFJBQ0VfTUFSS0VUX0JBU0VfUkVOVCArIChwYXJhbXMub3V0Y29tZXMubGVuZ3RoICogUkFDRV9PVVRDT01FX1JFTlQpKSAvIDFlOTtcbiAgfSBlbHNlIHtcbiAgICBlc3RpbWF0ZWRSZW50U29sID0gTUFSS0VUX1JFTlQgLyAxZTk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLFxuICAgIGVycm9ycyxcbiAgICB3YXJuaW5ncyxcbiAgICBzdWdnZXN0aW9ucyxcbiAgICBjb21wdXRlZDoge1xuICAgICAgcnVsZVR5cGUsXG4gICAgICBidWZmZXJIb3VycyxcbiAgICAgIHJlY29tbWVuZGVkQ2xvc2luZ1RpbWUsXG4gICAgICBjcmVhdGlvbkZlZVNvbCxcbiAgICAgIHBsYXRmb3JtRmVlQnBzLFxuICAgICAgZXN0aW1hdGVkUmVudFNvbCxcbiAgICB9LFxuICB9O1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gSEVMUEVSIEZVTkNUSU9OU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBDYWxjdWxhdGUgcmVjb21tZW5kZWQgcmVzb2x1dGlvbiB0aW1lIGZyb20gY2xvc2luZyB0aW1lXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVSZXNvbHV0aW9uVGltZShcbiAgY2xvc2luZ1RpbWU6IERhdGUsXG4gIG1hcmtldFR5cGU6ICdldmVudCcgfCAnbWVhc3VyZW1lbnQnLFxuICBldmVudFRpbWU/OiBEYXRlXG4pOiBEYXRlIHtcbiAgaWYgKG1hcmtldFR5cGUgPT09ICdldmVudCcgJiYgZXZlbnRUaW1lKSB7XG4gICAgLy8gUmVzb2x1dGlvbiA9IGV2ZW50IHRpbWUgKyAxIGhvdXIgYnVmZmVyXG4gICAgcmV0dXJuIG5ldyBEYXRlKGV2ZW50VGltZS5nZXRUaW1lKCkgKyAoNjAgKiA2MCAqIDEwMDApKTtcbiAgfVxuICAvLyBEZWZhdWx0OiBjbG9zaW5nIHRpbWUgKyAxIGRheVxuICByZXR1cm4gbmV3IERhdGUoY2xvc2luZ1RpbWUuZ2V0VGltZSgpICsgKDI0ICogNjAgKiA2MCAqIDEwMDApKTtcbn1cblxuLyoqXG4gKiBDYWxjdWxhdGUgcmVjb21tZW5kZWQgY2xvc2luZyB0aW1lIGZvciBldmVudFxuICovXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlUmVjb21tZW5kZWRDbG9zaW5nVGltZShcbiAgZXZlbnRUaW1lOiBEYXRlLFxuICBidWZmZXJIb3VyczogbnVtYmVyID0gVElNSU5HLlJFQ09NTUVOREVEX0VWRU5UX0JVRkZFUl9IT1VSU1xuKTogRGF0ZSB7XG4gIHJldHVybiBuZXcgRGF0ZShldmVudFRpbWUuZ2V0VGltZSgpIC0gKGJ1ZmZlckhvdXJzICogNjAgKiA2MCAqIDEwMDApKTtcbn1cblxuLyoqXG4gKiBHZXQgY3JlYXRpb24gZmVlIGZvciBsYXllclxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3JlYXRpb25GZWUobGF5ZXI6ICdvZmZpY2lhbCcgfCAnbGFiJyB8ICdwcml2YXRlJyk6IHtcbiAgbGFtcG9ydHM6IG51bWJlcjtcbiAgc29sOiBudW1iZXI7XG59IHtcbiAgbGV0IGxhbXBvcnRzOiBudW1iZXI7XG4gIHN3aXRjaCAobGF5ZXIpIHtcbiAgICBjYXNlICdvZmZpY2lhbCc6XG4gICAgICBsYW1wb3J0cyA9IEZFRVMuT0ZGSUNJQUxfQ1JFQVRJT05fRkVFO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAncHJpdmF0ZSc6XG4gICAgICBsYW1wb3J0cyA9IEZFRVMuUFJJVkFURV9DUkVBVElPTl9GRUU7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdsYWInOlxuICAgIGRlZmF1bHQ6XG4gICAgICBsYW1wb3J0cyA9IEZFRVMuTEFCX0NSRUFUSU9OX0ZFRTtcbiAgICAgIGJyZWFrO1xuICB9XG4gIHJldHVybiB7IGxhbXBvcnRzLCBzb2w6IGxhbXBvcnRzIC8gMWU5IH07XG59XG5cbi8qKlxuICogVmFsaWRhdGUgcXVlc3Rpb24gZm9ybWF0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVF1ZXN0aW9uKHF1ZXN0aW9uOiBzdHJpbmcpOiB7XG4gIHZhbGlkOiBib29sZWFuO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xuICBzdWdnZXN0aW9uczogc3RyaW5nW107XG59IHtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCBzdWdnZXN0aW9uczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAoIXF1ZXN0aW9uIHx8IHF1ZXN0aW9uLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICBlcnJvcnMucHVzaCgnUXVlc3Rpb24gaXMgcmVxdWlyZWQnKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAocXVlc3Rpb24ubGVuZ3RoID4gTUFYX1FVRVNUSU9OX0xFTkdUSCkge1xuICAgICAgZXJyb3JzLnB1c2goYFF1ZXN0aW9uIGV4Y2VlZHMgJHtNQVhfUVVFU1RJT05fTEVOR1RIfSBjaGFyYWN0ZXJzYCk7XG4gICAgfVxuICAgIGlmICghcXVlc3Rpb24uZW5kc1dpdGgoJz8nKSkge1xuICAgICAgc3VnZ2VzdGlvbnMucHVzaCgnQWRkIGEgcXVlc3Rpb24gbWFyayBhdCB0aGUgZW5kJyk7XG4gICAgfVxuICAgIGlmIChxdWVzdGlvbi5sZW5ndGggPCAxMCkge1xuICAgICAgc3VnZ2VzdGlvbnMucHVzaCgnQ29uc2lkZXIgYSBtb3JlIGRlc2NyaXB0aXZlIHF1ZXN0aW9uJyk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHsgdmFsaWQ6IGVycm9ycy5sZW5ndGggPT09IDAsIGVycm9ycywgc3VnZ2VzdGlvbnMgfTtcbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSByYWNlIG91dGNvbWVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVJhY2VPdXRjb21lcyhvdXRjb21lczogc3RyaW5nW10pOiB7XG4gIHZhbGlkOiBib29sZWFuO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xufSB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAob3V0Y29tZXMubGVuZ3RoIDwgTUlOX09VVENPTUVTKSB7XG4gICAgZXJyb3JzLnB1c2goYE1pbmltdW0gJHtNSU5fT1VUQ09NRVN9IG91dGNvbWVzIHJlcXVpcmVkYCk7XG4gIH1cbiAgaWYgKG91dGNvbWVzLmxlbmd0aCA+IE1BWF9PVVRDT01FUykge1xuICAgIGVycm9ycy5wdXNoKGBNYXhpbXVtICR7TUFYX09VVENPTUVTfSBvdXRjb21lcyBhbGxvd2VkYCk7XG4gIH1cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IG91dGNvbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKCFvdXRjb21lc1tpXSB8fCBvdXRjb21lc1tpXS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICBlcnJvcnMucHVzaChgT3V0Y29tZSAke2kgKyAxfSBpcyBlbXB0eWApO1xuICAgIH0gZWxzZSBpZiAob3V0Y29tZXNbaV0ubGVuZ3RoID4gTUFYX09VVENPTUVfTEFCRUxfTEVOR1RIKSB7XG4gICAgICBlcnJvcnMucHVzaChgT3V0Y29tZSAke2kgKyAxfSBleGNlZWRzICR7TUFYX09VVENPTUVfTEFCRUxfTEVOR1RIfSBjaGFyc2ApO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHVuaXF1ZSA9IG5ldyBTZXQob3V0Y29tZXMubWFwKG8gPT4gby50b0xvd2VyQ2FzZSgpLnRyaW0oKSkpO1xuICBpZiAodW5pcXVlLnNpemUgIT09IG91dGNvbWVzLmxlbmd0aCkge1xuICAgIGVycm9ycy5wdXNoKCdPdXRjb21lcyBtdXN0IGJlIHVuaXF1ZScpO1xuICB9XG5cbiAgcmV0dXJuIHsgdmFsaWQ6IGVycm9ycy5sZW5ndGggPT09IDAsIGVycm9ycyB9O1xufVxuIl19