/**
 * Market Validation Rules (v6.2)
 *
 * Implements timing validation for market creation based on:
 * - Rule A: Event-Based Markets (single point in time)
 * - Rule B: Measurement-Period Markets (outcome over time range)
 */
import { TIMING } from '../config.js';
// =============================================================================
// MAIN VALIDATION FUNCTION
// =============================================================================
/**
 * Validate market timing parameters against v6.2 rules
 *
 * Rule A (Event-Based):
 * - Betting closes BEFORE the event occurs
 * - Minimum 12h buffer between close and event
 * - Recommended 18-24h buffer for safety
 *
 * Rule B (Measurement-Period):
 * - Betting must close BEFORE measurement starts
 * - Measurement period should be well-defined
 * - Prefer 2-7 day measurement periods for UX
 */
export function validateMarketTiming(params) {
    const errors = [];
    const warnings = [];
    const suggestions = [];
    const timing = {};
    // Common validation: question length
    if (params.question.length > 200) {
        errors.push(`Question too long: ${params.question.length} chars (max 200)`);
    }
    if (params.question.length < 10) {
        warnings.push(`Question may be too short: ${params.question.length} chars`);
    }
    // Common validation: closing time in future
    const now = new Date();
    if (params.closingTime <= now) {
        errors.push('Closing time must be in the future');
    }
    // Common validation: closing time not too far
    const maxClosingTime = new Date(now.getTime() + TIMING.MAX_MARKET_DURATION_DAYS * 24 * 60 * 60 * 1000);
    if (params.closingTime > maxClosingTime) {
        errors.push(`Closing time too far in future (max ${TIMING.MAX_MARKET_DURATION_DAYS} days)`);
    }
    // ==========================================================================
    // Rule A: Event-Based Markets
    // ==========================================================================
    if (params.marketType === 'event') {
        if (!params.eventTime) {
            errors.push('Event-based markets require event_time');
            return { valid: false, ruleType: 'A', errors, warnings, suggestions };
        }
        // Event time must be after closing time
        if (params.eventTime <= params.closingTime) {
            errors.push('Event time must be after closing time');
        }
        // Calculate buffer
        const bufferMs = params.eventTime.getTime() - params.closingTime.getTime();
        const bufferHours = bufferMs / (1000 * 60 * 60);
        timing.bufferHours = Math.round(bufferHours * 10) / 10;
        // Minimum buffer check (12 hours)
        if (bufferHours < TIMING.MIN_EVENT_BUFFER_HOURS) {
            errors.push(`Buffer too short: ${timing.bufferHours}h. ` +
                `Minimum ${TIMING.MIN_EVENT_BUFFER_HOURS}h required between betting close and event.`);
        }
        else if (bufferHours < 18) {
            warnings.push(`Buffer is ${timing.bufferHours}h. ` +
                `Recommend ${TIMING.RECOMMENDED_EVENT_BUFFER_HOURS}h for safety margin.`);
        }
        // Suggest optimal closing time
        const recommendedClose = new Date(params.eventTime.getTime() - TIMING.RECOMMENDED_EVENT_BUFFER_HOURS * 60 * 60 * 1000);
        timing.recommendedClose = recommendedClose;
        if (recommendedClose > now && params.closingTime > recommendedClose) {
            suggestions.push(`Consider closing betting at ${recommendedClose.toISOString()} ` +
                `(${TIMING.RECOMMENDED_EVENT_BUFFER_HOURS}h before event)`);
        }
        // Check for common mistakes
        if (params.question.toLowerCase().includes('will') && !params.question.includes('?')) {
            suggestions.push('Consider ending your question with a question mark for clarity');
        }
        return {
            valid: errors.length === 0,
            ruleType: 'A',
            errors,
            warnings,
            suggestions,
            timing,
        };
    }
    // ==========================================================================
    // Rule B: Measurement-Period Markets
    // ==========================================================================
    if (params.marketType === 'measurement') {
        if (!params.measurementStart) {
            errors.push('Measurement-period markets require measurement_start');
            return { valid: false, ruleType: 'B', errors, warnings, suggestions };
        }
        // CRITICAL: Betting must close BEFORE measurement starts
        if (params.closingTime >= params.measurementStart) {
            const overlapMs = params.closingTime.getTime() - params.measurementStart.getTime();
            const overlapHours = overlapMs / (1000 * 60 * 60);
            errors.push(`INVALID: Betting closes ${Math.round(overlapHours * 10) / 10}h AFTER measurement starts. ` +
                `This allows information advantage! ` +
                `Betting must close BEFORE measurement period begins.`);
        }
        // Calculate buffer before measurement
        const bufferMs = params.measurementStart.getTime() - params.closingTime.getTime();
        const bufferHours = bufferMs / (1000 * 60 * 60);
        timing.bufferHours = Math.round(bufferHours * 10) / 10;
        if (bufferHours < 1 && bufferHours > 0) {
            warnings.push(`Very tight buffer (${timing.bufferHours}h) between betting close and measurement start. ` +
                `Consider adding more time for late bettors.`);
        }
        // Measurement end validation
        if (params.measurementEnd) {
            if (params.measurementEnd <= params.measurementStart) {
                errors.push('Measurement end must be after measurement start');
            }
            const periodMs = params.measurementEnd.getTime() - params.measurementStart.getTime();
            const periodDays = periodMs / (1000 * 60 * 60 * 24);
            timing.measurementDays = Math.round(periodDays * 10) / 10;
            // UX guidance for measurement periods
            if (periodDays > 30) {
                warnings.push(`Very long measurement period: ${timing.measurementDays} days. ` +
                    `Consider shorter periods (2-7 days) for better user experience.`);
            }
            else if (periodDays > 7) {
                warnings.push(`Long measurement period: ${timing.measurementDays} days. ` +
                    `Prefer 2-7 days for optimal engagement.`);
            }
            else if (periodDays < 1) {
                suggestions.push(`Short measurement period (${Math.round(periodDays * 24)}h). ` +
                    `Ensure resolution can be determined within this timeframe.`);
            }
        }
        // Suggest optimal closing time
        const recommendedClose = new Date(params.measurementStart.getTime() - 2 * 60 * 60 * 1000 // 2 hours before measurement
        );
        timing.recommendedClose = recommendedClose;
        if (recommendedClose > now && params.closingTime > recommendedClose) {
            suggestions.push(`Consider closing betting at ${recommendedClose.toISOString()} ` +
                `(2h before measurement period starts)`);
        }
        return {
            valid: errors.length === 0,
            ruleType: 'B',
            errors,
            warnings,
            suggestions,
            timing,
        };
    }
    // Unknown market type
    errors.push(`Unknown market type: ${params.marketType}`);
    return { valid: false, ruleType: 'A', errors, warnings, suggestions };
}
// =============================================================================
// HELPER FUNCTIONS
// =============================================================================
/**
 * Generate timing suggestions based on market parameters
 */
export function generateTimingSuggestions(params) {
    const suggestions = [];
    const now = new Date();
    if (params.marketType === 'event' && params.eventTime) {
        // Suggest closing time for event-based markets
        const optimalClose = new Date(params.eventTime.getTime() - TIMING.RECOMMENDED_EVENT_BUFFER_HOURS * 60 * 60 * 1000);
        if (optimalClose > now) {
            suggestions.push(`Optimal betting close: ${optimalClose.toISOString()}`);
        }
        // Suggest question format
        if (!params.question.includes('?')) {
            suggestions.push('End your question with "?" for clarity');
        }
    }
    if (params.marketType === 'measurement' && params.measurementStart) {
        // Suggest closing time for measurement markets
        const optimalClose = new Date(params.measurementStart.getTime() - 2 * 60 * 60 * 1000);
        if (optimalClose > now) {
            suggestions.push(`Optimal betting close: ${optimalClose.toISOString()}`);
        }
    }
    return suggestions;
}
/**
 * Check if a market question follows best practices
 */
export function validateQuestionFormat(question) {
    const issues = [];
    // Length checks
    if (question.length < 10) {
        issues.push('Question too short (min 10 chars)');
    }
    if (question.length > 200) {
        issues.push('Question too long (max 200 chars)');
    }
    // Format checks
    if (!question.trim()) {
        issues.push('Question cannot be empty');
    }
    // Best practice checks
    if (!question.includes('?') && !question.toLowerCase().startsWith('will ')) {
        issues.push('Consider phrasing as a yes/no question');
    }
    // Check for ambiguous language
    const ambiguousTerms = ['maybe', 'probably', 'might', 'could possibly'];
    for (const term of ambiguousTerms) {
        if (question.toLowerCase().includes(term)) {
            issues.push(`Avoid ambiguous term: "${term}"`);
        }
    }
    return {
        valid: issues.length === 0,
        issues,
    };
}
/**
 * Calculate recommended times for a market
 */
export function calculateRecommendedTimes(eventOrMeasurementStart, marketType) {
    const buffer = marketType === 'event'
        ? TIMING.RECOMMENDED_EVENT_BUFFER_HOURS * 60 * 60 * 1000
        : 2 * 60 * 60 * 1000; // 2 hours for measurement
    const minBuffer = marketType === 'event'
        ? TIMING.MIN_EVENT_BUFFER_HOURS * 60 * 60 * 1000
        : 1 * 60 * 60 * 1000; // 1 hour for measurement
    const maxBuffer = 48 * 60 * 60 * 1000; // 48 hours max
    return {
        recommendedClose: new Date(eventOrMeasurementStart.getTime() - buffer),
        latestClose: new Date(eventOrMeasurementStart.getTime() - minBuffer),
        earliestClose: new Date(eventOrMeasurementStart.getTime() - maxBuffer),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2V0LXJ1bGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3ZhbGlkYXRpb24vbWFya2V0LXJ1bGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxjQUFjLENBQUM7QUE0QnRDLGdGQUFnRjtBQUNoRiwyQkFBMkI7QUFDM0IsZ0ZBQWdGO0FBRWhGOzs7Ozs7Ozs7Ozs7R0FZRztBQUNILE1BQU0sVUFBVSxvQkFBb0IsQ0FBQyxNQUEwQjtJQUM3RCxNQUFNLE1BQU0sR0FBYSxFQUFFLENBQUM7SUFDNUIsTUFBTSxRQUFRLEdBQWEsRUFBRSxDQUFDO0lBQzlCLE1BQU0sV0FBVyxHQUFhLEVBQUUsQ0FBQztJQUNqQyxNQUFNLE1BQU0sR0FBK0IsRUFBRSxDQUFDO0lBRTlDLHFDQUFxQztJQUNyQyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsc0JBQXNCLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxrQkFBa0IsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFDRCxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRSxDQUFDO1FBQ2hDLFFBQVEsQ0FBQyxJQUFJLENBQUMsOEJBQThCLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxRQUFRLENBQUMsQ0FBQztJQUM5RSxDQUFDO0lBRUQsNENBQTRDO0lBQzVDLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7SUFDdkIsSUFBSSxNQUFNLENBQUMsV0FBVyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzlCLE1BQU0sQ0FBQyxJQUFJLENBQUMsb0NBQW9DLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQsOENBQThDO0lBQzlDLE1BQU0sY0FBYyxHQUFHLElBQUksSUFBSSxDQUFDLEdB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Q0osQ0FBQztBQUVEOztHQUVHO0FBQ0gsTUFBTSxVQUFVLHlCQUF5QixDQUN2Qyx1QkFBNkIsRUFDN0IsVUFBbUM7SUFNbkMsTUFBTSxNQUFNLEdBQUcsVUFBVSxLQUFLLE9BQU87UUFDbkMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyw4QkFBOEIsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUk7UUFDeEQsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLDBCQUEwQjtJQUVsRCxNQUFNLFNBQVMsR0FBRyxVQUFVLEtBQUssT0FBTztRQUN0QyxDQUFDLENBQUMsTUFBTSxDQUFDLHNCQUFzQixHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSTtRQUNoRCxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMseUJBQXlCO0lBRWpELE1BQU0sU0FBUyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLGVBQWU7SUFFdEQsT0FBTztRQUNMLGdCQUFnQixFQUFFLElBQUksSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sRUFBRSxHQUFHLE1BQU0sQ0FBQztRQUN0RSxXQUFXLEVBQUUsSUFBSSxJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBTyxFQUFFLEdBQUcsU0FBUyxDQUFDO1FBQ3BFLGFBQWEsRUFBRSxJQUFJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLEVBQUUsR0FBRyxTQUFTLENBQUM7S0FDdkUsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIE1hcmtldCBWYWxpZGF0aW9uIFJ1bGVzICh2Ni4yKVxuICpcbiAqIEltcGxlbWVudHMgdGltaW5nIHZhbGlkYXRpb24gZm9yIG1hcmtldCBjcmVhdGlvbiBiYXNlZCBvbjpcbiAqIC0gUnVsZSBBOiBFdmVudC1CYXNlZCBNYXJrZXRzIChzaW5nbGUgcG9pbnQgaW4gdGltZSlcbiAqIC0gUnVsZSBCOiBNZWFzdXJlbWVudC1QZXJpb2QgTWFya2V0cyAob3V0Y29tZSBvdmVyIHRpbWUgcmFuZ2UpXG4gKi9cblxuaW1wb3J0IHsgVElNSU5HIH0gZnJvbSAnLi4vY29uZmlnLmpzJztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFRZUEVTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgaW50ZXJmYWNlIE1hcmtldFRpbWluZ1BhcmFtcyB7XG4gIHF1ZXN0aW9uOiBzdHJpbmc7XG4gIGNsb3NpbmdUaW1lOiBEYXRlO1xuICBtYXJrZXRUeXBlOiAnZXZlbnQnIHwgJ21lYXN1cmVtZW50JztcbiAgZXZlbnRUaW1lPzogRGF0ZTtcbiAgbWVhc3VyZW1lbnRTdGFydD86IERhdGU7XG4gIG1lYXN1cmVtZW50RW5kPzogRGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBNYXJrZXRWYWxpZGF0aW9uIHtcbiAgdmFsaWQ6IGJvb2xlYW47XG4gIHJ1bGVUeXBlOiAnQScgfCAnQic7XG4gIGVycm9yczogc3RyaW5nW107XG4gIHdhcm5pbmdzOiBzdHJpbmdbXTtcbiAgc3VnZ2VzdGlvbnM6IHN0cmluZ1tdO1xuICB0aW1pbmc/OiB7XG4gICAgYnVmZmVySG91cnM/OiBudW1iZXI7XG4gICAgcmVjb21tZW5kZWRDbG9zZT86IERhdGU7XG4gICAgbWVhc3VyZW1lbnREYXlzPzogbnVtYmVyO1xuICB9O1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gTUFJTiBWQUxJREFUSU9OIEZVTkNUSU9OXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIFZhbGlkYXRlIG1hcmtldCB0aW1pbmcgcGFyYW1ldGVycyBhZ2FpbnN0IHY2LjIgcnVsZXNcbiAqXG4gKiBSdWxlIEEgKEV2ZW50LUJhc2VkKTpcbiAqIC0gQmV0dGluZyBjbG9zZXMgQkVGT1JFIHRoZSBldmVudCBvY2N1cnNcbiAqIC0gTWluaW11bSAxMmggYnVmZmVyIGJldHdlZW4gY2xvc2UgYW5kIGV2ZW50XG4gKiAtIFJlY29tbWVuZGVkIDE4LTI0aCBidWZmZXIgZm9yIHNhZmV0eVxuICpcbiAqIFJ1bGUgQiAoTWVhc3VyZW1lbnQtUGVyaW9kKTpcbiAqIC0gQmV0dGluZyBtdXN0IGNsb3NlIEJFRk9SRSBtZWFzdXJlbWVudCBzdGFydHNcbiAqIC0gTWVhc3VyZW1lbnQgcGVyaW9kIHNob3VsZCBiZSB3ZWxsLWRlZmluZWRcbiAqIC0gUHJlZmVyIDItNyBkYXkgbWVhc3VyZW1lbnQgcGVyaW9kcyBmb3IgVVhcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlTWFya2V0VGltaW5nKHBhcmFtczogTWFya2V0VGltaW5nUGFyYW1zKTogTWFya2V0VmFsaWRhdGlvbiB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgY29uc3Qgd2FybmluZ3M6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IHN1Z2dlc3Rpb25zOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCB0aW1pbmc6IE1hcmtldFZhbGlkYXRpb25bJ3RpbWluZyddID0ge307XG5cbiAgLy8gQ29tbW9uIHZhbGlkYXRpb246IHF1ZXN0aW9uIGxlbmd0aFxuICBpZiAocGFyYW1zLnF1ZXN0aW9uLmxlbmd0aCA+IDIwMCkge1xuICAgIGVycm9ycy5wdXNoKGBRdWVzdGlvbiB0b28gbG9uZzogJHtwYXJhbXMucXVlc3Rpb24ubGVuZ3RofSBjaGFycyAobWF4IDIwMClgKTtcbiAgfVxuICBpZiAocGFyYW1zLnF1ZXN0aW9uLmxlbmd0aCA8IDEwKSB7XG4gICAgd2FybmluZ3MucHVzaChgUXVlc3Rpb24gbWF5IGJlIHRvbyBzaG9ydDogJHtwYXJhbXMucXVlc3Rpb24ubGVuZ3RofSBjaGFyc2ApO1xuICB9XG5cbiAgLy8gQ29tbW9uIHZhbGlkYXRpb246IGNsb3NpbmcgdGltZSBpbiBmdXR1cmVcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgaWYgKHBhcmFtcy5jbG9zaW5nVGltZSA8PSBub3cpIHtcbiAgICBlcnJvcnMucHVzaCgnQ2xvc2luZyB0aW1lIG11c3QgYmUgaW4gdGhlIGZ1dHVyZScpO1xuICB9XG5cbiAgLy8gQ29tbW9uIHZhbGlkYXRpb246IGNsb3NpbmcgdGltZSBub3QgdG9vIGZhclxuICBjb25zdCBtYXhDbG9zaW5nVGltZSA9IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgKyBUSU1JTkcuTUFYX01BUktFVF9EVVJBVElPTl9EQVlTICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gIGlmIChwYXJhbXMuY2xvc2luZ1RpbWUgPiBtYXhDbG9zaW5nVGltZSkge1xuICAgIGVycm9ycy5wdXNoKGBDbG9zaW5nIHRpbWUgdG9vIGZhciBpbiBmdXR1cmUgKG1heCAke1RJTUlORy5NQVhfTUFSS0VUX0RVUkFUSU9OX0RBWVN9IGRheXMpYCk7XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBSdWxlIEE6IEV2ZW50LUJhc2VkIE1hcmtldHNcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgaWYgKHBhcmFtcy5tYXJrZXRUeXBlID09PSAnZXZlbnQnKSB7XG4gICAgaWYgKCFwYXJhbXMuZXZlbnRUaW1lKSB7XG4gICAgICBlcnJvcnMucHVzaCgnRXZlbnQtYmFzZWQgbWFya2V0cyByZXF1aXJlIGV2ZW50X3RpbWUnKTtcbiAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgcnVsZVR5cGU6ICdBJywgZXJyb3JzLCB3YXJuaW5ncywgc3VnZ2VzdGlvbnMgfTtcbiAgICB9XG5cbiAgICAvLyBFdmVudCB0aW1lIG11c3QgYmUgYWZ0ZXIgY2xvc2luZyB0aW1lXG4gICAgaWYgKHBhcmFtcy5ldmVudFRpbWUgPD0gcGFyYW1zLmNsb3NpbmdUaW1lKSB7XG4gICAgICBlcnJvcnMucHVzaCgnRXZlbnQgdGltZSBtdXN0IGJlIGFmdGVyIGNsb3NpbmcgdGltZScpO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBidWZmZXJcbiAgICBjb25zdCBidWZmZXJNcyA9IHBhcmFtcy5ldmVudFRpbWUuZ2V0VGltZSgpIC0gcGFyYW1zLmNsb3NpbmdUaW1lLmdldFRpbWUoKTtcbiAgICBjb25zdCBidWZmZXJIb3VycyA9IGJ1ZmZlck1zIC8gKDEwMDAgKiA2MCAqIDYwKTtcbiAgICB0aW1pbmcuYnVmZmVySG91cnMgPSBNYXRoLnJvdW5kKGJ1ZmZlckhvdXJzICogMTApIC8gMTA7XG5cbiAgICAvLyBNaW5pbXVtIGJ1ZmZlciBjaGVjayAoMTIgaG91cnMpXG4gICAgaWYgKGJ1ZmZlckhvdXJzIDwgVElNSU5HLk1JTl9FVkVOVF9CVUZGRVJfSE9VUlMpIHtcbiAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICBgQnVmZmVyIHRvbyBzaG9ydDogJHt0aW1pbmcuYnVmZmVySG91cnN9aC4gYCArXG4gICAgICAgIGBNaW5pbXVtICR7VElNSU5HLk1JTl9FVkVOVF9CVUZGRVJfSE9VUlN9aCByZXF1aXJlZCBiZXR3ZWVuIGJldHRpbmcgY2xvc2UgYW5kIGV2ZW50LmBcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChidWZmZXJIb3VycyA8IDE4KSB7XG4gICAgICB3YXJuaW5ncy5wdXNoKFxuICAgICAgICBgQnVmZmVyIGlzICR7dGltaW5nLmJ1ZmZlckhvdXJzfWguIGAgK1xuICAgICAgICBgUmVjb21tZW5kICR7VElNSU5HLlJFQ09NTUVOREVEX0VWRU5UX0JVRkZFUl9IT1VSU31oIGZvciBzYWZldHkgbWFyZ2luLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gU3VnZ2VzdCBvcHRpbWFsIGNsb3NpbmcgdGltZVxuICAgIGNvbnN0IHJlY29tbWVuZGVkQ2xvc2UgPSBuZXcgRGF0ZShcbiAgICAgIHBhcmFtcy5ldmVudFRpbWUuZ2V0VGltZSgpIC0gVElNSU5HLlJFQ09NTUVOREVEX0VWRU5UX0JVRkZFUl9IT1VSUyAqIDYwICogNjAgKiAxMDAwXG4gICAgKTtcbiAgICB0aW1pbmcucmVjb21tZW5kZWRDbG9zZSA9IHJlY29tbWVuZGVkQ2xvc2U7XG5cbiAgICBpZiAocmVjb21tZW5kZWRDbG9zZSA+IG5vdyAmJiBwYXJhbXMuY2xvc2luZ1RpbWUgPiByZWNvbW1lbmRlZENsb3NlKSB7XG4gICAgICBzdWdnZXN0aW9ucy5wdXNoKFxuICAgICAgICBgQ29uc2lkZXIgY2xvc2luZyBiZXR0aW5nIGF0ICR7cmVjb21tZW5kZWRDbG9zZS50b0lTT1N0cmluZygpfSBgICtcbiAgICAgICAgYCgke1RJTUlORy5SRUNPTU1FTkRFRF9FVkVOVF9CVUZGRVJfSE9VUlN9aCBiZWZvcmUgZXZlbnQpYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgY29tbW9uIG1pc3Rha2VzXG4gICAgaWYgKHBhcmFtcy5xdWVzdGlvbi50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCd3aWxsJykgJiYgIXBhcmFtcy5xdWVzdGlvbi5pbmNsdWRlcygnPycpKSB7XG4gICAgICBzdWdnZXN0aW9ucy5wdXNoKCdDb25zaWRlciBlbmRpbmcgeW91ciBxdWVzdGlvbiB3aXRoIGEgcXVlc3Rpb24gbWFyayBmb3IgY2xhcml0eScpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB2YWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICAgIHJ1bGVUeXBlOiAnQScsXG4gICAgICBlcnJvcnMsXG4gICAgICB3YXJuaW5ncyxcbiAgICAgIHN1Z2dlc3Rpb25zLFxuICAgICAgdGltaW5nLFxuICAgIH07XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBSdWxlIEI6IE1lYXN1cmVtZW50LVBlcmlvZCBNYXJrZXRzXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIGlmIChwYXJhbXMubWFya2V0VHlwZSA9PT0gJ21lYXN1cmVtZW50Jykge1xuICAgIGlmICghcGFyYW1zLm1lYXN1cmVtZW50U3RhcnQpIHtcbiAgICAgIGVycm9ycy5wdXNoKCdNZWFzdXJlbWVudC1wZXJpb2QgbWFya2V0cyByZXF1aXJlIG1lYXN1cmVtZW50X3N0YXJ0Jyk7XG4gICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIHJ1bGVUeXBlOiAnQicsIGVycm9ycywgd2FybmluZ3MsIHN1Z2dlc3Rpb25zIH07XG4gICAgfVxuXG4gICAgLy8gQ1JJVElDQUw6IEJldHRpbmcgbXVzdCBjbG9zZSBCRUZPUkUgbWVhc3VyZW1lbnQgc3RhcnRzXG4gICAgaWYgKHBhcmFtcy5jbG9zaW5nVGltZSA+PSBwYXJhbXMubWVhc3VyZW1lbnRTdGFydCkge1xuICAgICAgY29uc3Qgb3ZlcmxhcE1zID0gcGFyYW1zLmNsb3NpbmdUaW1lLmdldFRpbWUoKSAtIHBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0LmdldFRpbWUoKTtcbiAgICAgIGNvbnN0IG92ZXJsYXBIb3VycyA9IG92ZXJsYXBNcyAvICgxMDAwICogNjAgKiA2MCk7XG4gICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgYElOVkFMSUQ6IEJldHRpbmcgY2xvc2VzICR7TWF0aC5yb3VuZChvdmVybGFwSG91cnMgKiAxMCkgLyAxMH1oIEFGVEVSIG1lYXN1cmVtZW50IHN0YXJ0cy4gYCArXG4gICAgICAgIGBUaGlzIGFsbG93cyBpbmZvcm1hdGlvbiBhZHZhbnRhZ2UhIGAgK1xuICAgICAgICBgQmV0dGluZyBtdXN0IGNsb3NlIEJFRk9SRSBtZWFzdXJlbWVudCBwZXJpb2QgYmVnaW5zLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIGJ1ZmZlciBiZWZvcmUgbWVhc3VyZW1lbnRcbiAgICBjb25zdCBidWZmZXJNcyA9IHBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0LmdldFRpbWUoKSAtIHBhcmFtcy5jbG9zaW5nVGltZS5nZXRUaW1lKCk7XG4gICAgY29uc3QgYnVmZmVySG91cnMgPSBidWZmZXJNcyAvICgxMDAwICogNjAgKiA2MCk7XG4gICAgdGltaW5nLmJ1ZmZlckhvdXJzID0gTWF0aC5yb3VuZChidWZmZXJIb3VycyAqIDEwKSAvIDEwO1xuXG4gICAgaWYgKGJ1ZmZlckhvdXJzIDwgMSAmJiBidWZmZXJIb3VycyA+IDApIHtcbiAgICAgIHdhcm5pbmdzLnB1c2goXG4gICAgICAgIGBWZXJ5IHRpZ2h0IGJ1ZmZlciAoJHt0aW1pbmcuYnVmZmVySG91cnN9aCkgYmV0d2VlbiBiZXR0aW5nIGNsb3NlIGFuZCBtZWFzdXJlbWVudCBzdGFydC4gYCArXG4gICAgICAgIGBDb25zaWRlciBhZGRpbmcgbW9yZSB0aW1lIGZvciBsYXRlIGJldHRvcnMuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBNZWFzdXJlbWVudCBlbmQgdmFsaWRhdGlvblxuICAgIGlmIChwYXJhbXMubWVhc3VyZW1lbnRFbmQpIHtcbiAgICAgIGlmIChwYXJhbXMubWVhc3VyZW1lbnRFbmQgPD0gcGFyYW1zLm1lYXN1cmVtZW50U3RhcnQpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ01lYXN1cmVtZW50IGVuZCBtdXN0IGJlIGFmdGVyIG1lYXN1cmVtZW50IHN0YXJ0Jyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBlcmlvZE1zID0gcGFyYW1zLm1lYXN1cmVtZW50RW5kLmdldFRpbWUoKSAtIHBhcmFtcy5tZWFzdXJlbWVudFN0YXJ0LmdldFRpbWUoKTtcbiAgICAgIGNvbnN0IHBlcmlvZERheXMgPSBwZXJpb2RNcyAvICgxMDAwICogNjAgKiA2MCAqIDI0KTtcbiAgICAgIHRpbWluZy5tZWFzdXJlbWVudERheXMgPSBNYXRoLnJvdW5kKHBlcmlvZERheXMgKiAxMCkgLyAxMDtcblxuICAgICAgLy8gVVggZ3VpZGFuY2UgZm9yIG1lYXN1cmVtZW50IHBlcmlvZHNcbiAgICAgIGlmIChwZXJpb2REYXlzID4gMzApIHtcbiAgICAgICAgd2FybmluZ3MucHVzaChcbiAgICAgICAgICBgVmVyeSBsb25nIG1lYXN1cmVtZW50IHBlcmlvZDogJHt0aW1pbmcubWVhc3VyZW1lbnREYXlzfSBkYXlzLiBgICtcbiAgICAgICAgICBgQ29uc2lkZXIgc2hvcnRlciBwZXJpb2RzICgyLTcgZGF5cykgZm9yIGJldHRlciB1c2VyIGV4cGVyaWVuY2UuYFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChwZXJpb2REYXlzID4gNykge1xuICAgICAgICB3YXJuaW5ncy5wdXNoKFxuICAgICAgICAgIGBMb25nIG1lYXN1cmVtZW50IHBlcmlvZDogJHt0aW1pbmcubWVhc3VyZW1lbnREYXlzfSBkYXlzLiBgICtcbiAgICAgICAgICBgUHJlZmVyIDItNyBkYXlzIGZvciBvcHRpbWFsIGVuZ2FnZW1lbnQuYFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChwZXJpb2REYXlzIDwgMSkge1xuICAgICAgICBzdWdnZXN0aW9ucy5wdXNoKFxuICAgICAgICAgIGBTaG9ydCBtZWFzdXJlbWVudCBwZXJpb2QgKCR7TWF0aC5yb3VuZChwZXJpb2REYXlzICogMjQpfWgpLiBgICtcbiAgICAgICAgICBgRW5zdXJlIHJlc29sdXRpb24gY2FuIGJlIGRldGVybWluZWQgd2l0aGluIHRoaXMgdGltZWZyYW1lLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBTdWdnZXN0IG9wdGltYWwgY2xvc2luZyB0aW1lXG4gICAgY29uc3QgcmVjb21tZW5kZWRDbG9zZSA9IG5ldyBEYXRlKFxuICAgICAgcGFyYW1zLm1lYXN1cmVtZW50U3RhcnQuZ2V0VGltZSgpIC0gMiAqIDYwICogNjAgKiAxMDAwIC8vIDIgaG91cnMgYmVmb3JlIG1lYXN1cmVtZW50XG4gICAgKTtcbiAgICB0aW1pbmcucmVjb21tZW5kZWRDbG9zZSA9IHJlY29tbWVuZGVkQ2xvc2U7XG5cbiAgICBpZiAocmVjb21tZW5kZWRDbG9zZSA+IG5vdyAmJiBwYXJhbXMuY2xvc2luZ1RpbWUgPiByZWNvbW1lbmRlZENsb3NlKSB7XG4gICAgICBzdWdnZXN0aW9ucy5wdXNoKFxuICAgICAgICBgQ29uc2lkZXIgY2xvc2luZyBiZXR0aW5nIGF0ICR7cmVjb21tZW5kZWRDbG9zZS50b0lTT1N0cmluZygpfSBgICtcbiAgICAgICAgYCgyaCBiZWZvcmUgbWVhc3VyZW1lbnQgcGVyaW9kIHN0YXJ0cylgXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB2YWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICAgIHJ1bGVUeXBlOiAnQicsXG4gICAgICBlcnJvcnMsXG4gICAgICB3YXJuaW5ncyxcbiAgICAgIHN1Z2dlc3Rpb25zLFxuICAgICAgdGltaW5nLFxuICAgIH07XG4gIH1cblxuICAvLyBVbmtub3duIG1hcmtldCB0eXBlXG4gIGVycm9ycy5wdXNoKGBVbmtub3duIG1hcmtldCB0eXBlOiAke3BhcmFtcy5tYXJrZXRUeXBlfWApO1xuICByZXR1cm4geyB2YWxpZDogZmFsc2UsIHJ1bGVUeXBlOiAnQScsIGVycm9ycywgd2FybmluZ3MsIHN1Z2dlc3Rpb25zIH07XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBIRUxQRVIgRlVOQ1RJT05TXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIEdlbmVyYXRlIHRpbWluZyBzdWdnZXN0aW9ucyBiYXNlZCBvbiBtYXJrZXQgcGFyYW1ldGVyc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVUaW1pbmdTdWdnZXN0aW9ucyhwYXJhbXM6IE1hcmtldFRpbWluZ1BhcmFtcyk6IHN0cmluZ1tdIHtcbiAgY29uc3Qgc3VnZ2VzdGlvbnM6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG5cbiAgaWYgKHBhcmFtcy5tYXJrZXRUeXBlID09PSAnZXZlbnQnICYmIHBhcmFtcy5ldmVudFRpbWUpIHtcbiAgICAvLyBTdWdnZXN0IGNsb3NpbmcgdGltZSBmb3IgZXZlbnQtYmFzZWQgbWFya2V0c1xuICAgIGNvbnN0IG9wdGltYWxDbG9zZSA9IG5ldyBEYXRlKFxuICAgICAgcGFyYW1zLmV2ZW50VGltZS5nZXRUaW1lKCkgLSBUSU1JTkcuUkVDT01NRU5ERURfRVZFTlRfQlVGRkVSX0hPVVJTICogNjAgKiA2MCAqIDEwMDBcbiAgICApO1xuXG4gICAgaWYgKG9wdGltYWxDbG9zZSA+IG5vdykge1xuICAgICAgc3VnZ2VzdGlvbnMucHVzaChgT3B0aW1hbCBiZXR0aW5nIGNsb3NlOiAke29wdGltYWxDbG9zZS50b0lTT1N0cmluZygpfWApO1xuICAgIH1cblxuICAgIC8vIFN1Z2dlc3QgcXVlc3Rpb24gZm9ybWF0XG4gICAgaWYgKCFwYXJhbXMucXVlc3Rpb24uaW5jbHVkZXMoJz8nKSkge1xuICAgICAgc3VnZ2VzdGlvbnMucHVzaCgnRW5kIHlvdXIgcXVlc3Rpb24gd2l0aCBcIj9cIiBmb3IgY2xhcml0eScpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChwYXJhbXMubWFya2V0VHlwZSA9PT0gJ21lYXN1cmVtZW50JyAmJiBwYXJhbXMubWVhc3VyZW1lbnRTdGFydCkge1xuICAgIC8vIFN1Z2dlc3QgY2xvc2luZyB0aW1lIGZvciBtZWFzdXJlbWVudCBtYXJrZXRzXG4gICAgY29uc3Qgb3B0aW1hbENsb3NlID0gbmV3IERhdGUoXG4gICAgICBwYXJhbXMubWVhc3VyZW1lbnRTdGFydC5nZXRUaW1lKCkgLSAyICogNjAgKiA2MCAqIDEwMDBcbiAgICApO1xuXG4gICAgaWYgKG9wdGltYWxDbG9zZSA+IG5vdykge1xuICAgICAgc3VnZ2VzdGlvbnMucHVzaChgT3B0aW1hbCBiZXR0aW5nIGNsb3NlOiAke29wdGltYWxDbG9zZS50b0lTT1N0cmluZygpfWApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBzdWdnZXN0aW9ucztcbn1cblxuLyoqXG4gKiBDaGVjayBpZiBhIG1hcmtldCBxdWVzdGlvbiBmb2xsb3dzIGJlc3QgcHJhY3RpY2VzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVF1ZXN0aW9uRm9ybWF0KHF1ZXN0aW9uOiBzdHJpbmcpOiB7XG4gIHZhbGlkOiBib29sZWFuO1xuICBpc3N1ZXM6IHN0cmluZ1tdO1xufSB7XG4gIGNvbnN0IGlzc3Vlczogc3RyaW5nW10gPSBbXTtcblxuICAvLyBMZW5ndGggY2hlY2tzXG4gIGlmIChxdWVzdGlvbi5sZW5ndGggPCAxMCkge1xuICAgIGlzc3Vlcy5wdXNoKCdRdWVzdGlvbiB0b28gc2hvcnQgKG1pbiAxMCBjaGFycyknKTtcbiAgfVxuICBpZiAocXVlc3Rpb24ubGVuZ3RoID4gMjAwKSB7XG4gICAgaXNzdWVzLnB1c2goJ1F1ZXN0aW9uIHRvbyBsb25nIChtYXggMjAwIGNoYXJzKScpO1xuICB9XG5cbiAgLy8gRm9ybWF0IGNoZWNrc1xuICBpZiAoIXF1ZXN0aW9uLnRyaW0oKSkge1xuICAgIGlzc3Vlcy5wdXNoKCdRdWVzdGlvbiBjYW5ub3QgYmUgZW1wdHknKTtcbiAgfVxuXG4gIC8vIEJlc3QgcHJhY3RpY2UgY2hlY2tzXG4gIGlmICghcXVlc3Rpb24uaW5jbHVkZXMoJz8nKSAmJiAhcXVlc3Rpb24udG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKCd3aWxsICcpKSB7XG4gICAgaXNzdWVzLnB1c2goJ0NvbnNpZGVyIHBocmFzaW5nIGFzIGEgeWVzL25vIHF1ZXN0aW9uJyk7XG4gIH1cblxuICAvLyBDaGVjayBmb3IgYW1iaWd1b3VzIGxhbmd1YWdlXG4gIGNvbnN0IGFtYmlndW91c1Rlcm1zID0gWydtYXliZScsICdwcm9iYWJseScsICdtaWdodCcsICdjb3VsZCBwb3NzaWJseSddO1xuICBmb3IgKGNvbnN0IHRlcm0gb2YgYW1iaWd1b3VzVGVybXMpIHtcbiAgICBpZiAocXVlc3Rpb24udG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0ZXJtKSkge1xuICAgICAgaXNzdWVzLnB1c2goYEF2b2lkIGFtYmlndW91cyB0ZXJtOiBcIiR7dGVybX1cImApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgdmFsaWQ6IGlzc3Vlcy5sZW5ndGggPT09IDAsXG4gICAgaXNzdWVzLFxuICB9O1xufVxuXG4vKipcbiAqIENhbGN1bGF0ZSByZWNvbW1lbmRlZCB0aW1lcyBmb3IgYSBtYXJrZXRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZVJlY29tbWVuZGVkVGltZXMoXG4gIGV2ZW50T3JNZWFzdXJlbWVudFN0YXJ0OiBEYXRlLFxuICBtYXJrZXRUeXBlOiAnZXZlbnQnIHwgJ21lYXN1cmVtZW50J1xuKToge1xuICByZWNvbW1lbmRlZENsb3NlOiBEYXRlO1xuICBsYXRlc3RDbG9zZTogRGF0ZTtcbiAgZWFybGllc3RDbG9zZTogRGF0ZTtcbn0ge1xuICBjb25zdCBidWZmZXIgPSBtYXJrZXRUeXBlID09PSAnZXZlbnQnXG4gICAgPyBUSU1JTkcuUkVDT01NRU5ERURfRVZFTlRfQlVGRkVSX0hPVVJTICogNjAgKiA2MCAqIDEwMDBcbiAgICA6IDIgKiA2MCAqIDYwICogMTAwMDsgLy8gMiBob3VycyBmb3IgbWVhc3VyZW1lbnRcblxuICBjb25zdCBtaW5CdWZmZXIgPSBtYXJrZXRUeXBlID09PSAnZXZlbnQnXG4gICAgPyBUSU1JTkcuTUlOX0VWRU5UX0JVRkZFUl9IT1VSUyAqIDYwICogNjAgKiAxMDAwXG4gICAgOiAxICogNjAgKiA2MCAqIDEwMDA7IC8vIDEgaG91ciBmb3IgbWVhc3VyZW1lbnRcblxuICBjb25zdCBtYXhCdWZmZXIgPSA0OCAqIDYwICogNjAgKiAxMDAwOyAvLyA0OCBob3VycyBtYXhcblxuICByZXR1cm4ge1xuICAgIHJlY29tbWVuZGVkQ2xvc2U6IG5ldyBEYXRlKGV2ZW50T3JNZWFzdXJlbWVudFN0YXJ0LmdldFRpbWUoKSAtIGJ1ZmZlciksXG4gICAgbGF0ZXN0Q2xvc2U6IG5ldyBEYXRlKGV2ZW50T3JNZWFzdXJlbWVudFN0YXJ0LmdldFRpbWUoKSAtIG1pbkJ1ZmZlciksXG4gICAgZWFybGllc3RDbG9zZTogbmV3IERhdGUoZXZlbnRPck1lYXN1cmVtZW50U3RhcnQuZ2V0VGltZSgpIC0gbWF4QnVmZmVyKSxcbiAgfTtcbn1cbiJdfQ==